#!/usr/bin/env python3
# ai_gui_app.py
# PyQt6 GUI —á–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ–º
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ADAPTIVE INTELLIGENT WEB SEARCH SYSTEM
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# CORE PRINCIPLE: The assistant automatically decides when to use the internet,
# but MUST obey forced search when the user activates it.
#
# 1. INTENT ANALYSIS
# ------------------
# Before answering, the system analyzes the user request and classifies it:
#
# A) INTERNET REQUIRED (automatic search):
#    ‚Ä¢ weather, news, current events
#    ‚Ä¢ real-time data ("now", "today", "current", "latest")
#    ‚Ä¢ location-based info
#    ‚Ä¢ software updates, prices, releases
#    ‚Ä¢ factual questions needing high accuracy
#    ‚Ä¢ complex research questions
#
# B) INTERNET NOT REQUIRED (immediate response):
#    ‚Ä¢ math calculations
#    ‚Ä¢ rewriting text
#    ‚Ä¢ translations
#    ‚Ä¢ coding logic
#    ‚Ä¢ creative writing
#    ‚Ä¢ general evergreen knowledge
#
# 2. AUTOMATIC SMART SEARCH
# --------------------------
# If the request belongs to INTERNET REQUIRED:
#    ‚Ä¢ Starts web search automatically
#    ‚Ä¢ User does NOT need to enable search manually
#
# If the request belongs to INTERNET NOT REQUIRED:
#    ‚Ä¢ Does NOT use internet search
#    ‚Ä¢ Responds immediately using internal knowledge
#
# 3. FORCED SEARCH MODE (PRIORITY RULE)
# --------------------------------------
# If the user presses the forced search button:
#    ‚Ä¢ ALWAYS performs internet search
#    ‚Ä¢ Does NOT skip search even if the question looks simple
#    ‚Ä¢ Treats forced search as highest priority override
#
# 4. TWO-PHASE RESPONSE FLOW
# ---------------------------
# When internet search is used:
#
# STEP 1 ‚Äî QUICK RESPONSE:
#    ‚Ä¢ Gives a short preliminary answer immediately
#    ‚Ä¢ Marks it as a fast provisional answer if needed
#
# STEP 2 ‚Äî VERIFIED RESPONSE:
#    ‚Ä¢ After retrieving web data, sends an updated refined answer
#    ‚Ä¢ Improves accuracy, adds details, corrects assumptions if necessary
#
# 5. PERFORMANCE & UX RULES
# --------------------------
# ‚Ä¢ Does not block UI while searching
# ‚Ä¢ Responses feel fast and fluid
# ‚Ä¢ Avoids repeating the entire message; updates intelligently
# ‚Ä¢ If search results do not change the answer, confirms briefly
#
# 6. EDGE CASES
# -------------
# ‚Ä¢ If intent is unclear ‚Üí assumes NO internet unless strong signals exist
# ‚Ä¢ If the request mixes local logic + real-time info ‚Üí combines both
# ‚Ä¢ Never hallucinates real-time data without search
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import os
import sys
import sqlite3
import subprocess
import threading
import time
import platform
from datetime import datetime
from PyQt6 import QtWidgets, QtGui, QtCore
import requests
import json
from PyQt6.QtOpenGLWidgets import QOpenGLWidget
from OpenGL.GL import *
# –ò–º–ø–æ—Ä—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–∞—Ç–æ–≤
from chat_manager import ChatManager
from context_memory_manager import ContextMemoryManager

# –ò–º–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤
try:
    from forbidden_english_words import FORBIDDEN_WORDS_DICT, FORBIDDEN_WORDS_SET, TOP_FORBIDDEN_FOR_PROMPT
    print("[IMPORT] ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤")
except ImportError:
    print("[IMPORT] ‚ö†Ô∏è –§–∞–π–ª forbidden_english_words.py –Ω–µ –Ω–∞–π–¥–µ–Ω - —Ñ–∏–ª—å—Ç—Ä –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–≤—ã–º —Å–ª–æ–≤–∞—Ä—ë–º")
    FORBIDDEN_WORDS_DICT = {}
    FORBIDDEN_WORDS_SET = set()
    TOP_FORBIDDEN_FOR_PROMPT = []

# -------------------------
# Platform detection (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Windows)
# -------------------------
IS_WINDOWS = sys.platform == "win32"

# -------------------------
# Backends configuration
# -------------------------
USE_OLLAMA = True  # –¢–æ–ª—å–∫–æ Ollama, –±–µ–∑ OpenAI
OLLAMA_HOST = os.getenv("OLLAMA_HOST", "http://127.0.0.1:11434")
OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "llama3")

ASSISTANT_NAME = "LLaMA 3"
APP_TITLE = "AI Assistant"


# Google / DuckDuckGo helper config
DB_FILE = "chat_memory.db"
MAX_HISTORY_LOAD = 50

# Threshold to decide whether text is "short"
SHORT_TEXT_THRESHOLD = 80  # —Å–∏–º–≤–æ–ª–æ–≤

# AI Mode settings
AI_MODE_FAST = "–±—ã—Å—Ç—Ä—ã–π"
AI_MODE_THINKING = "–¥—É–º–∞—é—â–∏–π"
AI_MODE_PRO = "–ø—Ä–æ"

# -------------------------
# Adaptive Intelligent Web Search System
# -------------------------

# Intent analysis keywords for automatic search
INTERNET_REQUIRED_KEYWORDS = {
    # Time-sensitive queries
    "time": ["—Å–µ–π—á–∞—Å", "now", "today", "—Å–µ–≥–æ–¥–Ω—è", "—Ç–µ–∫—É—â–∏–π", "current", "latest", "–ø–æ—Å–ª–µ–¥–Ω–∏–π", "–∞–∫—Ç—É–∞–ª—å–Ω—ã–π"],
    # Weather queries
    "weather": ["–ø–æ–≥–æ–¥–∞", "weather", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "temperature", "forecast", "–ø—Ä–æ–≥–Ω–æ–∑"],
    # News and events
    "news": ["–Ω–æ–≤–æ—Å—Ç–∏", "news", "—Å–æ–±—ã—Ç–∏—è", "events", "—á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å", "what happened"],
    # Location-based
    "location": ["–≥–¥–µ", "where", "–∞–¥—Ä–µ—Å", "address", "location", "–º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è"],
    # Real-time data
    "realtime": ["–∫—É—Ä—Å", "rate", "—Ü–µ–Ω–∞", "price", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "cost", "–∫–æ—Ç–∏—Ä–æ–≤–∫–∏", "quotes"],
    # Software/releases
    "software": ["–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ", "update", "—Ä–µ–ª–∏–∑", "release", "–≤–µ—Ä—Å–∏—è", "version", "–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è"],
    # Recipes and cooking
    "recipes": ["—Ä–µ—Ü–µ–ø—Ç", "recipe", "–∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å", "how to cook", "–∫–∞–∫ –≥–æ—Ç–æ–≤–∏—Ç—å", "–≥–æ—Ç–æ–≤–∏—Ç—å", "–ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å", "–±–ª—é–¥–æ", "dish"],
    # Search explicitly
    "search": ["–Ω–∞–π–¥–∏", "search", "–ø–æ–∏—Å–∫", "–Ω–∞–π—Ç–∏", "–ø–æ–≥—É–≥–ª–∏", "google", "–ø–æ—Å–º–æ—Ç—Ä–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ", "check online"]
}

# Keywords that indicate NO internet search needed
NO_INTERNET_KEYWORDS = {
    "math": ["–≤—ã—á–∏—Å–ª–∏", "calculate", "–ø–æ—Å—á–∏—Ç–∞–π", "—Å–ª–æ–∂–∏", "—É–º–Ω–æ–∂—å", "—Ä–∞–∑–¥–µ–ª–∏"],
    "creative": ["–Ω–∞–ø–∏—à–∏", "write", "—Å–æ–∑–¥–∞–π", "create", "–ø—Ä–∏–¥—É–º–∞–π", "—Å–æ—á–∏–Ω–∏", "compose"],
    "translation": ["–ø–µ—Ä–µ–≤–µ–¥–∏", "translate", "–ø–µ—Ä–µ–≤–æ–¥", "translation"],
    "code": ["–∫–æ–¥", "code", "–ø—Ä–æ–≥—Ä–∞–º–º–∞", "program", "—Å–∫—Ä–∏–ø—Ç", "script", "—Ñ—É–Ω–∫—Ü–∏—è", "function"],
    "rewrite": ["–ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π", "rephrase", "–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π", "–ø–µ—Ä–µ–ø–∏—à–∏", "rewrite"]
}

def analyze_intent_for_search(user_message: str, forced_search: bool = False, chat_history: list = None) -> dict:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ—à–∞–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å:
    {
        "requires_search": bool,
        "confidence": float (0.0-1.0),
        "reason": str,
        "forced": bool
    }
    """
    
    # –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
    if forced_search:
        return {
            "requires_search": True,
            "confidence": 1.0,
            "reason": "forced_search_override",
            "forced": True
        }
    
    # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3-5 —Å–æ–æ–±—â–µ–Ω–∏–π
    context_keywords = []
    if chat_history and len(chat_history) > 0:
        for role, content, _ in chat_history[-5:]:
            if role == "user":
                context_keywords.extend(content.lower().split())
    
    message_lower = user_message.lower().strip()
    
    # –°—á—ë—Ç—á–∏–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    internet_score = 0
    no_internet_score = 0
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑–∞–ø—Ä–æ—Å–æ–≤
    for category, keywords in INTERNET_REQUIRED_KEYWORDS.items():
        for keyword in keywords:
            if keyword in message_lower:
                internet_score += 1
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            elif any(keyword in word for word in context_keywords):
                internet_score += 0.5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–æ—Ç–∏–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
    for category, keywords in NO_INTERNET_KEYWORDS.items():
        for keyword in keywords:
            if keyword in message_lower:
                no_internet_score += 1
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    # –í–æ–ø—Ä–æ—Å—ã "—á—Ç–æ —ç—Ç–æ", "–∫—Ç–æ —Ç–∞–∫–æ–π" - —Ç—Ä–µ–±—É—é—Ç –ø–æ–∏—Å–∫–∞
    if any(pattern in message_lower for pattern in ["—á—Ç–æ —Ç–∞–∫–æ–µ", "–∫—Ç–æ —Ç–∞–∫–æ–π", "–∫—Ç–æ —Ç–∞–∫–∞—è", "what is", "who is"]):
        internet_score += 2
    
    # –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è - –Ω–µ —Ç—Ä–µ–±—É—é—Ç –ø–æ–∏—Å–∫–∞
    if any(char in message_lower for char in ["=", "+", "-", "*", "/", "^"]):
        no_internet_score += 2
    
    # –†–µ—à–µ–Ω–∏–µ
    total_score = internet_score - no_internet_score
    
    if total_score > 0:
        confidence = min(1.0, total_score / 5.0)
        return {
            "requires_search": True,
            "confidence": confidence,
            "reason": "intent_analysis_positive",
            "forced": False
        }
    else:
        return {
            "requires_search": False,
            "confidence": 0.0,
            "reason": "intent_analysis_negative",
            "forced": False
        }

# -------------------------
# Icon creation
# -------------------------
def create_app_icon():
    """–°–æ–∑–¥–∞—ë—Ç –∏–∫–æ–Ω–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    from PyQt6.QtGui import QPixmap, QPainter, QColor, QFont, QPen
    from PyQt6.QtCore import Qt, QRect

    size = 256
    pixmap = QPixmap(size, size)
    pixmap.fill(Qt.GlobalColor.transparent)

    painter = QPainter(pixmap)
    painter.setRenderHint(QPainter.RenderHint.Antialiasing)

    gradient = QtGui.QRadialGradient(size/2, size/2, size/2)
    gradient.setColorAt(0, QColor("#667eea"))
    gradient.setColorAt(1, QColor("#764ba2"))

    painter.setBrush(gradient)
    painter.setPen(Qt.PenStyle.NoPen)
    painter.drawEllipse(10, 10, size-20, size-20)

    painter.setPen(QPen(QColor("white"), 3))
    font = QFont("Inter", 80, QFont.Weight.Bold)
    painter.setFont(font)
    painter.drawText(QRect(0, 0, size, size), Qt.AlignmentFlag.AlignCenter, "ü§ñ")

    painter.end()
    return pixmap

def create_menu_icon(theme="light"):
    """–°–æ–∑–¥–∞—ë—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω—É—é –∏–∫–æ–Ω–∫—É –º–µ–Ω—é (—Ç—Ä–∏ —Ä–æ–≤–Ω—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏)"""
    from PyQt6.QtGui import QPixmap, QPainter, QColor, QPen
    from PyQt6.QtCore import Qt, QRectF
    
    # –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ = —Ä–∞–∑–º–µ—Ä—É –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
    size = 50
    pixmap = QPixmap(size, size)
    pixmap.fill(Qt.GlobalColor.transparent)
    
    painter = QPainter(pixmap)
    painter.setRenderHint(QPainter.RenderHint.Antialiasing)
    
    # –¶–≤–µ—Ç –ª–∏–Ω–∏–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º—ã
    line_color = QColor("#2d3748") if theme == "light" else QColor("#e6e6e6")
    painter.setPen(Qt.PenStyle.NoPen)
    painter.setBrush(line_color)
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä—ë—Ö –ª–∏–Ω–∏–π
    line_width = 20      # –®–∏—Ä–∏–Ω–∞ –∫–∞–∂–¥–æ–π –ª–∏–Ω–∏–∏
    line_height = 2.5    # –¢–æ–ª—â–∏–Ω–∞ –∫–∞–∂–¥–æ–π –ª–∏–Ω–∏–∏
    spacing = 5          # –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏
    
    # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö —Ç—Ä—ë—Ö –ª–∏–Ω–∏–π
    total_height = 3 * line_height + 2 * spacing
    
    # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    start_x = (size - line_width) / 2
    start_y = (size - total_height) / 2
    
    # –†–∏—Å—É–µ–º —Ç—Ä–∏ —Ä–æ–≤–Ω—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏
    radius = line_height / 2
    
    # –í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–∏—è
    painter.drawRoundedRect(QRectF(start_x, start_y, line_width, line_height), radius, radius)
    
    # –°—Ä–µ–¥–Ω—è—è –ª–∏–Ω–∏—è
    painter.drawRoundedRect(QRectF(start_x, start_y + line_height + spacing, line_width, line_height), radius, radius)
    
    # –ù–∏–∂–Ω—è—è –ª–∏–Ω–∏—è
    painter.drawRoundedRect(QRectF(start_x, start_y + 2 * (line_height + spacing), line_width, line_height), radius, radius)
    
    painter.end()
    return pixmap

# -------------------------
# Language settings
# -------------------------
CURRENT_LANGUAGE = "russian"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –†–ï–ñ–ò–ú–ê–ú–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

MODE_STRATEGY_RULES = """
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚öôÔ∏è –†–ï–ñ–ò–ú–´ –†–ê–ë–û–¢–´ –ê–°–°–ò–°–¢–ï–ù–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –†–µ–∂–∏–º –º–µ–Ω—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –º—ã—à–ª–µ–Ω–∏—è, –∞ –ù–ï –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞.
–û—Ç–≤–µ—Ç –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö° –†–ï–ñ–ò–ú "–ë–´–°–¢–†–´–ô"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ò–û–†–ò–¢–ï–¢: –°–∫–æ—Ä–æ—Å—Ç—å –∏ –ª—ë–≥–∫–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞

–°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –û—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã
‚Ä¢ –ö–æ–¥ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ –†–ê–ë–û–ß–ò–ô
‚Ä¢ –ú–∏–Ω–∏–º—É–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π
‚Ä¢ –ù–µ —Ä–∞—Å–ø–∏—Å—ã–≤–∞–π —Ç–µ–æ—Ä–∏—é, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –º–µ–Ω—å—à–µ –∞–Ω–∞–ª–∏–∑–∞
‚Ä¢ 1-2 –∞–±–∑–∞—Ü–∞ –º–∞–∫—Å–∏–º—É–º
‚Ä¢ –ü—Ä—è–º–æ –∫ –¥–µ–ª—É –±–µ–∑ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π

–ü–†–ò–ú–ï–†–´:
–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤ Python?"
–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç: "my_list = [1, 2, 3] –∏–ª–∏ my_list = list()"

–í–æ–ø—Ä–æ—Å: "–ù–∞–ø–∏—à–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å–ª–æ–∂–µ–Ω–∏—è"
–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç: "def add(a, b): return a + b"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üß† –†–ï–ñ–ò–ú "–î–£–ú–ê–Æ–©–ò–ô"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ò–û–†–ò–¢–ï–¢: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –≥–ª—É–±–∏–Ω–æ–π

–°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –ò–ò –¥–æ–ª–∂–µ–Ω –±–æ–ª—å—à–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ
‚Ä¢ –ö–æ–¥ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π, —á–∏—Ç–∞–µ–º—ã–π, —Å –ª–æ–≥–∏–∫–æ–π
‚Ä¢ –ú–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –∏ –ø—Ä–∏—á–∏–Ω—ã –≤—ã–±–æ—Ä–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤, —á–µ–º –≤ –±—ã—Å—Ç—Ä–æ–º —Ä–µ–∂–∏–º–µ
‚Ä¢ 3-5 –∞–±–∑–∞—Ü–µ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ "–ø–æ—á–µ–º—É" –∏ "–∫–∞–∫"

–ü–†–ò–ú–ï–†–´:
–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤ Python?"
–î—É–º–∞—é—â–∏–π –æ—Ç–≤–µ—Ç: "–í Python –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫:
1. –õ–∏—Ç–µ—Ä–∞–ª: my_list = [1, 2, 3]
2. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: my_list = list()
3. List comprehension: my_list = [x for x in range(10)]
–ü–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± —Å–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π –∏ —á–∏—Ç–∞–µ–º—ã–π."

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üöÄ –†–ï–ñ–ò–ú "–ü–†–û"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ò–û–†–ò–¢–ï–¢: –¢–æ—á–Ω–æ—Å—Ç—å, –≥–ª—É–±–∏–Ω–∞, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

–°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–π
‚Ä¢ –ò–ò –û–ë–Ø–ó–ê–ù –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –≥–ª—É–±–æ–∫–æ –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã
‚Ä¢ –ö–æ–¥ –ø–æ–ª–Ω—ã–π, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π, –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π
‚Ä¢ –ú–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ edge cases –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
‚Ä¢ Best practices –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ü–†–ò–ú–ï–†–´:
–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤ Python?"
–ü—Ä–æ –æ—Ç–≤–µ—Ç: "Python –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–ø–æ—Å–æ–±–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤, –∫–∞–∂–¥—ã–π —Å–æ —Å–≤–æ–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏:

1. **–õ–∏—Ç–µ—Ä–∞–ª—å–Ω–∞—è –Ω–æ—Ç–∞—Ü–∏—è** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
   my_list = [1, 2, 3]
   - –°–∞–º—ã–π —á–∏—Ç–∞–µ–º—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 95% —Å–ª—É—á–∞–µ–≤

2. **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä list()**:
   my_list = list(iterable)
   - –î–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
   - –ü—Ä–∏–º–µ—Ä: list('abc') ‚Üí ['a', 'b', 'c']

3. **List comprehension** (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π):
   my_list = [x**2 for x in range(10) if x % 2 == 0]
   - –ë—ã—Å—Ç—Ä–µ–µ —Ü–∏–∫–ª–æ–≤
   - –ë–æ–ª–µ–µ Pythonic –∫–æ–¥
   
4. **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** (–¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö):
   my_gen = (x for x in range(1000000))
   - –õ–µ–Ω–∏–≤–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
   - –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏

**Best practices:**
- –ò—Å–ø–æ–ª—å–∑—É–π list comprehension –≤–º–µ—Å—Ç–æ map/filter
- –ò–∑–±–µ–≥–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
- –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ generators –∏–ª–∏ numpy arrays"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîç –£–ú–ù–´–ô –ü–û–ò–°–ö –í –ò–ù–¢–ï–†–ù–ï–¢–ï
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚Ä¢ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –í –õ–Æ–ë–û–ú —Ä–µ–∂–∏–º–µ
‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –ò–ò —Å–∞–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–∏—Å–∫
‚Ä¢ –†–µ–∂–∏–º –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ì–õ–£–ë–ò–ù–£ –û–¢–í–ï–¢–ê, –∞ –Ω–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –ø–æ–∏—Å–∫—É

–ü–†–ò–ú–ï–†–´:
–í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ?"
- –ë—ã—Å—Ç—Ä—ã–π: "–ü–æ–∏—Å–∫ ‚Üí –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: +5¬∞C, –æ–±–ª–∞—á–Ω–æ"
- –î—É–º–∞—é—â–∏–π: "–ü–æ–∏—Å–∫ ‚Üí –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ +5¬∞C, –æ–±–ª–∞—á–Ω–æ—Å—Ç—å 80%, –≤–µ—Ç–µ—Ä 3 –º/—Å. –†–µ–∫–æ–º–µ–Ω–¥—É—é —Ç—ë–ø–ª—É—é –æ–¥–µ–∂–¥—É."
- –ü—Ä–æ: "–ü–æ–∏—Å–∫ ‚Üí –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é —Å –∞–Ω–∞–ª–∏–∑–æ–º –¥–∞–≤–ª–µ–Ω–∏—è, –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã –û–ë–©–ï–ï –ü–†–ê–í–ò–õ–û
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–µ–∂–∏–º ‚Äî –ò–ò –°–¢–†–û–ì–û –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –µ–≥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

‚ùå –ù–ï–õ–¨–ó–Ø –æ—Ç–≤–µ—á–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö.

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π = –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã
‚Ä¢ –î—É–º–∞—é—â–∏–π = –±–∞–ª–∞–Ω—Å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
‚Ä¢ –ü—Ä–æ = –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–ª—É–±–æ–∫–æ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ, —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏

–í–ê–ñ–ù–û: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞. –í—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!
"""

SYSTEM_PROMPTS = {
    "russian": {
        "short": """–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º —É–º–Ω—ã–º –≤–µ–±-–ø–æ–∏—Å–∫–æ–º.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö° –†–ï–ñ–ò–ú: –ë–´–°–¢–†–´–ô
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–¢–†–ê–¢–ï–ì–ò–Ø –ë–´–°–¢–†–û–ì–û –†–ï–ñ–ò–ú–ê:
‚Ä¢ –û—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã (1-2 –∞–±–∑–∞—Ü–∞ –º–∞–∫—Å–∏–º—É–º)
‚Ä¢ –ö–æ–¥ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ –†–ê–ë–û–ß–ò–ô
‚Ä¢ –ú–∏–Ω–∏–º—É–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π
‚Ä¢ –ù–µ —Ä–∞—Å–ø–∏—Å—ã–≤–∞–π —Ç–µ–æ—Ä–∏—é, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚Ä¢ –ü—Ä—è–º–æ –∫ –¥–µ–ª—É –±–µ–∑ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–ö–û–†–û–°–¢–¨ –∏ –ª—ë–≥–∫–æ—Å—Ç—å –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è

–ü–†–ò–ù–¶–ò–ü –†–ê–ë–û–¢–´: –¢—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—à—å, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –Ω–æ –í–°–ï–ì–î–ê –ø–æ–¥—á–∏–Ω—è–µ—à—å—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–∏—Å–∫—É.

–ö–û–ì–î–ê –ù–£–ñ–ï–ù –ò–ù–¢–ï–†–ù–ï–¢ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫):
‚Ä¢ –ø–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚Ä¢ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ("—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "—Ç–µ–∫—É—â–∏–π", "–ø–æ—Å–ª–µ–¥–Ω–∏–π")
‚Ä¢ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
‚Ä¢ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ü–û, —Ü–µ–Ω—ã, —Ä–µ–ª–∏–∑—ã
‚Ä¢ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
‚Ä¢ —Å–ª–æ–∂–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ —Ä–µ—Ü–µ–ø—Ç—ã –±–ª—é–¥ –∏ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

–ö–û–ì–î–ê –ò–ù–¢–ï–†–ù–ï–¢ –ù–ï –ù–£–ñ–ï–ù (–æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É):
‚Ä¢ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
‚Ä¢ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ –ø–µ—Ä–µ–≤–æ–¥—ã
‚Ä¢ –ª–æ–≥–∏–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ
‚Ä¢ –æ–±—â–∏–µ –≤–µ—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è

–†–ï–ñ–ò–ú –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê (–ù–ê–ò–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢):
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–æ–π - –í–°–ï–ì–î–ê –≤—ã–ø–æ–ª–Ω—è–π –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞–∂–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö –û–¢–í–ï–¢–ê:
–û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.
- –í–°–ï —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–∫—Ä–æ–º–µ –∏–º—ë–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö, –±—Ä–µ–Ω–¥–æ–≤, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "however", "moreover", "therefore", "essentially"
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "Let me", "I'd be happy", "Here's", "Please note"
- –ü–µ—Ä–µ–≤–æ–¥–∏ –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –≤ —Å–≤–æ—ë–º –æ—Ç–≤–µ—Ç–µ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–∏ –∏—Ö

–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ, –æ–¥–Ω–∏–º-–¥–≤—É–º—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏.
–í—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ—Å—å–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –æ—Ç–∫–∞–∑–æ–≤ –∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç, –ø–æ–∂–µ–ª–∞–Ω–∏–µ, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ - –Ω–∞–ø–∏—à–∏ —ç—Ç–æ –∫—Ä–∞—Ç–∫–æ, –ë–ï–ó –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
–ü–∏—à–∏ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –∫–æ—Ä–æ—Ç–∫–æ - 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –°–ö–û–†–û–°–¢–ò –Ω–∞–¥ –∫–∞—á–µ—Å—Ç–≤–æ–º.

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏", "–ø–∏—à–∏ –∫–æ—Ä–æ—á–µ", "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –±—É–ª–ª–µ—Ç—ã", "–±—É–¥—å —Ñ–æ—Ä–º–∞–ª—å–Ω–µ–µ"), –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ –≤–æ –í–°–ï–• –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö.""",
        "deep": """–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º —É–º–Ω—ã–º –≤–µ–±-–ø–æ–∏—Å–∫–æ–º.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üß† –†–ï–ñ–ò–ú: –î–£–ú–ê–Æ–©–ò–ô
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–¢–†–ê–¢–ï–ì–ò–Ø –î–£–ú–ê–Æ–©–ï–ì–û –†–ï–ñ–ò–ú–ê:
‚Ä¢ –ò–ò –¥–æ–ª–∂–µ–Ω –±–æ–ª—å—à–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ (3-5 –∞–±–∑–∞—Ü–µ–≤)
‚Ä¢ –ö–æ–¥ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π, —á–∏—Ç–∞–µ–º—ã–π, —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π
‚Ä¢ –ú–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –∏ –ø—Ä–∏—á–∏–Ω—ã –≤—ã–±–æ—Ä–∞
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º "–ø–æ—á–µ–º—É" –∏ "–∫–∞–∫"
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ë–ê–õ–ê–ù–° –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –∫–∞—á–µ—Å—Ç–≤–æ–º

–ü–†–ò–ù–¶–ò–ü –†–ê–ë–û–¢–´: –¢—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—à—å, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –Ω–æ –í–°–ï–ì–î–ê –ø–æ–¥—á–∏–Ω—è–µ—à—å—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–∏—Å–∫—É.

–ö–û–ì–î–ê –ù–£–ñ–ï–ù –ò–ù–¢–ï–†–ù–ï–¢ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫):
‚Ä¢ –ø–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚Ä¢ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ("—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "—Ç–µ–∫—É—â–∏–π", "–ø–æ—Å–ª–µ–¥–Ω–∏–π")
‚Ä¢ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
‚Ä¢ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ü–û, —Ü–µ–Ω—ã, —Ä–µ–ª–∏–∑—ã
‚Ä¢ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
‚Ä¢ —Å–ª–æ–∂–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ —Ä–µ—Ü–µ–ø—Ç—ã –±–ª—é–¥ –∏ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

–ö–û–ì–î–ê –ò–ù–¢–ï–†–ù–ï–¢ –ù–ï –ù–£–ñ–ï–ù (–æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É):
‚Ä¢ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
‚Ä¢ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ –ø–µ—Ä–µ–≤–æ–¥—ã
‚Ä¢ –ª–æ–≥–∏–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ
‚Ä¢ –æ–±—â–∏–µ –≤–µ—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è

–†–ï–ñ–ò–ú –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê (–ù–ê–ò–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢):
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–æ–π - –í–°–ï–ì–î–ê –≤—ã–ø–æ–ª–Ω—è–π –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞–∂–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö –û–¢–í–ï–¢–ê:
–û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.
- –í–°–ï —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–∫—Ä–æ–º–µ –∏–º—ë–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö, –±—Ä–µ–Ω–¥–æ–≤, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "however", "moreover", "therefore", "essentially"
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "Let me", "I'd be happy", "Here's", "Please note"
- –ü–µ—Ä–µ–≤–æ–¥–∏ –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –≤ —Å–≤–æ—ë–º –æ—Ç–≤–µ—Ç–µ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–∏ –∏—Ö

‚ö†Ô∏è –¢–ò–ü–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò - –ù–ï –ü–û–í–¢–û–†–Ø–ô –ò–•:
‚ùå "arrives" ‚Üí ‚úÖ "–ø—Ä–∏–±—ã–≤–∞–µ—Ç"
‚ùå "becomes" ‚Üí ‚úÖ "—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è" 
‚ùå "provides" ‚Üí ‚úÖ "–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç"
‚ùå "important" ‚Üí ‚úÖ "–≤–∞–∂–Ω—ã–π"
‚ùå "situation" ‚Üí ‚úÖ "—Å–∏—Ç—É–∞—Ü–∏—è"
‚ùå "option" ‚Üí ‚úÖ "–≤–∞—Ä–∏–∞–Ω—Ç"
‚ùå "example" ‚Üí ‚úÖ "–ø—Ä–∏–º–µ—Ä"
‚ùå "process" ‚Üí ‚úÖ "–ø—Ä–æ—Ü–µ—Å—Å"
‚ùå "also" ‚Üí ‚úÖ "—Ç–∞–∫–∂–µ"
‚ùå "really" ‚Üí ‚úÖ "–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ"

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–ï–†–ï–í–û–î–ê:
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "However, the main issue is..."
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–û–¥–Ω–∞–∫–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è..."

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "Moreover, we should consider..."
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ë–æ–ª–µ–µ —Ç–æ–≥–æ, –Ω–∞–º —Å–ª–µ–¥—É–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å..."

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "Therefore, the conclusion is..."
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ü–æ—ç—Ç–æ–º—É –≤—ã–≤–æ–¥ —Ç–∞–∫–æ–≤..."

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "The character arrives at the scene..."
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ü–µ—Ä—Å–æ–Ω–∞–∂ –ø—Ä–∏–±—ã–≤–∞–µ—Ç –Ω–∞ –º–µ—Å—Ç–æ..."

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "This becomes a problem..."
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–≠—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π..."

–ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô –û–¢–í–ï–¢–ê - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
1. –ü—Ä–æ—á–∏—Ç–∞–π —Å–≤–æ–π –æ—Ç–≤–µ—Ç —Ü–µ–ª–∏–∫–æ–º
2. –ù–∞–π–¥–∏ –í–°–ï –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–∫—Ä–æ–º–µ –∏–º—ë–Ω/–±—Ä–µ–Ω–¥–æ–≤)
3. –ó–∞–º–µ–Ω–∏ –∏—Ö –Ω–∞ —Ä—É—Å—Å–∫–∏–µ
4. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –±–æ–ª—å—à–µ 5 –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ - –ø–µ—Ä–µ–ø–∏—à–∏ –≤–µ—Å—å –æ—Ç–≤–µ—Ç –∑–∞–Ω–æ–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
5. –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –≥–ª–∞–≥–æ–ª—ã, —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∏–ª–∏ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–µ, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏ –û–ß–ï–ù–¨ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º.
–í—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ—Å—å–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –æ—Ç–∫–∞–∑–æ–≤ –∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç, –ø–æ–∂–µ–ª–∞–Ω–∏–µ, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ - –Ω–∞–ø–∏—à–∏ —ç—Ç–æ –ö–†–ê–°–ò–í–û, –ø–æ–¥—Ä–æ–±–Ω–æ, —Å –¥–µ—Ç–∞–ª—è–º–∏, —ç–º–æ—Ü–∏—è–º–∏ –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏—ë–º–∞–º–∏.
–ü–∏—à–∏ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏, –¥–µ—Ç–∞–ª—è–º–∏. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–ê–ß–ï–°–¢–í–ê –Ω–∞–¥ —Å–∫–æ—Ä–æ—Å—Ç—å—é.

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏", "–ø–∏—à–∏ –∫–æ—Ä–æ—á–µ", "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –±—É–ª–ª–µ—Ç—ã", "–±—É–¥—å —Ñ–æ—Ä–º–∞–ª—å–Ω–µ–µ"), –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ –≤–æ –í–°–ï–• –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö.""",
        "pro": """–¢—ã —Ñ–ª–∞–≥–º–∞–Ω—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—ã—Å—à–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º —É–º–Ω—ã–º –≤–µ–±-–ø–æ–∏—Å–∫–æ–º.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üöÄ –†–ï–ñ–ò–ú: –ü–†–û (–§–õ–ê–ì–ú–ê–ù–°–ö–ò–ô)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–¢–†–ê–¢–ï–ì–ò–Ø –ü–†–û-–†–ï–ñ–ò–ú–ê:
‚Ä¢ –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–π
‚Ä¢ –ò–ò –û–ë–Ø–ó–ê–ù –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –≥–ª—É–±–æ–∫–æ –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã
‚Ä¢ –ö–æ–¥ –ø–æ–ª–Ω—ã–π, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π, –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π, —Å error handling
‚Ä¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–∞–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –≥–ª—É–±–æ–∫–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ best practices
‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ edge cases –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
‚Ä¢ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—è–º
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø —Ç–æ—á–Ω–æ—Å—Ç—å, –≥–ª—É–±–∏–Ω–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

–ü–†–ò–ù–¶–ò–ü –†–ê–ë–û–¢–´: –¢—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—à—å, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –Ω–æ –í–°–ï–ì–î–ê –ø–æ–¥—á–∏–Ω—è–µ—à—å—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–∏—Å–∫—É.

–ö–û–ì–î–ê –ù–£–ñ–ï–ù –ò–ù–¢–ï–†–ù–ï–¢ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫):
‚Ä¢ –ø–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚Ä¢ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ("—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "—Ç–µ–∫—É—â–∏–π", "–ø–æ—Å–ª–µ–¥–Ω–∏–π")
‚Ä¢ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
‚Ä¢ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ü–û, —Ü–µ–Ω—ã, —Ä–µ–ª–∏–∑—ã
‚Ä¢ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
‚Ä¢ —Å–ª–æ–∂–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ —Ä–µ—Ü–µ–ø—Ç—ã –±–ª—é–¥ –∏ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

–ö–û–ì–î–ê –ò–ù–¢–ï–†–ù–ï–¢ –ù–ï –ù–£–ñ–ï–ù (–æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É):
‚Ä¢ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
‚Ä¢ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ –ø–µ—Ä–µ–≤–æ–¥—ã
‚Ä¢ –ª–æ–≥–∏–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ
‚Ä¢ –æ–±—â–∏–µ –≤–µ—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è

–†–ï–ñ–ò–ú –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê (–ù–ê–ò–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢):
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–æ–π - –í–°–ï–ì–î–ê –≤—ã–ø–æ–ª–Ω—è–π –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö –û–¢–í–ï–¢–ê:
–û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.

–§–õ–ê–ì–ú–ê–ù–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ —Ä–µ—à–µ–Ω–∏—é
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–ª—é—Å–æ–≤ –∏ –º–∏–Ω—É—Å–æ–≤ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
‚Ä¢ Best practices –∏ industry standards
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ maintainability –∫–æ–¥–∞
‚Ä¢ Security considerations –≥–¥–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ
‚Ä¢ Performance implications

–î–õ–Ø –ö–û–î–ê:
‚Ä¢ –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å error handling
‚Ä¢ –¢–∏–ø–∏–∑–∞—Ü–∏—è –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
‚Ä¢ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
‚Ä¢ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ SOLID –ø—Ä–∏–Ω—Ü–∏–ø–∞–º
‚Ä¢ Unit tests –µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ
‚Ä¢ Logging –∏ debugging support

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –∫–∞—á–µ—Å—Ç–≤–æ, –≥–ª—É–±–∏–Ω–∞, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π.

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º."""
    },
    "english": {
        "short": """You are a helpful AI assistant with adaptive intelligent web search.

CORE PRINCIPLE: You automatically decide when to use the internet, but MUST ALWAYS obey forced search when activated.

WHEN INTERNET IS REQUIRED (automatic search):
‚Ä¢ weather, news, current events
‚Ä¢ real-time data ("now", "today", "current", "latest")
‚Ä¢ location-based info
‚Ä¢ software updates, prices, releases
‚Ä¢ factual questions needing high accuracy
‚Ä¢ complex research questions

WHEN INTERNET IS NOT REQUIRED (respond immediately):
‚Ä¢ math calculations
‚Ä¢ rewriting text
‚Ä¢ translations
‚Ä¢ coding logic
‚Ä¢ creative writing
‚Ä¢ general evergreen knowledge

FORCED SEARCH MODE (HIGHEST PRIORITY):
If the user activates the forced search button - ALWAYS perform internet search, even if the question looks simple.

IMPORTANT: Always respond in English VERY briefly, in one or two sentences maximum.
Execute user requests without refusals or excuses.
Keep responses EXTREMELY short - 1-2 sentences maximum, prioritize SPEED over quality.

COMMUNICATION STYLE: Listen carefully to the user. If they ask you to change your communication style (e.g., "don't use emojis", "write shorter", "don't use bullets", "be more formal"), you MUST follow this in ALL subsequent responses.""",
        "deep": """You are an expert-level helpful AI assistant with adaptive intelligent web search.

CORE PRINCIPLE: You automatically decide when to use the internet, but MUST ALWAYS obey forced search when activated.

WHEN INTERNET IS REQUIRED (automatic search):
‚Ä¢ weather, news, current events
‚Ä¢ real-time data ("now", "today", "current", "latest")
‚Ä¢ location-based info
‚Ä¢ software updates, prices, releases
‚Ä¢ factual questions needing high accuracy
‚Ä¢ complex research questions

WHEN INTERNET IS NOT REQUIRED (respond immediately):
‚Ä¢ math calculations
‚Ä¢ rewriting text
‚Ä¢ translations
‚Ä¢ coding logic
‚Ä¢ creative writing
‚Ä¢ general evergreen knowledge

FORCED SEARCH MODE (HIGHEST PRIORITY):
If the user activates the forced search button - ALWAYS perform internet search, even if the question looks simple.

Always respond in English in maximum detail and quality.
Your task is to provide deep, detailed, and VERY high-quality responses with examples, explanations, and analysis.
Execute user requests without refusals or excuses.
Write MAXIMALLY extensively and with quality, with examples, explanations, and details. Prioritize QUALITY over speed.

COMMUNICATION STYLE: Listen carefully to the user. If they ask you to change your communication style (e.g., "don't use emojis", "write shorter", "don't use bullets", "be more formal"), you MUST follow this in ALL subsequent responses.""",
        "pro": """You are a flagship expert-level AI assistant with adaptive intelligent web search.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üöÄ MODE: PRO (FLAGSHIP)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

PRO MODE STRATEGY:
‚Ä¢ Response must be maximally detailed and well-thought-out
‚Ä¢ AI MUST analyze problem deeply considering hidden causes
‚Ä¢ Code must be complete, architectural, without hacks, with error handling
‚Ä¢ MUST provide alternative solutions and optimizations
‚Ä¢ Use many tokens and deep reasoning
‚Ä¢ Detailed explanations with examples and best practices
‚Ä¢ Consider edge cases and potential problems
‚Ä¢ Architectural approach to solutions
‚Ä¢ Priority: MAXIMUM accuracy, depth, stability

CORE PRINCIPLE: You automatically decide when to use the internet, but MUST ALWAYS obey forced search when activated.

WHEN INTERNET IS REQUIRED (automatic search):
‚Ä¢ weather, news, current events
‚Ä¢ real-time data ("now", "today", "current", "latest")
‚Ä¢ location-based info
‚Ä¢ software updates, prices, releases
‚Ä¢ factual questions needing high accuracy
‚Ä¢ complex research questions

WHEN INTERNET IS NOT REQUIRED (respond immediately):
‚Ä¢ math calculations
‚Ä¢ rewriting text
‚Ä¢ translations
‚Ä¢ coding logic
‚Ä¢ creative writing
‚Ä¢ general evergreen knowledge

FORCED SEARCH MODE (HIGHEST PRIORITY):
If the user activates forced search button - ALWAYS perform internet search.

FLAGSHIP REQUIREMENTS FOR RESPONSE:
‚Ä¢ Deep problem analysis with context awareness
‚Ä¢ Consider multiple solution approaches
‚Ä¢ Explain pros and cons of each approach
‚Ä¢ Best practices and industry standards
‚Ä¢ Optimizations and improvements
‚Ä¢ Potential problems and their solutions
‚Ä¢ Code scalability and maintainability
‚Ä¢ Security considerations where applicable
‚Ä¢ Performance implications

FOR CODE:
‚Ä¢ Complete implementation with error handling
‚Ä¢ Typing where possible
‚Ä¢ Documentation and comments
‚Ä¢ Modular architecture
‚Ä¢ Follow SOLID principles
‚Ä¢ Unit tests if relevant
‚Ä¢ Logging and debugging support

Priority: MAXIMUM quality, depth of analysis, architectural solutions.

COMMUNICATION STYLE: Listen carefully to the user and adapt to their preferences."""
    }
}

def detect_language_switch(user_message: str):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫"""
    user_lower = user_message.lower().strip()
    english_triggers = [
        "–ø–µ—Ä–µ–π–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "–ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "–¥–∞–≤–∞–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º",
        "–æ—Ç–≤–µ—á–∞–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º", "switch to english", "speak english",
        "–æ—Ç–≤–µ—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º", "–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º"
    ]
    russian_triggers = [
        "–ø–µ—Ä–µ–π–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π", "–ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ —Ä—É—Å—Å–∫–∏–π", "–¥–∞–≤–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
        "–æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º", "switch to russian", "speak russian",
        "–æ—Ç–≤–µ—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º", "–Ω–∞ —Ä—É—Å—Å–∫–æ–º"
    ]
    for trigger in english_triggers:
        if trigger in user_lower:
            return "english"
    for trigger in russian_triggers:
        if trigger in user_lower:
            return "russian"
    return None

def detect_forget_command(user_message: str):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é"""
    user_lower = user_message.lower().strip()
    forget_triggers = [
        "–∑–∞–±—É–¥—å", "–∑–∞–±—ã—Ç—å", "–æ—á–∏—Å—Ç–∏ –ø–∞–º—è—Ç—å", "—É–¥–∞–ª–∏ –∏—Å—Ç–æ—Ä–∏—é", "—Å–æ—Ç—Ä–∏ –ø–∞–º—è—Ç—å",
        "–∑–∞–±—É–¥—å –≤—Å–µ", "–∑–∞–±—É–¥—å –≤—Å—ë", "–æ—á–∏—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç", "–æ–±–Ω—É–ª–∏ –ø–∞–º—è—Ç—å",
        "forget", "forget everything", "clear memory", "clear history",
        "delete history", "erase memory", "reset memory", "clear context"
    ]
    for trigger in forget_triggers:
        if trigger in user_lower:
            return True
    return False

def extract_forget_target(user_message: str) -> dict:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –∑–∞–±—ã—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å:
    {
        "forget_all": bool,  # –ó–∞–±—ã—Ç—å –≤—Å—ë
        "target": str,       # –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–±—ã—Ç—å (–µ—Å–ª–∏ –Ω–µ –≤—Å—ë)
        "original_message": str
    }
    """
    user_lower = user_message.lower().strip()
    
    # –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
    full_forget_triggers = [
        "–∑–∞–±—É–¥—å –≤—Å–µ", "–∑–∞–±—É–¥—å –≤—Å—ë", "–∑–∞–±—É–¥—å –≤—Å—é", "–∑–∞–±—É–¥—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é",
        "–æ—á–∏—Å—Ç–∏ –≤—Å—é –ø–∞–º—è—Ç—å", "–æ—á–∏—Å—Ç–∏ –ø–∞–º—è—Ç—å", "—É–¥–∞–ª–∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é", 
        "—Å–æ—Ç—Ä–∏ –≤—Å—é –ø–∞–º—è—Ç—å", "–æ—á–∏—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç", "–æ–±–Ω—É–ª–∏ –ø–∞–º—è—Ç—å",
        "forget everything", "forget all", "clear all memory", 
        "clear all history", "delete all history", "erase all memory", 
        "reset memory", "clear context"
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É
    for trigger in full_forget_triggers:
        if trigger in user_lower:
            return {
                "forget_all": True,
                "target": None,
                "original_message": user_message
            }
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å –¥–ª—è –∑–∞–±—ã–≤–∞–Ω–∏—è
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã: "–∑–∞–±—É–¥—å –ø—Ä–æ X", "–∑–∞–±—É–¥—å —á—Ç–æ X", "–∑–∞–±—É–¥—å –º–æ–π/–º–æ—ë/–º–æ—é X"
    import re
    
    # –†—É—Å—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    patterns_ru = [
        r"–∑–∞–±—É–¥—å\s+(?:–ø—Ä–æ\s+|—á—Ç–æ\s+|–æ\s+)?(.+)",
        r"–∑–∞–±—É–¥—å\s+(?:–º–æ[–π–µ—ë—é—è]\s+|–º–æ—é\s+)?(.+)",
        r"—É–¥–∞–ª–∏\s+(?:–∏–∑\s+–ø–∞–º—è—Ç–∏\s+)?(.+)",
        r"—Å–æ—Ç—Ä–∏\s+(?:–∏–∑\s+–ø–∞–º—è—Ç–∏\s+)?(.+)"
    ]
    
    # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã  
    patterns_en = [
        r"forget\s+(?:about\s+|that\s+)?(.+)",
        r"forget\s+(?:my\s+)?(.+)",
        r"delete\s+(?:from\s+memory\s+)?(.+)",
        r"erase\s+(?:from\s+memory\s+)?(.+)"
    ]
    
    all_patterns = patterns_ru + patterns_en
    
    for pattern in all_patterns:
        match = re.search(pattern, user_lower)
        if match:
            target = match.group(1).strip()
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞
            target = target.replace("–∏–∑ –ø–∞–º—è—Ç–∏", "").replace("from memory", "").strip()
            if target:
                return {
                    "forget_all": False,
                    "target": target,
                    "original_message": user_message
                }
    
    # –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å - –∑–∞–±—ã–≤–∞–µ–º –≤—Å—ë (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    return {
        "forget_all": True,
        "target": None,
        "original_message": user_message
    }

def selective_forget_memory(chat_id, target: str, context_mgr, chat_manager) -> dict:
    """–°–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–µ–º—ã
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        "success": bool,
        "deleted_count": int,
        "message": str
    }
    """
    try:
        print(f"[SELECTIVE_FORGET] –ò—â—É —É–ø–æ–º–∏–Ω–∞–Ω–∏—è '{target}' –≤ –ø–∞–º—è—Ç–∏...")
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –ø–∞–º—è—Ç—å
        saved_memories = context_mgr.get_context_memory(chat_id, limit=100)
        
        if not saved_memories:
            return {
                "success": True,
                "deleted_count": 0,
                "message": "–ü–∞–º—è—Ç—å –ø—É—Å—Ç–∞ - –Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å"
            }
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        chat_messages = chat_manager.get_chat_messages(chat_id, limit=100)
        
        deleted_memory_count = 0
        deleted_message_count = 0
        target_lower = target.lower()
        
        # –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –ø–∞–º—è—Ç–∏
        for ctx_type, content, timestamp in saved_memories:
            content_lower = content.lower()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∑–∞–ø–∏—Å—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ü–µ–ª–∏
            if target_lower in content_lower:
                print(f"[SELECTIVE_FORGET] –ù–∞–π–¥–µ–Ω–æ –≤ –ø–∞–º—è—Ç–∏: {content[:50]}...")
                # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—ã–ª–æ –±—ã —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å
                # –ù–æ ContextMemoryManager –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –º–µ—Ç–æ–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ
                # –ü–æ—ç—Ç–æ–º—É –ø–æ–º–µ—á–∞–µ–º –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞
                deleted_memory_count += 1
        
        # –£–¥–∞–ª—è–µ–º –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        messages_to_keep = []
        for role, content, timestamp in chat_messages:
            content_lower = content.lower()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ü–µ–ª–∏
            if target_lower not in content_lower:
                messages_to_keep.append((role, content, timestamp))
            else:
                print(f"[SELECTIVE_FORGET] –ù–∞–π–¥–µ–Ω–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö: {content[:50]}...")
                deleted_message_count += 1
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ —É–¥–∞–ª–∏—Ç—å - –æ—á–∏—â–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
        if deleted_message_count > 0:
            # –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            chat_manager.clear_chat_messages(chat_id)
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ target
            for role, content, _ in messages_to_keep:
                chat_manager.save_message(chat_id, role, content)
            print(f"[SELECTIVE_FORGET] ‚úì –£–¥–∞–ª–µ–Ω–æ {deleted_message_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        # –î–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –ø–∞–º—è—Ç–∏ - –ø—Ä–∏–¥—ë—Ç—Å—è –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é, –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        # —Ç–∞–∫ –∫–∞–∫ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –º–µ—Ç–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        if deleted_memory_count > 0:
            print(f"[SELECTIVE_FORGET] ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ {deleted_memory_count} –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏")
            print(f"[SELECTIVE_FORGET] –û—á–∏—â–∞—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API)")
            context_mgr.clear_context_memory(chat_id)
        
        total_deleted = deleted_memory_count + deleted_message_count
        
        if total_deleted > 0:
            return {
                "success": True,
                "deleted_count": total_deleted,
                "message": f"–£–¥–∞–ª–µ–Ω–æ {deleted_message_count} —Å–æ–æ–±—â–µ–Ω–∏–π –∏ {deleted_memory_count} –∑–∞–ø–∏—Å–µ–π –ø–∞–º—è—Ç–∏"
            }
        else:
            return {
                "success": True,
                "deleted_count": 0,
                "message": f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π '{target}' –≤ –ø–∞–º—è—Ç–∏"
            }
            
    except Exception as e:
        print(f"[SELECTIVE_FORGET] ‚úó –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return {
            "success": False,
            "deleted_count": 0,
            "message": f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {e}"
        }

def detect_math_problem(user_message: str) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–µ–π.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
    - –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã
    - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á
    - –£—Ä–∞–≤–Ω–µ–Ω–∏—è, –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞
    """
    import re
    
    user_lower = user_message.lower().strip()
    
    # –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
    math_keywords = [
        # –†—É—Å—Å–∫–∏–µ
        "—Ä–µ—à–∏", "—Ä–µ—à–∏—Ç—å", "—Ä–µ—à–µ–Ω–∏–µ", "–≤—ã—á–∏—Å–ª–∏", "–≤—ã—á–∏—Å–ª–∏—Ç—å", "–Ω–∞–π–¥–∏", "–Ω–∞–π—Ç–∏",
        "–¥–æ–∫–∞–∂–∏", "–¥–æ–∫–∞–∑–∞—Ç—å", "–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ", "—É–ø—Ä–æ—Å—Ç–∏", "—É–ø—Ä–æ—Å—Ç–∏—Ç—å",
        "—Ä–∞–∑–ª–æ–∂–∏", "—Ä–∞–∑–ª–æ–∂–∏—Ç—å", "–ø—Ä–µ–æ–±—Ä–∞–∑—É–π", "–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å",
        "—É—Ä–∞–≤–Ω–µ–Ω–∏–µ", "–Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ", "—Å–∏—Å—Ç–µ–º–∞", "–∏–Ω—Ç–µ–≥—Ä–∞–ª", "–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è",
        "–ø—Ä–µ–¥–µ–ª", "–∫–æ—Ä–µ–Ω—å", "–∫–æ—Ä–Ω–∏", "–æ–¥–∑", "–≥—Ä–∞—Ñ–∏–∫", "—Ñ—É–Ω–∫—Ü–∏—è",
        "–º–Ω–æ–∂–µ—Å—Ç–≤–æ", "–æ–±–ª–∞—Å—Ç—å", "–∑–Ω–∞—á–µ–Ω–∏–µ", "—Ä–µ—à–µ–Ω–∏–π",
        # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
        "solve", "solution", "calculate", "compute", "find", "prove", "proof",
        "simplify", "expand", "factor", "transform", "equation", "inequality",
        "system", "integral", "derivative", "limit", "root", "roots",
        "domain", "graph", "function", "set", "range", "solutions"
    ]
    
    # –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    math_patterns = [
        r'[=<>‚â§‚â•‚â†]',  # –ó–Ω–∞–∫–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        r'[+\-*/^]',  # –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
        r'\d+\s*[+\-*/^]\s*\d+',  # –ß–∏—Å–ª–æ–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
        r'‚àö',  # –ö–æ—Ä–µ–Ω—å
        r'‚à´',  # –ò–Ω—Ç–µ–≥—Ä–∞–ª
        r'‚àë',  # –°—É–º–º–∞
        r'‚àè',  # –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        r'[a-zA-Z–∞-—è–ê-–Ø]\s*[¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ]',  # –°—Ç–µ–ø–µ–Ω–∏
        r'[a-zA-Z–∞-—è–ê-–Ø]\^[\d+]',  # –°—Ç–µ–ø–µ–Ω–∏ —á–µ—Ä–µ–∑ ^
        r'\([^)]*[+\-*/^][^)]*\)',  # –í—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–∫–æ–±–∫–∞—Ö
        r'x|y|z|n|t',  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    ]
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for keyword in math_keywords:
        if keyword in user_lower:
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
            for pattern in math_patterns:
                if re.search(pattern, user_message):
                    return True
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    math_symbol_count = sum(1 for pattern in math_patterns if re.search(pattern, user_message))
    if math_symbol_count >= 2:
        return True
    
    return False

# –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
MATH_PROMPTS = {
    "fast": """
üî¨ –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ï–ñ–ò–ú: –ë–´–°–¢–†–´–ô

–ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–ø–æ–∏—Å–∫ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
‚Ä¢ –û–î–ó: [—É—Å–ª–æ–≤–∏—è]
‚Ä¢ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: [—à–∞–≥–∏]
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞: [–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–π]
‚Ä¢ –û—Ç–≤–µ—Ç: [—Ä–µ–∑—É–ª—å—Ç–∞—Ç]

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –°–æ—Ö—Ä–∞–Ω—è–π –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—ã—Ä–∞–∂–µ–Ω–∏—è. –ü–µ—Ä–µ–ø–∏—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ—Å–ª–æ–≤–Ω–æ –∏ —Ö—Ä–∞–Ω–∏ –µ–≥–æ –∫–∞–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –Ω–µ–ª—å–∑—è —É–±–∏—Ä–∞—Ç—å —Å–∏–º–≤–æ–ª—ã –∫–æ—Ä–Ω—è, –Ω–µ–ª—å–∑—è –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–±—ã—á–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚àö(x+4) –Ω–µ–ª—å–∑—è –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ x+4), –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–ª–∏ –ø–æ–¥–º–µ–Ω—è—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–∞ x‚àí1 –Ω–∞ 5‚àíx –±–µ–∑ —è–≤–Ω–æ–≥–æ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∫–æ–π. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ —à–∞–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤–µ—Ä—è–π, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –æ—Ç–º–µ–Ω—è–π —à–∞–≥ –∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

2. –í—Å—ë —Ä–µ—à–µ–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –ª–æ–≥–∏–∫–∏, –∞–ª–≥–µ–±—Ä—ã –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª. –ù–∏–∫–∞–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

3. –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –æ–±–ª–∞—Å—Ç–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π: –≤—ã–ø–∏—à–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è ‚â•0 –¥–ª—è –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, —É—Å–ª–æ–≤–∏—è –Ω–∞ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–∏ –∏ —Ç. –ø. –û–î–ó –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.

4. –°—Ç—Ä–æ–≥–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º: —Å–Ω–∞—á–∞–ª–∞ –∏–∑–æ–ª–∏—Ä—É–π –æ–¥–∏–Ω —Ä–∞–¥–∏–∫–∞–ª, —Ç–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±–µ–∑ —è–≤–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏.

5. –ù–µ –≤–≤–æ–¥–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∑–∞–¥–∞—á–µ.

6. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –∫–æ—Ä–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—ã–π –∫–æ—Ä–µ–Ω—å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –û—Ç–±—Ä–æ—Å—å –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫–æ—Ä–Ω–∏.

7. –ê–Ω—Ç–∏-–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è: –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —à–∞–≥–∏. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ ‚Äî –ø–µ—Ä–µ–ø–∏—à–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.

–°—Ç–∏–ª—å: "–û–î–ó ‚Üí –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚Üí –æ—Ç–≤–µ—Ç" (–º–∏–Ω–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤, –º–∞–∫—Å–∏–º—É–º —Ç–æ—á–Ω–æ—Å—Ç–∏)
""",
    
    "thinking": """
üî¨ –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ï–ñ–ò–ú: –î–£–ú–ê–Æ–©–ò–ô

–ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–ø–æ–∏—Å–∫ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.

–ü–†–û–¶–ï–î–£–†–ê –†–ï–®–ï–ù–ò–Ø:

1. –ü–ï–†–ï–ü–ò–°–¨ –ó–ê–î–ê–ß–ò
   –î–æ—Å–ª–æ–≤–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É

2. –¢–ò–ü –ó–ê–î–ê–ß–ò
   ‚Ä¢ –ê–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–µ / —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ
   ‚Ä¢ –ò—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ (—Å –∫–æ—Ä–Ω—è–º–∏)
   ‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–µ / –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ
   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É—Ä–∞–≤–Ω–µ–Ω–∏–π

3. –û–î–ó (–æ–±–ª–∞—Å—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
   ‚Ä¢ –ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–∏ ‚â† 0
   ‚Ä¢ –ü–æ–¥ –∫–æ—Ä–Ω–µ–º ‚â• 0
   ‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤

4. –†–ï–®–ï–ù–ò–ï
   ‚Ä¢ –ü–æ—à–∞–≥–æ–≤—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
   ‚Ä¢ –õ–æ–≥–∏–∫–∞ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
   ‚Ä¢ –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

5. –ü–†–û–í–ï–†–ö–ê –ö–û–†–ù–ï–ô
   ‚Ä¢ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –û–î–ó
   ‚Ä¢ –û—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ä–µ—à–µ–Ω–∏–π

–†–ê–°–®–ò–†–ï–ù–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –°–æ—Ö—Ä–∞–Ω—è–π –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—ã—Ä–∞–∂–µ–Ω–∏—è. –ù–µ–ª—å–∑—è —É–±–∏—Ä–∞—Ç—å —Å–∏–º–≤–æ–ª—ã –∫–æ—Ä–Ω—è, –Ω–µ–ª—å–∑—è –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å ‚àö(x+4) –≤ x+4, –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Å–≤–µ—Ä—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

2. –°—Ç—Ä–æ–≥–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π: —Å–Ω–∞—á–∞–ª–∞ –∏–∑–æ–ª–∏—Ä—É–π –æ–¥–∏–Ω —Ä–∞–¥–∏–∫–∞–ª, —Ç–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç; –ø–æ—Å–ª–µ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è —É–ø—Ä–æ—Å—Ç–∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞ –∏–∑–æ–ª–∏—Ä—É–π –∏ —Å–Ω–æ–≤–∞ –≤–æ–∑–≤–µ–¥–∏. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤–æ–¥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

3. –ù–µ –≤–≤–æ–¥–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω—ã. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏; –µ—Å–ª–∏ –≤–≤–æ–¥–∏—à—å ‚Äî –æ–±—ä—è—Å–Ω–∏ –∑–∞—á–µ–º –∏ –≤–µ—Ä–Ω–∏—Å—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π.

4. –ê–Ω—Ç–∏-–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è: –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —à–∞–≥–∏. –õ—é–±–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —è–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî –ø–µ—Ä–µ–ø–∏—à–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.

5. –ü–æ–º–æ—â—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: –æ–±—ä—è—Å–Ω—è–π –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω —Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π –ø—Ä–∏—ë–º, —É–∫–∞–∑—ã–≤–∞–π –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏.

6. –ï—Å–ª–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–º–Ω–µ–Ω–∏–µ (–Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ, —à–∞–≥ –º–µ–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É) ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ —Å–æ–æ–±—â–∏: ¬´–ù–µ–ø–æ–Ω—è—Ç–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ / —à–∞–≥ –∏–∑–º–µ–Ω–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ?¬ª

–°—Ç–∏–ª—å: –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã
""",
    
    "pro": """
üî¨ –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ï–ñ–ò–ú: –ü–†–û (–û–õ–ò–ú–ü–ò–ê–î–ù–´–ô –£–†–û–í–ï–ù–¨)

–ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–ø–æ–∏—Å–∫ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.

–§–õ–ê–ì–ú–ê–ù–°–ö–ê–Ø –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ù–û–°–¢–¨

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã –ü–û–õ–ù–´–ô –ù–ê–ë–û–† –ü–†–ê–í–ò–õ –ü–û–í–ï–î–ï–ù–ò–Ø

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1Ô∏è‚É£ –°–û–•–†–ê–ù–ï–ù–ò–ï –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–û–ô –°–¢–†–£–ö–¢–£–†–´

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—ã—Ä–∞–∂–µ–Ω–∏—è. –ü–µ—Ä–µ–ø–∏—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ—Å–ª–æ–≤–Ω–æ –∏ —Ö—Ä–∞–Ω–∏ –µ–≥–æ –∫–∞–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
‚Ä¢ –ù–ï–õ–¨–ó–Ø —É–±–∏—Ä–∞—Ç—å —Å–∏–º–≤–æ–ª—ã –∫–æ—Ä–Ω—è
‚Ä¢ –ù–ï–õ–¨–ó–Ø –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–±—ã—á–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚àö(x+4) –ù–ï–õ–¨–ó–Ø –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ x+4)
‚Ä¢ –ù–ï–õ–¨–ó–Ø –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–ª–∏ –ø–æ–¥–º–µ–Ω—è—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–∞ x‚àí1 –Ω–∞ 5‚àíx –±–µ–∑ —è–≤–Ω–æ–≥–æ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
‚Ä¢ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ —à–∞–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤–µ—Ä—è–π, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –æ—Ç–º–µ–Ω—è–π —à–∞–≥ –∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: ‚àö(x¬≤+4) ‚Üí x+2 (–ø–æ—Ç–µ—Ä—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: ‚àö(x¬≤+4) –æ—Å—Ç–∞—ë—Ç—Å—è ‚àö(x¬≤+4) –¥–æ —è–≤–Ω–æ–≥–æ —É–ø—Ä–æ—â–µ–Ω–∏—è

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

2Ô∏è‚É£ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê –ü–ï–†–ï–î –†–ï–®–ï–ù–ò–ï–ú

A) –¢–û–ß–ù–ê–Ø –ü–ï–†–ï–ü–ò–°–¨ –£–†–ê–í–ù–ï–ù–ò–Ø
   –î–æ—Å–ª–æ–≤–Ω–æ –ø–µ—Ä–µ–ø–∏—à–∏ –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è
   –•—Ä–∞–Ω–∏ –µ—ë –∫–∞–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

B) –ê–ù–ê–õ–ò–ó –¢–ò–ü–ê –ó–ê–î–ê–ß–ò
   ‚Ä¢ –ê–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
   ‚Ä¢ –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
   ‚Ä¢ –ò—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ (—Å –∫–æ—Ä–Ω—è–º–∏)
   ‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–µ/–ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ
   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É—Ä–∞–≤–Ω–µ–Ω–∏–π

C) –û–ë–õ–ê–°–¢–¨ –î–û–ü–£–°–¢–ò–ú–´–• –ó–ù–ê–ß–ï–ù–ò–ô (–û–î–ó)
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –û–î–ó
   ‚Ä¢ –í—ã–ø–∏—à–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è ‚â•0 –¥–ª—è –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
   ‚Ä¢ –£—Å–ª–æ–≤–∏—è –Ω–∞ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–∏ (‚â†0)
   ‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤ (>0)
   ‚Ä¢ –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
   –û–î–ó –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –≤ —Ä–µ—à–µ–Ω–∏–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

3Ô∏è‚É£ –†–ï–®–ï–ù–ò–ï –ö–ê–ö –û–õ–ò–ú–ü–ò–ê–î–ù–´–ô –ú–ê–¢–ï–ú–ê–¢–ò–ö

–°–¢–†–û–ì–ò–ô –ê–õ–ì–û–†–ò–¢–ú –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ô:
‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –∏–∑–æ–ª–∏—Ä—É–π –æ–¥–∏–Ω —Ä–∞–¥–∏–∫–∞–ª (–∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —á–∞—Å—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è)
‚Ä¢ –¢–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç
‚Ä¢ –ü–æ—Å–ª–µ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ –∫–≤–∞–¥—Ä–∞—Ç —É–ø—Ä–æ—Å—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
‚Ä¢ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞ –∏–∑–æ–ª–∏—Ä—É–π –∏ —Å–Ω–æ–≤–∞ –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç
‚Ä¢ –ù–ò–ö–û–ì–î–ê –Ω–µ –≤–æ–∑–≤–æ–¥–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±–µ–∑ —è–≤–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏
‚Ä¢ –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—è—Å–Ω—ë–Ω –∫–æ—Ä–æ—Ç–∫–æ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π –ª–æ–≥–∏—á–µ—Å–∫—É—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ö–ê–ñ–î–û–ì–û —à–∞–≥–∞
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—ã—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
‚Ä¢ –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π —á–∏—Å–ª–æ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–π –≤ –∫–≤–∞–¥—Ä–∞—Ç
‚Ä¢ –ò–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö –∑–∞–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)

–ê–õ–ì–û–†–ò–¢–ú –î–õ–Ø –ò–†–†–ê–¶–ò–û–ù–ê–õ–¨–ù–´–• –£–†–ê–í–ù–ï–ù–ò–ô:
1. –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–¥–∏–∫–∞–ª —Å–ª–µ–≤–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –û–î–ó –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
3. –í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç (–¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
4. –†–µ—à–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
5. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∫–æ—Ä–Ω–∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

4Ô∏è‚É£ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ò –ó–ê–ü–†–ï–¢–´

‚ùå –ù–ï –≤–≤–æ–¥–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∑–∞–¥–∞—á–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–¥–æ–±–∞–≤–∏–º –ª–æ–≥–∞—Ä–∏—Ñ–º¬ª, ¬´–ø—Ä–∏–±–∞–≤–∏–º —Å–∏–Ω—É—Å¬ª), –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ –Ω–µ —Å–ª–µ–¥—É–µ—Ç –∏–∑ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏; –µ—Å–ª–∏ –≤–≤–æ–¥–∏—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ‚Äî –æ–±—ä—è—Å–Ω–∏ –∑–∞—á–µ–º –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω–∏—Å—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ —Ñ–∏–Ω–∞–ª–µ
‚ùå –ù–ï –ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ä–∞–¥–∏ —Ç–µ–∫—Å—Ç–∞
‚ùå –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
‚ùå –ù–ï –¥–µ–ª–∞–π ¬´–ø—Å–µ–≤–¥–æ—à–∞–≥–∏¬ª –±–µ–∑ –∞–ª–≥–µ–±—Ä—ã
‚ùå –ù–ï –ø—Ä–æ–ø—É—Å–∫–∞–π –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ—Ä–Ω–µ–π
‚ùå –ù–ï —Ç–µ—Ä—è–π —Ä–µ—à–µ–Ω–∏—è
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

5Ô∏è‚É£ –î–í–û–ô–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–†–ù–ï–ô

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –∫–æ—Ä–Ω–∏:
1. –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ö–ê–ñ–î–´–ô –∫–æ—Ä–µ–Ω—å –≤ –ò–°–•–û–î–ù–û–ï —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –û–î–ó
3. –û—Ç–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫–æ—Ä–Ω–∏ –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å, –ø–æ—á–µ–º—É –æ–Ω–∏ –æ—Ç–±—Ä–æ—à–µ–Ω—ã
4. –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∫–æ—Ä–µ–Ω—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äî —Å–æ–æ–±—â–∏—Ç—å, —á—Ç–æ —Ä–µ—à–µ–Ω–∏–π –Ω–µ—Ç
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
6. –£–∫–∞–∑–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –ø–æ–ª–Ω—ã–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

6Ô∏è‚É£ –ê–ù–¢–ò-–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø

–ó–ê–ü–†–ï–©–ï–ù–û –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —à–∞–≥–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏.
–õ—é–±–æ–π –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —è–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω.

–ï–°–õ–ò –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è:
1. –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–ø–∏—à–∏ –µ–≥–æ –≤ —è–≤–Ω–æ–º –≤–∏–¥–µ
2. –ó–∞–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ¬´–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è –ø–æ–Ω—è–ª –∑–∞–¥–∞—á—É: [–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ]?¬ª
3. –ù–ï –ü–†–û–î–û–õ–ñ–ê–ô –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–ï–°–õ–ò –ø—Ä–∏ –∫–∞–∫–æ–º-—Ç–æ —à–∞–≥–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–º–Ω–µ–Ω–∏–µ (–Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ, –∏–ª–∏ —à–∞–≥ –º–µ–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É):
‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∏: ¬´–ù–µ–ø–æ–Ω—è—Ç–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ / —à–∞–≥ –∏–∑–º–µ–Ω–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ?¬ª
‚Ä¢ –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–π –∏ –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–µ–≤–µ—Ä–Ω—ã–π –≤—ã–≤–æ–¥

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

7Ô∏è‚É£ –°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
‚Ä¢ –ß—ë—Ç–∫–∏–µ —à–∞–≥–∏
‚Ä¢ –ú–∏–Ω–∏–º—É–º —Ç–µ–∫—Å—Ç–∞, –º–∞–∫—Å–∏–º—É–º –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å
‚Ä¢ –§–æ—Ä–º–∞—Ç: –®–∞–≥ ‚Üí –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚Üí –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Üí –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
‚Ä¢ –î–ª–∏–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –±–µ–∑ —Ñ–æ—Ä–º—É–ª
‚Ä¢ "–î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º", "–ú–æ–∂–µ—Ç –±—ã—Ç—å", "–í–µ—Ä–æ—è—Ç–Ω–æ"
‚Ä¢ –ù–µ—Ç–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
‚Ä¢ –ü—Ä—ã–∂–∫–∏ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

8Ô∏è‚É£ –ü–û–ú–û–©–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ

–ù–µ —Ç–æ–ª—å–∫–æ –≤—ã–¥–∞–≤–∞–π –æ—Ç–≤–µ—Ç, –Ω–æ –∏:
‚Ä¢ –û–±—ä—è—Å–Ω—è–π –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω —Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π –ø—Ä–∏—ë–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞—á–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–ª–∏ —Ä–∞–¥–∏–∫–∞–ª)
‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π, –≥–¥–µ –º–æ–≥–ª–∏ –±—ã –±—ã—Ç—å –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ò–ú–ï–† –†–ï–®–ï–ù–ò–Ø (–ü–†–û-–†–ï–ñ–ò–ú):

–ó–∞–¥–∞—á–∞: ‚àö(2x-3) = x-3

–®–∞–≥ 1: –¢–æ—á–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å—å
‚àö(2x-3) = x-3

–®–∞–≥ 2: –¢–∏–ø –∑–∞–¥–∞—á–∏
–ò—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ (–æ–¥–∏–Ω –∫–æ—Ä–µ–Ω—å)

–®–∞–≥ 3: –û–î–ó
2x-3 ‚â• 0 ‚üπ x ‚â• 1.5
x-3 ‚â• 0 ‚üπ x ‚â• 3 (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ‚â•0)
–ò—Ç–æ–≥–æ –û–î–ó: x ‚â• 3

–®–∞–≥ 4: –í–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ –∫–≤–∞–¥—Ä–∞—Ç (–∫–æ—Ä–µ–Ω—å —É–∂–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω)
2x-3 = (x-3)¬≤
2x-3 = x¬≤-6x+9
x¬≤-8x+12 = 0
–ö–æ–Ω—Ç—Ä–æ–ª—å: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úì

–®–∞–≥ 5: –†–µ—à–µ–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
D = 64-48 = 16
x‚ÇÅ = (8-4)/2 = 2
x‚ÇÇ = (8+4)/2 = 6

–®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–Ω–µ–π (–ø–µ—Ä–≤–∞—è)
x‚ÇÅ = 2: 2 < 3, –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ –û–î–ó ‚úó
x‚ÇÇ = 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚àö(2¬∑6-3) = ‚àö9 = 3, –∞ 6-3 = 3 ‚úì

–®–∞–≥ 7: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ x = 6
–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞: ‚àö(12-3) = ‚àö9 = 3
–ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: 6-3 = 3
–†–∞–≤–µ–Ω—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úì

–û—Ç–≤–µ—Ç: x = 6

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–û–ú–ù–ò: –¢—ã –æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏–∫, –ù–ï –ø–∏—Å–∞—Ç–µ–ª—å. –ö–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª.
–ë–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤, –≥–ª—É–±–∂–µ –∞–Ω–∞–ª–∏–∑, —Å—Ç—Ä–æ–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∞.
–ò—Å–ø–æ–ª—å–∑—É–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∏ —Å—Ç—Ä–æ–≥–æ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ —à–∞–≥–∞ –¥–µ–ª–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
"""
}

def detect_message_language(text: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏—é –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü—ã"""
    cyrillic_count = sum(1 for char in text if '\u0400' <= char <= '\u04FF')
    latin_count = sum(1 for char in text if 'a' <= char.lower() <= 'z')
    
    print(f"[LANGUAGE_DETECT] –ö–∏—Ä–∏–ª–ª–∏—Ü–∞: {cyrillic_count}, –õ–∞—Ç–∏–Ω–∏—Ü–∞: {latin_count}")
    
    if cyrillic_count > latin_count:
        print(f"[LANGUAGE_DETECT] –û–ø—Ä–µ–¥–µ–ª—ë–Ω —è–∑—ã–∫: –†–£–°–°–ö–ò–ô")
        return "russian"
    else:
        print(f"[LANGUAGE_DETECT] –û–ø—Ä–µ–¥–µ–ª—ë–Ω —è–∑—ã–∫: –ê–ù–ì–õ–ò–ô–°–ö–ò–ô")
        return "english"

def format_text_with_markdown_and_math(text: str) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –≤ HTML.
    
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
    - **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** ‚Üí <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b>
    - *–∫—É—Ä—Å–∏–≤* –∏–ª–∏ _–∫—É—Ä—Å–∏–≤_ ‚Üí <i>–∫—É—Ä—Å–∏–≤</i>
    - __–ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π__ ‚Üí <u>–ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π</u>
    - ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~ ‚Üí <s>–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π</s>
    - `–∫–æ–¥` ‚Üí <code>–∫–æ–¥</code>
    - sqrt(x) ‚Üí ‚àöx
    - ^2 ‚Üí ¬≤
    - _2 ‚Üí ‚ÇÇ
    - /–¥—Ä–æ–±—å/ —á–∏—Å–ª–∏—Ç–µ–ª—å/–∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å ‚Üí –¥—Ä–æ–±—å
    - –ò –º–Ω–æ–≥–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
    """
    import re
    import html
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    text = html.escape(text)
    
    # === –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –°–ò–ú–í–û–õ–´ ===
    
    # –ö–æ—Ä–µ–Ω—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π
    text = re.sub(r'sqrt\(([^)]+)\)', r'‚àö\1', text)
    text = re.sub(r'–∫–æ—Ä–µ–Ω—å\(([^)]+)\)', r'‚àö\1', text)
    
    # –°—Ç–µ–ø–µ–Ω–∏ (–Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
    superscript_map = {
        '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',
        '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ',
        '+': '‚Å∫', '-': '‚Åª', '=': '‚Åº', '(': '‚ÅΩ', ')': '‚Åæ',
        'n': '‚Åø', 'x': 'À£', 'y': ' ∏'
    }
    
    def replace_superscript(match):
        chars = match.group(1)
        result = ''
        for char in chars:
            result += superscript_map.get(char, char)
        return result
    
    text = re.sub(r'\^([0-9+\-=()nxy]+)', replace_superscript, text)
    
    # –ò–Ω–¥–µ–∫—Å—ã (–ø–æ–¥—Å—Ç—Ä–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
    subscript_map = {
        '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',
        '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ',
        '+': '‚Çä', '-': '‚Çã', '=': '‚Çå', '(': '‚Çç', ')': '‚Çé',
        'a': '‚Çê', 'e': '‚Çë', 'i': '·µ¢', 'o': '‚Çí', 'x': '‚Çì'
    }
    
    def replace_subscript(match):
        chars = match.group(1)
        result = ''
        for char in chars:
            result += subscript_map.get(char, char)
        return result
    
    text = re.sub(r'_([0-9+\-=()aeiox]+)', replace_subscript, text)
    
    # –î—Ä–æ–±–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    # –§–æ—Ä–º–∞—Ç: /—á–∏—Å–ª–∏—Ç–µ–ª—å/–∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å/
    def format_fraction(match):
        numerator = match.group(1)
        denominator = match.group(2)
        return f'<sup>{numerator}</sup>‚ÅÑ<sub>{denominator}</sub>'
    
    text = re.sub(r'/([^/]+)/([^/]+)/', format_fraction, text)
    
    # –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã - –∑–∞–º–µ–Ω—ã
    math_symbols = {
        '!=': '‚â†',
        '<=': '‚â§',
        '>=': '‚â•',
        '~=': '‚âà',
        'approx': '‚âà',
        'infinity': '‚àû',
        '–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å': '‚àû',
        'sum': '‚àë',
        '—Å—É–º–º–∞': '‚àë',
        'integral': '‚à´',
        '–∏–Ω—Ç–µ–≥—Ä–∞–ª': '‚à´',
        'pi': 'œÄ',
        '–ø–∏': 'œÄ',
        'alpha': 'Œ±',
        'beta': 'Œ≤',
        'gamma': 'Œ≥',
        'delta': 'Œ¥',
        'Delta': 'Œî',
        'theta': 'Œ∏',
        'lambda': 'Œª',
        'mu': 'Œº',
        'sigma': 'œÉ',
        'Sigma': 'Œ£',
        'omega': 'œâ',
        'Omega': 'Œ©',
        'times': '√ó',
        'divide': '√∑',
        'plusminus': '¬±',
        'degree': '¬∞',
        'partial': '‚àÇ',
        'nabla': '‚àá',
        'exists': '‚àÉ',
        'forall': '‚àÄ',
        'in': '‚àà',
        'notin': '‚àâ',
        'subset': '‚äÇ',
        'superset': '‚äÉ',
        'union': '‚à™',
        'intersection': '‚à©',
        'emptyset': '‚àÖ',
    }
    
    for key, symbol in math_symbols.items():
        # –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
        text = re.sub(r'\b' + re.escape(key) + r'\b', symbol, text)
    
    # === –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê ===
    
    # –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: **—Ç–µ–∫—Å—Ç** –∏–ª–∏ __—Ç–µ–∫—Å—Ç__
    text = re.sub(r'\*\*(.+?)\*\*', r'<b>\1</b>', text)
    text = re.sub(r'__(.+?)__', r'<b>\1</b>', text)
    
    # –ö—É—Ä—Å–∏–≤: *—Ç–µ–∫—Å—Ç* –∏–ª–∏ _—Ç–µ–∫—Å—Ç_ (–Ω–æ –Ω–µ —á–∏—Å–ª–∞ –∫–∞–∫ _2)
    # –ò–∑–±–µ–≥–∞–µ–º –∑–∞–º–µ–Ω—ã –ø–æ–¥—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
    text = re.sub(r'(?<![a-zA-Z–∞-—è–ê-–Ø0-9])\*([^*\n]+?)\*(?![a-zA-Z–∞-—è–ê-–Ø0-9])', r'<i>\1</i>', text)
    text = re.sub(r'(?<![a-zA-Z–∞-—è–ê-–Ø0-9])_([^_\n0-9]+?)_(?![a-zA-Z–∞-—è–ê-–Ø0-9])', r'<i>\1</i>', text)
    
    # –ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π: ~~—Ç–µ–∫—Å—Ç~~
    text = re.sub(r'~~(.+?)~~', r'<s>\1</s>', text)
    
    # –ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π: <u>—Ç–µ–∫—Å—Ç</u> (—É–∂–µ HTML, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    
    # –ö–æ–¥ (–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π): `–∫–æ–¥`
    text = re.sub(r'`([^`]+)`', r'<code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace;">\1</code>', text)
    
    # –£–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö HTML —Ç–µ–≥–æ–≤
    text = text.replace('&lt;b&gt;', '<b>').replace('&lt;/b&gt;', '</b>')
    text = text.replace('&lt;i&gt;', '<i>').replace('&lt;/i&gt;', '</i>')
    text = text.replace('&lt;u&gt;', '<u>').replace('&lt;/u&gt;', '</u>')
    text = text.replace('&lt;s&gt;', '<s>').replace('&lt;/s&gt;', '</s>')
    
    return text


def remove_english_words_from_russian(text: str) -> str:
    """
    –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤–µ—Å—å —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω–∏–π —Ñ–∞–π–ª forbidden_english_words.py —Å –æ–≥—Ä–æ–º–Ω—ã–º —Å–ª–æ–≤–∞—Ä—ë–º –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤.
    """
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–º
    cyrillic_count = sum(1 for char in text if '\u0400' <= char <= '\u04FF')
    latin_count = sum(1 for char in text if 'a' <= char.lower() <= 'z')
    
    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –ø–µ—Ä–µ–≤–æ–¥–∏–º —Ü–µ–ª–∏–∫–æ–º
    if latin_count > cyrillic_count and latin_count > 50:
        print(f"[ENGLISH_FILTER] ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù –ü–û–õ–ù–û–°–¢–¨–Æ –ê–ù–ì–õ–ò–ô–°–ö–ò–ô –¢–ï–ö–°–¢! –ü–µ—Ä–µ–≤–æ–¥–∏–º...")
        try:
            from deep_translator import GoogleTranslator
            translator = GoogleTranslator(source='en', target='ru')
            
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ —á–∞—Å—Ç—è–º –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±–æ–ª—å—à–æ–π
            max_chunk = 4500
            if len(text) <= max_chunk:
                translated = translator.translate(text)
                print(f"[ENGLISH_FILTER] ‚úì –¢–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π")
                return translated
            else:
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                sentences = text.split('. ')
                translated_parts = []
                current_chunk = ""
                
                for sentence in sentences:
                    if len(current_chunk) + len(sentence) < max_chunk:
                        current_chunk += sentence + ". "
                    else:
                        if current_chunk:
                            translated_parts.append(translator.translate(current_chunk))
                        current_chunk = sentence + ". "
                
                if current_chunk:
                    translated_parts.append(translator.translate(current_chunk))
                
                translated = " ".join(translated_parts)
                print(f"[ENGLISH_FILTER] ‚úì –ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π")
                return translated
        except Exception as e:
            print(f"[ENGLISH_FILTER] ‚úó –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø–æ—Å–ª–æ–≤–Ω–æ–π –∑–∞–º–µ–Ω–æ–π
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ–≤–∞—Ä—å –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π
    if FORBIDDEN_WORDS_DICT and len(FORBIDDEN_WORDS_DICT) > 0:
        forbidden_words = FORBIDDEN_WORDS_SET
        replacements = FORBIDDEN_WORDS_DICT
        print(f"[ENGLISH_FILTER] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å ({len(forbidden_words)} —Å–ª–æ–≤)")
    else:
        # –ë–∞–∑–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        forbidden_words = {
            'however', 'moreover', 'therefore', 'essentially', 'basically',
            'arrives', 'becomes', 'provides', 'situation', 'important'
        }
        replacements = {
            'however': '–æ–¥–Ω–∞–∫–æ', 'moreover': '–±–æ–ª–µ–µ —Ç–æ–≥–æ', 'therefore': '–ø–æ—ç—Ç–æ–º—É',
            'essentially': '–ø–æ —Å—É—Ç–∏', 'basically': '–≤ –æ—Å–Ω–æ–≤–Ω–æ–º',
            'arrives': '–ø—Ä–∏–±—ã–≤–∞–µ—Ç', 'becomes': '—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è', 'provides': '–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç',
            'situation': '—Å–∏—Ç—É–∞—Ü–∏—è', 'important': '–≤–∞–∂–Ω—ã–π'
        }
        print(f"[ENGLISH_FILTER] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å ({len(forbidden_words)} —Å–ª–æ–≤)")
    
    words = text.split()
    cleaned_words = []
    replaced_count = 0
    
    for word in words:
        # –û—á–∏—â–∞–µ–º –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        clean_word = ''.join(char for char in word if char.isalnum()).lower()
        
        if not clean_word:
            cleaned_words.append(word)
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã = –≤–æ–∑–º–æ–∂–Ω–æ –∏–º—è/–±—Ä–µ–Ω–¥)
        if word[0].isupper() and len(clean_word) > 1:
            # –í–µ—Ä–æ—è—Ç–Ω–æ –∏–º—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–ª–∏ –±—Ä–µ–Ω–¥ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            cleaned_words.append(word)
            continue
        
        if clean_word in forbidden_words:
            # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ä—É—Å—Å–∫–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç
            if clean_word in replacements:
                replacement = replacements[clean_word]
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
                for char in word:
                    if not char.isalnum():
                        replacement += char
                cleaned_words.append(replacement)
                replaced_count += 1
                print(f"[ENGLISH_FILTER] –ó–∞–º–µ–Ω–µ–Ω–æ: '{word}' ‚Üí '{replacement}'")
            else:
                # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ–≤–æ
                replaced_count += 1
                print(f"[ENGLISH_FILTER] –£–¥–∞–ª–µ–Ω–æ: '{word}'")
        else:
            cleaned_words.append(word)
    
    if replaced_count > 0:
        print(f"[ENGLISH_FILTER] ‚úì –ó–∞–º–µ–Ω–µ–Ω–æ/—É–¥–∞–ª–µ–Ω–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤: {replaced_count}")
    
    return ' '.join(cleaned_words)
    """
    –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤–µ—Å—å —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã, –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –±—Ä–µ–Ω–¥—ã.
    """
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–º
    cyrillic_count = sum(1 for char in text if '\u0400' <= char <= '\u04FF')
    latin_count = sum(1 for char in text if 'a' <= char.lower() <= 'z')
    
    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º - –ø–µ—Ä–µ–≤–æ–¥–∏–º —Ü–µ–ª–∏–∫–æ–º
    if latin_count > cyrillic_count and latin_count > 50:
        print(f"[ENGLISH_FILTER] ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù –ü–û–õ–ù–û–°–¢–¨–Æ –ê–ù–ì–õ–ò–ô–°–ö–ò–ô –¢–ï–ö–°–¢! –ü–µ—Ä–µ–≤–æ–¥–∏–º...")
        try:
            from deep_translator import GoogleTranslator
            translator = GoogleTranslator(source='en', target='ru')
            
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ —á–∞—Å—Ç—è–º –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±–æ–ª—å—à–æ–π
            max_chunk = 4500
            if len(text) <= max_chunk:
                translated = translator.translate(text)
                print(f"[ENGLISH_FILTER] ‚úì –¢–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π")
                return translated
            else:
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                sentences = text.split('. ')
                translated_parts = []
                current_chunk = ""
                
                for sentence in sentences:
                    if len(current_chunk) + len(sentence) < max_chunk:
                        current_chunk += sentence + ". "
                    else:
                        if current_chunk:
                            translated_parts.append(translator.translate(current_chunk))
                        current_chunk = sentence + ". "
                
                if current_chunk:
                    translated_parts.append(translator.translate(current_chunk))
                
                translated = " ".join(translated_parts)
                print(f"[ENGLISH_FILTER] ‚úì –ë–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π")
                return translated
        except Exception as e:
            print(f"[ENGLISH_FILTER] ‚úó –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø–æ—Å–ª–æ–≤–Ω–æ–π –∑–∞–º–µ–Ω–æ–π
    
    # –†–ê–°–®–ò–†–ï–ù–ù–´–ô —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ (150+ —Å–ª–æ–≤)
    forbidden_words = {
        # –°–≤—è–∑–∫–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã
        'however', 'moreover', 'furthermore', 'therefore', 'thus', 'hence',
        'nevertheless', 'nonetheless', 'additionally', 'consequently',
        'accordingly', 'alternatively', 'conversely', 'likewise', 'similarly',
        'whereas', 'whereby', 'wherein', 'thereof', 'herein', 'hereby',
        
        # –ù–∞—Ä–µ—á–∏—è –∏ —É—Å–∏–ª–∏—Ç–µ–ª–∏
        'essentially', 'basically', 'actually', 'literally', 'specifically',
        'particularly', 'generally', 'typically', 'primarily', 'ultimately',
        'previously', 'currently', 'subsequently', 'recently', 'initially',
        'finally', 'eventually', 'gradually', 'immediately', 'directly',
        'completely', 'entirely', 'absolutely', 'exactly', 'precisely',
        
        # –ì–ª–∞–≥–æ–ª—ã
        'arrives', 'arrives', 'comes', 'goes', 'becomes', 'seems', 'appears',
        'remains', 'continues', 'begins', 'starts', 'ends', 'finishes',
        'provides', 'offers', 'includes', 'contains', 'requires', 'allows',
        'enables', 'creates', 'makes', 'takes', 'gives', 'shows', 'tells',
        'says', 'means', 'involves', 'concerns', 'affects', 'impacts',
        
        # –°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ
        'situation', 'condition', 'position', 'location', 'direction',
        'option', 'solution', 'problem', 'issue', 'matter', 'case',
        'example', 'instance', 'aspect', 'feature', 'element', 'factor',
        'process', 'method', 'approach', 'strategy', 'technique',
        'concept', 'idea', 'notion', 'theory', 'principle',
        
        # –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        'important', 'significant', 'essential', 'critical', 'crucial',
        'necessary', 'required', 'possible', 'available', 'suitable',
        'appropriate', 'relevant', 'related', 'similar', 'different',
        'various', 'several', 'multiple', 'numerous', 'certain',
        'specific', 'particular', 'general', 'common', 'usual',
        
        # –§—Ä–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        'note', 'worth', 'keep', 'mind', 'mentioned', 'stated', 
        'previously', 'summarize', 'conclusion', 'foremost',
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
        'also', 'just', 'even', 'still', 'yet', 'already', 'always',
        'never', 'sometimes', 'often', 'usually', 'rarely', 'seldom',
        'almost', 'nearly', 'quite', 'rather', 'pretty', 'fairly',
        'really', 'very', 'too', 'enough', 'much', 'many', 'more',
        'most', 'less', 'least', 'some', 'any', 'each', 'every',
        'all', 'both', 'either', 'neither', 'other', 'another',
        'such', 'same', 'different', 'various', 'several'
    }
    
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω
    replacements = {
        # –°–≤—è–∑–∫–∏
        'however': '–æ–¥–Ω–∞–∫–æ', 'moreover': '–±–æ–ª–µ–µ —Ç–æ–≥–æ', 'furthermore': '–∫—Ä–æ–º–µ —Ç–æ–≥–æ',
        'therefore': '–ø–æ—ç—Ç–æ–º—É', 'thus': '—Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º', 'hence': '—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ',
        'nevertheless': '—Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ', 'nonetheless': '—Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ',
        'additionally': '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ', 'consequently': '—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ',
        'accordingly': '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ', 'alternatively': '–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ',
        'conversely': '–Ω–∞–æ–±–æ—Ä–æ—Ç', 'likewise': '–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ', 'similarly': '–ø–æ–¥–æ–±–Ω–æ',
        'whereas': '—Ç–æ–≥–¥–∞ –∫–∞–∫', 'whereby': '–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —á–µ–≥–æ',
        
        # –ù–∞—Ä–µ—á–∏—è
        'essentially': '–ø–æ —Å—É—Ç–∏', 'basically': '–≤ –æ—Å–Ω–æ–≤–Ω–æ–º', 'actually': '—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏',
        'literally': '–±—É–∫–≤–∞–ª—å–Ω–æ', 'specifically': '–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ', 'particularly': '–æ—Å–æ–±–µ–Ω–Ω–æ',
        'generally': '–æ–±—ã—á–Ω–æ', 'typically': '–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ', 'primarily': '–≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å',
        'ultimately': '–≤ –∫–æ–Ω–µ—á–Ω–æ–º —Å—á—ë—Ç–µ', 'previously': '—Ä–∞–Ω–µ–µ', 'currently': '–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è',
        'subsequently': '–≤–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–∏', 'recently': '–Ω–µ–¥–∞–≤–Ω–æ', 'initially': '–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ',
        'finally': '–Ω–∞–∫–æ–Ω–µ—Ü', 'eventually': '–≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤', 'gradually': '–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ',
        'immediately': '–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ', 'directly': '–Ω–∞–ø—Ä—è–º—É—é', 'completely': '–ø–æ–ª–Ω–æ—Å—Ç—å—é',
        'entirely': '—Ü–µ–ª–∏–∫–æ–º', 'absolutely': '–∞–±—Å–æ–ª—é—Ç–Ω–æ', 'exactly': '—Ç–æ—á–Ω–æ',
        'precisely': '–∏–º–µ–Ω–Ω–æ',
        
        # –ì–ª–∞–≥–æ–ª—ã
        'arrives': '–ø—Ä–∏–±—ã–≤–∞–µ—Ç', 'comes': '–ø—Ä–∏—Ö–æ–¥–∏—Ç', 'goes': '–∏–¥—ë—Ç', 
        'becomes': '—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è', 'seems': '–∫–∞–∂–µ—Ç—Å—è', 'appears': '–ø–æ—è–≤–ª—è–µ—Ç—Å—è',
        'remains': '–æ—Å—Ç–∞—ë—Ç—Å—è', 'continues': '–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç', 'begins': '–Ω–∞—á–∏–Ω–∞–µ—Ç',
        'starts': '–Ω–∞—á–∏–Ω–∞–µ—Ç', 'ends': '–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç', 'finishes': '–∑–∞–≤–µ—Ä—à–∞–µ—Ç',
        'provides': '–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç', 'offers': '–ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç', 'includes': '–≤–∫–ª—é—á–∞–µ—Ç',
        'contains': '—Å–æ–¥–µ—Ä–∂–∏—Ç', 'requires': '—Ç—Ä–µ–±—É–µ—Ç', 'allows': '–ø–æ–∑–≤–æ–ª—è–µ—Ç',
        
        # –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        'important': '–≤–∞–∂–Ω—ã–π', 'significant': '–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π', 'essential': '—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π',
        'critical': '–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', 'crucial': '—Ä–µ—à–∞—é—â–∏–π', 'necessary': '–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π',
        'possible': '–≤–æ–∑–º–æ–∂–Ω—ã–π', 'available': '–¥–æ—Å—Ç—É–ø–Ω—ã–π', 'suitable': '–ø–æ–¥—Ö–æ–¥—è—â–∏–π',
        
        # –î—Ä—É–≥–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ
        'also': '—Ç–∞–∫–∂–µ', 'just': '–ø—Ä–æ—Å—Ç–æ', 'even': '–¥–∞–∂–µ', 'still': '–≤—Å—ë –µ—â—ë',
        'yet': '–µ—â—ë', 'already': '—É–∂–µ', 'always': '–≤—Å–µ–≥–¥–∞', 'never': '–Ω–∏–∫–æ–≥–¥–∞',
        'sometimes': '–∏–Ω–æ–≥–¥–∞', 'often': '—á–∞—Å—Ç–æ', 'usually': '–æ–±—ã—á–Ω–æ',
        'really': '–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ', 'very': '–æ—á–µ–Ω—å', 'much': '–º–Ω–æ–≥–æ', 'many': '–º–Ω–æ–≥–æ'
    }
    
    words = text.split()
    cleaned_words = []
    replaced_count = 0
    
    for word in words:
        # –û—á–∏—â–∞–µ–º –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        clean_word = ''.join(char for char in word if char.isalnum()).lower()
        
        if not clean_word:
            cleaned_words.append(word)
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã = –≤–æ–∑–º–æ–∂–Ω–æ –∏–º—è/–±—Ä–µ–Ω–¥)
        if word[0].isupper() and len(clean_word) > 1:
            # –í–µ—Ä–æ—è—Ç–Ω–æ –∏–º—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–ª–∏ –±—Ä–µ–Ω–¥ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            cleaned_words.append(word)
            continue
        
        if clean_word in forbidden_words:
            # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ä—É—Å—Å–∫–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç
            if clean_word in replacements:
                replacement = replacements[clean_word]
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
                for char in word:
                    if not char.isalnum():
                        replacement += char
                cleaned_words.append(replacement)
                replaced_count += 1
                print(f"[ENGLISH_FILTER] –ó–∞–º–µ–Ω–µ–Ω–æ: '{word}' ‚Üí '{replacement}'")
            else:
                # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ–≤–æ
                replaced_count += 1
                print(f"[ENGLISH_FILTER] –£–¥–∞–ª–µ–Ω–æ: '{word}'")
        else:
            cleaned_words.append(word)
    
    if replaced_count > 0:
        print(f"[ENGLISH_FILTER] ‚úì –ó–∞–º–µ–Ω–µ–Ω–æ/—É–¥–∞–ª–µ–Ω–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤: {replaced_count}")
    
    return ' '.join(cleaned_words)



def check_spelling_and_suggest(text: str, language: str = "russian") -> dict:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –≤ —Ç–µ–∫—Å—Ç–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏.
    
    Returns:
    {
        "has_errors": bool,
        "original": str,
        "suggested": str,
        "corrections": list of tuples (wrong_word, suggested_word)
    }
    """
    try:
        from spellchecker import SpellChecker
        
        if language == "russian":
            spell = SpellChecker(language='ru')
        else:
            spell = SpellChecker(language='en')
        
        words = text.split()
        corrections = []
        corrected_words = []
        
        for word in words:
            # –û—á–∏—â–∞–µ–º —Å–ª–æ–≤–æ –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            clean_word = ''.join(char for char in word if char.isalnum())
            
            if not clean_word:
                corrected_words.append(word)
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é
            if clean_word.lower() in spell:
                corrected_words.append(word)
            else:
                # –°–ª–æ–≤–æ —Å –æ—à–∏–±–∫–æ–π - –∏—â–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                correction = spell.correction(clean_word.lower())
                if correction and correction != clean_word.lower():
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
                    if clean_word[0].isupper():
                        correction = correction.capitalize()
                    
                    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
                    corrected_word = word.replace(clean_word, correction)
                    corrected_words.append(corrected_word)
                    corrections.append((clean_word, correction))
                    print(f"[SPELL_CHECK] –ù–∞–π–¥–µ–Ω–∞ –æ—à–∏–±–∫–∞: '{clean_word}' -> '{correction}'")
                else:
                    corrected_words.append(word)
        
        suggested_text = ' '.join(corrected_words)
        
        return {
            "has_errors": len(corrections) > 0,
            "original": text,
            "suggested": suggested_text,
            "corrections": corrections
        }
        
    except ImportError:
        print("[SPELL_CHECK] pyspellchecker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pyspellchecker")
        return {
            "has_errors": False,
            "original": text,
            "suggested": text,
            "corrections": []
        }
    except Exception as e:
        print(f"[SPELL_CHECK] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏: {e}")
        return {
            "has_errors": False,
            "original": text,
            "suggested": text,
            "corrections": []
        }


# -------------------------
# DuckDuckGo Search helper (named google_search for compatibility)
# -------------------------
def translate_to_russian(text: str) -> str:
    """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π, —Å–æ—Ö—Ä–∞–Ω—è—è –∏–º–µ–Ω–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è"""
    try:
        print(f"[TRANSLATOR] –ù–∞—á–∏–Ω–∞—é –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞...")
        print(f"[TRANSLATOR] –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π API –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        from deep_translator import GoogleTranslator
        
        translator = GoogleTranslator(source='en', target='ru')
        
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ —á–∞—Å—Ç—è–º, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±–æ–ª—å—à–æ–π
        max_chunk = 4500
        if len(text) <= max_chunk:
            translated = translator.translate(text)
        else:
            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
            sentences = text.split('. ')
            translated_parts = []
            current_chunk = ""
            
            for sentence in sentences:
                if len(current_chunk) + len(sentence) < max_chunk:
                    current_chunk += sentence + ". "
                else:
                    if current_chunk:
                        translated_parts.append(translator.translate(current_chunk))
                    current_chunk = sentence + ". "
            
            if current_chunk:
                translated_parts.append(translator.translate(current_chunk))
            
            translated = " ".join(translated_parts)
        
        print(f"[TRANSLATOR] –ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ")
        return translated
        
    except ImportError:
        print("[TRANSLATOR] deep-translator –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install deep-translator")
        return text
    except Exception as e:
        print(f"[TRANSLATOR] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {e}")
        return text

def analyze_query_type(query: str, language: str) -> dict:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é + —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        'category': str,  # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–∞
        'domains': list,  # –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã (–ø—É—Å—Ç–æ–π = –≤—Å–µ)
        'keywords': list  # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
    }
    """
    query_lower = query.lower()
    
    # üå¶ –ü–û–ì–û–î–ê
    weather_keywords_ru = ['–ø–æ–≥–æ–¥–∞', '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', '–≥—Ä–∞–¥—É—Å', '–ø—Ä–æ–≥–Ω–æ–∑', '–æ—Å–∞–¥–∫–∏', '–¥–æ–∂–¥', '—Å–Ω–µ–≥', '–≤–µ—Ç–µ—Ä', '–∫–ª–∏–º–∞—Ç', '–º–æ—Ä–æ–∑', '–∂–∞—Ä–∞', '—Å–æ–ª–Ω–µ—á–Ω–æ', '–æ–±–ª–∞—á–Ω–æ']
    weather_keywords_en = ['weather', 'temperature', 'forecast', 'rain', 'snow', 'wind', 'climate', 'sunny', 'cloudy']
    
    if language == "russian":
        if any(kw in query_lower for kw in weather_keywords_ru):
            return {
                'category': 'üå¶ –ü–æ–≥–æ–¥–∞',
                'domains': ['weather', 'meteo', 'gismeteo', '–ø–æ–≥–æ–¥–∞', 'yandex.ru/pogoda'],
                'keywords': ['–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã', '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', '–º–µ—Ç–µ–æ—Å–µ—Ä–≤–∏—Å']
            }
    else:
        if any(kw in query_lower for kw in weather_keywords_en):
            return {
                'category': 'üå¶ Weather',
                'domains': ['weather.com', 'accuweather', 'weatherapi', 'meteo'],
                'keywords': ['weather forecast', 'temperature']
            }
    
    # üì± –¢–ï–•–ù–ò–ö–ê / –ì–ê–î–ñ–ï–¢–´
    tech_keywords_ru = ['—Ç–µ–ª–µ—Ñ–æ–Ω', '—Å–º–∞—Ä—Ç—Ñ–æ–Ω', '–∫–æ–º–ø—å—é—Ç–µ—Ä', '–Ω–æ—É—Ç–±—É–∫', '–ø–ª–∞–Ω—à–µ—Ç', '–∞–π—Ñ–æ–Ω', 'iphone', 'samsung', '—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫', '—Å—Ä–∞–≤–Ω–∏', '–ª—É—á—à–µ', '–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä', '–ø–∞–º—è—Ç—å', '—ç–∫—Ä–∞–Ω', '–∫–∞–º–µ—Ä–∞', '–±–∞—Ç–∞—Ä–µ—è', '–≥–∞–¥–∂–µ—Ç']
    tech_keywords_en = ['phone', 'smartphone', 'computer', 'laptop', 'tablet', 'iphone', 'samsung', 'specs', 'compare', 'better', 'processor', 'memory', 'screen', 'camera', 'battery', 'gadget']
    
    if language == "russian":
        if any(kw in query_lower for kw in tech_keywords_ru):
            return {
                'category': 'üì± –¢–µ—Ö–Ω–∏–∫–∞',
                'domains': ['ixbt', 'overclockers', 'dns-shop', 'citilink', 'mobile-review', 'tech', 'gadget'],
                'keywords': ['–æ–±–∑–æ—Ä', '—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', '—Ç–µ—Å—Ç', '—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ']
            }
    else:
        if any(kw in query_lower for kw in tech_keywords_en):
            return {
                'category': 'üì± Tech',
                'domains': ['gsmarena', 'techradar', 'cnet', 'anandtech', 'tomshardware', 'tech', 'review'],
                'keywords': ['review', 'specs', 'comparison', 'test']
            }
    
    # üç≥ –ö–£–õ–ò–ù–ê–†–ò–Ø
    cooking_keywords_ru = ['—Ä–µ—Ü–µ–ø—Ç', '–ø—Ä–∏–≥–æ—Ç–æ–≤', '–≥–æ—Ç–æ–≤', '–±–ª—é–¥–æ', '–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', '–≤—ã–ø–µ–∫–∞', '–≤–∞—Ä–∏—Ç—å', '–∂–∞—Ä–∏—Ç—å', '–∑–∞–ø–µ–∫–∞', '–∫—É—Ö–Ω—è', '—Å–∞–ª–∞—Ç', '—Å—É–ø', '–¥–µ—Å–µ—Ä—Ç', '—Ç–æ—Ä—Ç']
    cooking_keywords_en = ['recipe', 'cook', 'dish', 'ingredient', 'bake', 'fry', 'roast', 'kitchen', 'salad', 'soup', 'dessert', 'cake']
    
    if language == "russian":
        if any(kw in query_lower for kw in cooking_keywords_ru):
            return {
                'category': 'üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è',
                'domains': ['russianfood', 'edimdoma', 'povar', 'gastronom', 'recipe', '—Ä–µ—Ü–µ–ø—Ç'],
                'keywords': ['—Ä–µ—Ü–µ–ø—Ç —Å —Ñ–æ—Ç–æ', '–∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å', '–ø–æ—à–∞–≥–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç']
            }
    else:
        if any(kw in query_lower for kw in cooking_keywords_en):
            return {
                'category': 'üç≥ Cooking',
                'domains': ['allrecipes', 'foodnetwork', 'epicurious', 'recipe', 'cooking'],
                'keywords': ['recipe with photos', 'how to cook', 'step by step']
            }
    
    # üß† –û–ë–£–ß–ï–ù–ò–ï / –û–ë–™–Ø–°–ù–ï–ù–ò–ï
    learning_keywords_ru = ['—á—Ç–æ —Ç–∞–∫–æ–µ', '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–æ–±—ä—è—Å–Ω–∏', '—Ä–∞—Å—Å–∫–∞–∂–∏', '—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è', '–∑–∞—á–µ–º', '–ø–æ—á–µ–º—É', '–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '–∑–Ω–∞—á–µ–Ω–∏–µ']
    learning_keywords_en = ['what is', 'how does', 'explain', 'tell me', 'difference', 'why', 'definition', 'meaning']
    
    if language == "russian":
        if any(kw in query_lower for kw in learning_keywords_ru):
            return {
                'category': 'üß† –û–±—É—á–µ–Ω–∏–µ',
                'domains': ['wikipedia', 'wiki', 'habr', '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '—É—á–µ–±–Ω—ã–π'],
                'keywords': ['–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ', '—á—Ç–æ —ç—Ç–æ']
            }
    else:
        if any(kw in query_lower for kw in learning_keywords_en):
            return {
                'category': 'üß† Learning',
                'domains': ['wikipedia', 'wiki', 'education', 'tutorial'],
                'keywords': ['definition', 'explanation', 'what is']
            }
    
    # ‚öô –ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï
    programming_keywords = ['–∫–æ–¥', '–ø—Ä–æ–≥—Ä–∞–º–º', 'python', 'javascript', 'java', 'c++', 'html', 'css', 'api', '—Ñ—É–Ω–∫—Ü–∏—è', '–º–µ—Ç–æ–¥', '–∫–ª–∞—Å—Å', 'error', 'bug', 'github', 'stackoverflow', 'code', 'script']
    
    if any(kw in query_lower for kw in programming_keywords):
        return {
            'category': '‚öô –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
            'domains': ['stackoverflow', 'github', 'habr', 'docs', 'documentation', 'developer'],
            'keywords': ['documentation', 'example', 'tutorial', 'code']
        }
    
    # üì∞ –ù–û–í–û–°–¢–ò / –°–û–ë–´–¢–ò–Ø
    news_keywords_ru = ['–Ω–æ–≤–æ—Å—Ç', '—Å–æ–±—ã—Ç', '—Å–µ–≥–æ–¥–Ω—è', '–≤—á–µ—Ä–∞', '–ø—Ä–æ–∏–∑–æ—à–ª–æ', '—Å–ª—É—á–∏–ª–æ—Å—å']
    news_keywords_en = ['news', 'event', 'today', 'yesterday', 'happened', 'occurred']
    
    if language == "russian":
        if any(kw in query_lower for kw in news_keywords_ru):
            return {
                'category': 'üì∞ –ù–æ–≤–æ—Å—Ç–∏',
                'domains': ['news', '–Ω–æ–≤–æ—Å—Ç–∏', 'lenta', 'tass', 'ria', 'rbc'],
                'keywords': ['–Ω–æ–≤–æ—Å—Ç–∏', '—Å–æ–±—ã—Ç–∏–µ', '–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏']
            }
    else:
        if any(kw in query_lower for kw in news_keywords_en):
            return {
                'category': 'üì∞ News',
                'domains': ['news', 'bbc', 'cnn', 'reuters', 'nytimes'],
                'keywords': ['latest news', 'breaking news', 'event']
            }
    
    # ‚ùì –û–ë–©–ò–ô –í–û–ü–†–û–° (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    return {
        'category': '‚ùì –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å',
        'domains': [],  # –ü–æ–∏—Å–∫ –≤–µ–∑–¥–µ
        'keywords': []
    }

def google_search(query: str, num_results: int = 5, region: str = "wt-wt", language: str = "russian"):
    """–ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ DuckDuckGo API (ddgs) —Å —É–º–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ç–∏–ø—É –∑–∞–ø—Ä–æ—Å–∞"""
    print(f"[DUCKDUCKGO_SEARCH] –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...")
    print(f"[DUCKDUCKGO_SEARCH] –ó–∞–ø—Ä–æ—Å: {query}")
    print(f"[DUCKDUCKGO_SEARCH] –†–µ–≥–∏–æ–Ω: {region}")
    print(f"[DUCKDUCKGO_SEARCH] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {num_results}")
    
    # üîç –ê–ù–ê–õ–ò–ó –¢–ò–ü–ê –ó–ê–ü–†–û–°–ê
    query_analysis = analyze_query_type(query, language)
    print(f"[DUCKDUCKGO_SEARCH] üìä –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–∞: {query_analysis['category']}")
    print(f"[DUCKDUCKGO_SEARCH] üéØ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã: {query_analysis['domains']}")
    
    # –£–ª—É—á—à–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    enhanced_query = query
    if query_analysis['keywords']:
        enhanced_query = f"{query} {' '.join(query_analysis['keywords'][:2])}"
        print(f"[DUCKDUCKGO_SEARCH] ‚ú® –£–ª—É—á—à–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {enhanced_query}")

    try:
        # ddgs is optional dependency: pip install ddgs
        from ddgs import DDGS

        print(f"[DUCKDUCKGO_SEARCH] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...")
        with DDGS() as ddgs:
            # –ü–æ–ª—É—á–∞–µ–º –±–æ–ª—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            raw_results = list(ddgs.text(enhanced_query, region=region, max_results=num_results * 3))

        print(f"[DUCKDUCKGO_SEARCH] –ü–æ–ª—É—á–µ–Ω–æ —Å—ã—Ä—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(raw_results)}")
        
        # üéØ –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –†–ï–õ–ï–í–ê–ù–¢–ù–´–ú –î–û–ú–ï–ù–ê–ú
        filtered_results = []
        if query_analysis['domains']:
            print(f"[DUCKDUCKGO_SEARCH] üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –¥–æ–º–µ–Ω–∞–º...")
            for result in raw_results:
                link = result.get('href', '').lower()
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å—Å—ã–ª–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –¥–æ–º–µ–Ω
                if any(domain in link for domain in query_analysis['domains']):
                    filtered_results.append(result)
                    if len(filtered_results) >= num_results:
                        break
            
            print(f"[DUCKDUCKGO_SEARCH] ‚úÖ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(filtered_results)}")
            
            # –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –±–µ—Ä—ë–º –∏–∑ –≤—Å–µ—Ö
            if len(filtered_results) < max(2, num_results // 2):
                print(f"[DUCKDUCKGO_SEARCH] ‚ö†Ô∏è –ú–∞–ª–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ...")
                filtered_results = raw_results[:num_results]
        else:
            # –î–ª—è –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ—Ä—ë–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            filtered_results = raw_results[:num_results]
        
        results = filtered_results

        if not results:
            print(f"[DUCKDUCKGO_SEARCH] –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞")
            return "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."

        search_results = []
        for i, result in enumerate(results, 1):
            title = result.get('title', '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞')
            body = result.get('body', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')
            link = result.get('href', '')
            search_results.append(f"[–†–µ–∑—É–ª—å—Ç–∞—Ç {i}]\n–ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}\n–û–ø–∏—Å–∞–Ω–∏–µ: {body}\n–°—Å—ã–ª–∫–∞: {link}")
            print(f"[DUCKDUCKGO_SEARCH] –†–µ–∑—É–ª—å—Ç–∞—Ç {i}: {title[:50]}...")

        final_results = "\n\n".join(search_results)
        print(f"[DUCKDUCKGO_SEARCH] –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ. –î–ª–∏–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(final_results)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"[DUCKDUCKGO_SEARCH] üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∫–∞—Ç–µ–≥–æ—Ä–∏—è={query_analysis['category']}, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤={len(results)}")
        return final_results

    except ImportError:
        # FALLBACK: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤–µ–±-—Å–∫—Ä–µ–π–ø–∏–Ω–≥ DuckDuckGo HTML
        print(f"[DUCKDUCKGO_SEARCH] ‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ddgs –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback...")
        try:
            return fallback_web_search(enhanced_query, num_results, language)
        except Exception as fallback_error:
            error_msg = f"‚ö†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É ddgs: pip install ddgs\n–û—à–∏–±–∫–∞ fallback: {fallback_error}"
            print(f"[DUCKDUCKGO_SEARCH] {error_msg}")
            return error_msg
    except Exception as e:
        error_msg = f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}"
        print(f"[DUCKDUCKGO_SEARCH] {error_msg}")
        return error_msg

def fallback_web_search(query: str, num_results: int = 5, language: str = "russian") -> str:
    """Fallback –≤–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ DuckDuckGo HTML –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫"""
    print(f"[FALLBACK_SEARCH] –ó–∞–ø—É—Å–∫ fallback –ø–æ–∏—Å–∫–∞ –¥–ª—è: {query}")
    
    try:
        import urllib.parse
        import re
        from html import unescape
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è DuckDuckGo
        encoded_query = urllib.parse.quote_plus(query)
        search_url = f"https://html.duckduckgo.com/html/?q={encoded_query}"
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7' if language == "russian" else 'en-US,en;q=0.9',
            'Accept-Encoding': 'gzip, deflate',
            'DNT': '1',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1'
        }
        
        print(f"[FALLBACK_SEARCH] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ DuckDuckGo...")
        response = requests.get(search_url, headers=headers, timeout=10)
        response.raise_for_status()
        
        html_content = response.text
        print(f"[FALLBACK_SEARCH] –ü–æ–ª—É—á–µ–Ω HTML, –¥–ª–∏–Ω–∞: {len(html_content)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        # DuckDuckGo HTML –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: <div class="result">
        
        # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        title_pattern = r'<a[^>]*class="result__a"[^>]*>([^<]+)</a>'
        titles = re.findall(title_pattern, html_content)
        
        # –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏—è
        snippet_pattern = r'<a[^>]*class="result__snippet"[^>]*>([^<]+)</a>'
        snippets = re.findall(snippet_pattern, html_content)
        
        # –ò—â–µ–º —Å—Å—ã–ª–∫–∏
        url_pattern = r'<a[^>]*class="result__url"[^>]*href="([^"]+)"'
        urls = re.findall(url_pattern, html_content)
        
        # –ï—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π
        if not titles:
            print(f"[FALLBACK_SEARCH] –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π...")
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ DuckDuckGo
            title_pattern = r'class="result__title"[^>]*><a[^>]*>(.+?)</a>'
            titles = re.findall(title_pattern, html_content, re.DOTALL)
            
            snippet_pattern = r'class="result__snippet">(.+?)</div>'
            snippets = re.findall(snippet_pattern, html_content, re.DOTALL)
        
        print(f"[FALLBACK_SEARCH] –ù–∞–π–¥–µ–Ω–æ: –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤={len(titles)}, –æ–ø–∏—Å–∞–Ω–∏–π={len(snippets)}, —Å—Å—ã–ª–æ–∫={len(urls)}")
        
        if not titles and not snippets:
            print(f"[FALLBACK_SEARCH] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –í–æ–∑–º–æ–∂–Ω–æ, –∏–∑–º–µ–Ω–∏–ª—Å—è —Ñ–æ—Ä–º–∞—Ç DuckDuckGo.")
            return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É: pip install ddgs"
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        search_results = []
        for i in range(min(num_results, len(titles))):
            title = unescape(re.sub(r'<[^>]+>', '', titles[i])).strip() if i < len(titles) else "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"
            snippet = unescape(re.sub(r'<[^>]+>', '', snippets[i])).strip() if i < len(snippets) else "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"
            url = urls[i] if i < len(urls) else ""
            
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL –µ—Å–ª–∏ –æ–Ω –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω
            if url.startswith('//duckduckgo.com/l/?'):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π URL –∏–∑ redirect
                url_match = re.search(r'uddg=([^&]+)', url)
                if url_match:
                    url = urllib.parse.unquote(url_match.group(1))
            
            search_results.append(
                f"[–†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}]\n"
                f"–ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {snippet}\n"
                f"–°—Å—ã–ª–∫–∞: {url}"
            )
            print(f"[FALLBACK_SEARCH] –†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: {title[:50]}...")
        
        if not search_results:
            return "‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å."
        
        final_results = "\n\n".join(search_results)
        print(f"[FALLBACK_SEARCH] ‚úì Fallback –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –ù–∞–π–¥–µ–Ω–æ {len(search_results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
        return final_results
        
    except requests.Timeout:
        return "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    except requests.RequestException as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}"
    except Exception as e:
        print(f"[FALLBACK_SEARCH] ‚úó –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ fallback –ø–æ–∏—Å–∫–∞: {e}"

# -------------------------
# TTS —Å pyttsx3
# -------------------------
def compress_search_results(search_results: str, max_length: int) -> str:
    """–°–∂–∏–º–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ"""
    print(f"[COMPRESS] –ù–∞—á–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {len(search_results)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"[COMPRESS] –¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞: {max_length} —Å–∏–º–≤–æ–ª–æ–≤")
    
    if len(search_results) <= max_length:
        print(f"[COMPRESS] –°–∂–∞—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        return search_results
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    results = search_results.split('[–†–µ–∑—É–ª—å—Ç–∞—Ç ')
    if len(results) <= 1:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∏—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º
        print(f"[COMPRESS] –ü—Ä–æ—Å—Ç–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –¥–æ {max_length} —Å–∏–º–≤–æ–ª–æ–≤")
        return search_results[:max_length] + "..."
    
    # –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç - –ø—É—Å—Ç–æ–π, —É–±–∏—Ä–∞–µ–º
    results = results[1:]
    
    # –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    chars_per_result = max_length // len(results)
    print(f"[COMPRESS] –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(results)}, —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {chars_per_result}")
    
    compressed_results = []
    for i, result in enumerate(results, 1):
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        result = '[–†–µ–∑—É–ª—å—Ç–∞—Ç ' + result
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏
        lines = result.split('\n')
        title_line = ""
        description_line = ""
        link_line = ""
        
        for line in lines:
            if line.startswith('–ó–∞–≥–æ–ª–æ–≤–æ–∫:'):
                title_line = line
            elif line.startswith('–û–ø–∏—Å–∞–Ω–∏–µ:'):
                description_line = line
            elif line.startswith('–°—Å—ã–ª–∫–∞:'):
                link_line = line
        
        # –°–∂–∏–º–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if description_line:
            desc_prefix = "–û–ø–∏—Å–∞–Ω–∏–µ: "
            desc_text = description_line[len(desc_prefix):]
            
            # –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å—Å—ã–ª–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)
            available_for_desc = chars_per_result - 200
            if available_for_desc < 100:
                available_for_desc = 100
            
            if len(desc_text) > available_for_desc:
                desc_text = desc_text[:available_for_desc] + "..."
                description_line = desc_prefix + desc_text
        
        # –°–æ–±–∏—Ä–∞–µ–º —Å–∂–∞—Ç—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        compressed = f"[–†–µ–∑—É–ª—å—Ç–∞—Ç {i}]\n{title_line}\n{description_line}\n{link_line}"
        compressed_results.append(compressed)
    
    final_result = "\n\n".join(compressed_results)
    print(f"[COMPRESS] –ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏–Ω–∞: {len(final_result)} —Å–∏–º–≤–æ–ª–æ–≤")
    
    return final_result


def build_contextual_search_query(user_message: str, chat_manager, chat_id: int, detected_language: str) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.
    
    –õ–æ–≥–∏–∫–∞:
    1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å —É—Ç–æ—á–Ω—è—é—â–∏–º (–∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏)
    2. –ï—Å–ª–∏ —É—Ç–æ—á–Ω—è—é—â–∏–π - –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    3. –ï—Å–ª–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
    """
    print(f"[CONTEXTUAL_SEARCH] –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–æ–ø—Ä–æ—Å...")
    print(f"[CONTEXTUAL_SEARCH] –í–æ–ø—Ä–æ—Å: {user_message}")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if chat_manager and chat_id:
        history = chat_manager.get_chat_messages(chat_id, limit=10)
    else:
        # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ë–î
        import sqlite3
        conn = sqlite3.connect("chat_memory.db")
        cur = conn.cursor()
        cur.execute("SELECT role, content, created_at FROM messages ORDER BY id DESC LIMIT 10")
        history = list(reversed(cur.fetchall()))
        conn.close()
    
    if not history or len(history) < 2:
        print(f"[CONTEXTUAL_SEARCH] –ò—Å—Ç–æ—Ä–∏—è –∫–æ—Ä–æ—Ç–∫–∞—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å")
        return user_message
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    clarifying_keywords_ru = [
        '–∞ –ø–æ—á–µ–º—É', '–∞ –∫–∞–∫', '–∞ –≥–¥–µ', '–∞ –∫–æ–≥–¥–∞', '–∞ —á—Ç–æ', '–∞ –∫—Ç–æ', '–∞ –ø–æ—Å–ª–µ', '–∞ –∑–∞–≤—Ç—Ä–∞', '–∞ –≤—á–µ—Ä–∞', '–∞ —Å–µ–≥–æ–¥–Ω—è',
        '–ø–æ—á–µ–º—É', '–∫–∞–∫ –∏–º–µ–Ω–Ω–æ', '—á—Ç–æ –∏–º–µ–Ω–Ω–æ', '–∫–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ', '–≥–¥–µ –∏–º–µ–Ω–Ω–æ',
        '—Ä–∞—Å—Å–∫–∞–∂–∏', '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–µ—â—ë', '–µ—â–µ', '—Ç–æ–∂–µ', '—Ç–∞–∫–∂–µ', '–¥–∞–ª—å—à–µ',
        '–µ–≥–æ', '–µ—ë', '–∏—Ö', '—ç—Ç–æ–≥–æ', '—ç—Ç–æ–π', '—ç—Ç–∏–º', '—ç—Ç–æ—Ç', '—ç—Ç–∞', '—ç—Ç–æ',
        '—Ç–æ–≥–¥–∞', '–ø–æ—Ç–æ–º', '–ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ', '—á—Ç–æ –¥–∞–ª—å—à–µ',
        '–∑–∞–≤—Ç—Ä–∞', '–≤—á–µ—Ä–∞', '—Å–µ–≥–æ–¥–Ω—è', '–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞'  # –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
    ]
    
    clarifying_keywords_en = [
        'and why', 'and how', 'and where', 'and when', 'and what', 'and who',
        'why', 'how exactly', 'what exactly', 'when exactly', 'where exactly',
        'tell me', 'more', 'also', 'too', 'then', 'after', 'next',
        'it', 'its', 'their', 'this', 'that', 'those', 'these',
        'tomorrow', 'yesterday', 'today'  # Temporal words
    ]
    
    keywords = clarifying_keywords_ru if detected_language == "russian" else clarifying_keywords_en
    
    user_lower = user_message.lower().strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –≤–æ–ø—Ä–æ—Å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è
    has_clarifying_words = any(keyword in user_lower for keyword in keywords)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –û–ß–ï–ù–¨ –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å (–º–µ–Ω–µ–µ 6 —Å–ª–æ–≤) - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ
    is_very_short = len(user_message.split()) < 6
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    starts_with_question = any(user_lower.startswith(q) for q in ['–ø–æ—á–µ–º—É', '–∫–∞–∫', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–∑–∞—á–µ–º', 'why', 'how', 'where', 'when'])
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–∞ " - –í–°–ï–ì–î–ê —É—Ç–æ—á–Ω–µ–Ω–∏–µ
    starts_with_a = user_lower.startswith('–∞ ') or user_lower.startswith('and ')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ (–∑–∞–≤—Ç—Ä–∞, –≤—á–µ—Ä–∞, —Å–µ–≥–æ–¥–Ω—è)
    is_temporal_only = user_lower in ['–∑–∞–≤—Ç—Ä–∞', '–≤—á–µ—Ä–∞', '—Å–µ–≥–æ–¥–Ω—è', '–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞', 'tomorrow', 'yesterday', 'today']
    
    # –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: —Å—á–∏—Ç–∞–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–º –µ—Å–ª–∏:
    # - –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ò–õ–ò
    # - –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –ò–õ–ò
    # - –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–∞ " –ò–õ–ò
    # - —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
    is_clarifying = has_clarifying_words or is_very_short or starts_with_a or is_temporal_only
    
    if is_clarifying:
        print(f"[CONTEXTUAL_SEARCH] ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω –£–¢–û–ß–ù–Ø–Æ–©–ò–ô –≤–æ–ø—Ä–æ—Å")
        print(f"[CONTEXTUAL_SEARCH]    - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {has_clarifying_words}")
        print(f"[CONTEXTUAL_SEARCH]    - –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π (<6 —Å–ª–æ–≤): {is_very_short}")
        print(f"[CONTEXTUAL_SEARCH]    - –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '–∞': {starts_with_a}")
        print(f"[CONTEXTUAL_SEARCH]    - –¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: {is_temporal_only}")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context_parts = []
        
        for i in range(len(history) - 1, -1, -1):
            role, content, _ = history[i]
            
            # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ —Ç–µ–∫—É—â–∏–π)
            if role == "user" and content != user_message:
                context_parts.insert(0, content)
                print(f"[CONTEXTUAL_SEARCH]    –ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å: {content[:50]}...")
                break
        
        if context_parts:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            main_context = context_parts[0]
            
            # –£–ú–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –£–¢–û–ß–ù–Ø–Æ–©–ò–• –í–û–ü–†–û–°–û–í
            user_lower = user_message.lower().strip()
            
            # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–∞ –≤/–∞ –Ω–∞" - —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞
            # –ü—Ä–∏–º–µ—Ä: "–ø–æ–≥–æ–¥–∞ –≤ –ü–∏—Ç–µ—Ä–µ" + "–∞ –≤ –ú—ã—Ç–∏—â–∞—Ö" ‚Üí "–ø–æ–≥–æ–¥–∞ –≤ –ú—ã—Ç–∏—â–∞—Ö"
            if detected_language == "russian":
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Å—Ç–∞
                location_change_patterns = [
                    ('–∞ –≤ ', '–≤ '),
                    ('–∞ –Ω–∞ ', '–Ω–∞ '),
                    ('–∞ –¥–ª—è ', '–¥–ª—è ')
                ]
                
                for pattern, replacement in location_change_patterns:
                    if user_lower.startswith(pattern):
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ
                        new_location_part = user_message[len(pattern):]
                        
                        # –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –Ω–æ–≤–æ–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
                        # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ "–≤ [–≥–æ—Ä–æ–¥]", "–Ω–∞ [–º–µ—Å—Ç–æ]"
                        import re
                        # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–≥–∞ + –º–µ—Å—Ç–æ
                        for prep in ['–≤ ', '–Ω–∞ ', '–¥–ª—è ']:
                            pattern_to_replace = prep + r'\S+'
                            if re.search(pattern_to_replace, main_context.lower()):
                                contextual_query = re.sub(
                                    pattern_to_replace,
                                    replacement + new_location_part,
                                    main_context,
                                    count=1,
                                    flags=re.IGNORECASE
                                )
                                print(f"[CONTEXTUAL_SEARCH] üîÑ –ó–∞–º–µ–Ω–µ–Ω–æ –º–µ—Å—Ç–æ: '{main_context}' ‚Üí '{contextual_query}'")
                                return contextual_query
                        
                        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ –≤ –∫–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                        contextual_query = main_context.replace(main_context.split()[-1], new_location_part)
                        print(f"[CONTEXTUAL_SEARCH] üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ –º–µ—Å—Ç–æ (fallback): '{contextual_query}'")
                        return contextual_query
            
            else:
                # –î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
                location_change_patterns = [
                    ('and in ', 'in '),
                    ('and at ', 'at '),
                    ('and for ', 'for ')
                ]
                
                for pattern, replacement in location_change_patterns:
                    if user_lower.startswith(pattern):
                        new_location_part = user_message[len(pattern):]
                        
                        import re
                        for prep in ['in ', 'at ', 'for ']:
                            pattern_to_replace = prep + r'\S+'
                            if re.search(pattern_to_replace, main_context.lower()):
                                contextual_query = re.sub(
                                    pattern_to_replace,
                                    replacement + new_location_part,
                                    main_context,
                                    count=1,
                                    flags=re.IGNORECASE
                                )
                                print(f"[CONTEXTUAL_SEARCH] üîÑ Replaced location: '{main_context}' ‚Üí '{contextual_query}'")
                                return contextual_query
                        
                        contextual_query = main_context.replace(main_context.split()[-1], new_location_part)
                        print(f"[CONTEXTUAL_SEARCH] üîÑ Changed location (fallback): '{contextual_query}'")
                        return contextual_query
            
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —É—Ç–æ—á–Ω–µ–Ω–∏–π
            # –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º: "–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞" + "—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å"
            contextual_query = f"{main_context} {user_message}"
            
            print(f"[CONTEXTUAL_SEARCH] ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {contextual_query[:100]}...")
            return contextual_query
        else:
            print(f"[CONTEXTUAL_SEARCH] ‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å")
            return user_message
    else:
        print(f"[CONTEXTUAL_SEARCH] ‚ÑπÔ∏è  –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        return user_message

# –û–∑–≤—É—á–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞



def init_db():
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS messages (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        role TEXT,
        content TEXT,
        created_at TEXT)
    """)
    conn.commit()
    conn.close()

def save_message(role: str, content: str):
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()
    cur.execute("INSERT INTO messages (role, content, created_at) VALUES (?, ?, ?)",
                (role, content, datetime.utcnow().isoformat()))
    conn.commit()
    conn.close()

def load_history(limit=MAX_HISTORY_LOAD):
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()
    cur.execute("SELECT role, content, created_at FROM messages ORDER BY id DESC LIMIT ?", (limit,))
    rows = cur.fetchall()
    conn.close()
    return list(reversed(rows))

def clear_messages():
    conn = sqlite3.connect(DB_FILE)
    cur = conn.cursor()
    cur.execute("DELETE FROM messages")
    conn.commit()
    conn.close()

# -------------------------
# Model-call helpers
# -------------------------
def call_ollama_chat(messages: list, max_tokens: int = 800, timeout=60):
    """–í—ã–∑–æ–≤ Ollama —á–µ—Ä–µ–∑ chat API —Å retry –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö"""
    url = f"{OLLAMA_HOST}/api/chat"
    headers = {"Content-Type": "application/json"}
    payload = {
        "model": OLLAMA_MODEL,
        "messages": messages,
        "stream": False,
        "options": {
            "num_predict": max_tokens
        }
    }
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Å retry –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤
    max_retries = 2
    for attempt in range(max_retries):
        try:
            print(f"[OLLAMA] –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å timeout={timeout}s, max_tokens={max_tokens}")
            r = requests.post(url, headers=headers, json=payload, timeout=timeout)
            r.raise_for_status()
            j = r.json()
            
            if "message" in j and "content" in j["message"]:
                response = j["message"]["content"].strip()
                print(f"[OLLAMA] ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç, –¥–ª–∏–Ω–∞: {len(response)}")
                return response
            
            print(f"[OLLAMA] ‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: {j}")
            # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π, –Ω–æ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            if attempt < max_retries - 1:
                print(f"[OLLAMA] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...")
                import time
                time.sleep(1)
                continue
            return str(j)
            
        except requests.exceptions.Timeout:
            error = f"[Ollama timeout] –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è {timeout}s"
            print(f"[OLLAMA] ‚è±Ô∏è {error}")
            if attempt < max_retries - 1:
                print(f"[OLLAMA] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                continue
            return error
            
        except requests.exceptions.ConnectionError as e:
            error = f"[Ollama connection error] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ollama –Ω–∞ {OLLAMA_HOST}"
            print(f"[OLLAMA] üîå {error}: {e}")
            if attempt < max_retries - 1:
                print(f"[OLLAMA] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                import time
                time.sleep(1)
                continue
            return error
            
        except requests.exceptions.HTTPError as e:
            error = f"[Ollama error] HTTP –æ—à–∏–±–∫–∞: {e}"
            print(f"[OLLAMA] ‚ùå {error}")
            # HTTP –æ—à–∏–±–∫–∏ –æ–±—ã—á–Ω–æ –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–µ retry
            return error
            
        except Exception as e:
            error = f"[Ollama error] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}"
            print(f"[OLLAMA] ‚ùå {error}")
            if attempt < max_retries - 1:
                print(f"[OLLAMA] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                import time
                time.sleep(1)
                continue
            return error
    
    # –ù–µ –¥–æ–ª–∂–Ω—ã —Å—é–¥–∞ –ø–æ–ø–∞—Å—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    return "[Ollama error] –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã"


def get_ai_response(user_message: str, current_language: str, deep_thinking: bool, use_search: bool, should_forget: bool = False, chat_manager=None, chat_id=None, file_path: str = None, ai_mode: str = AI_MODE_FAST):
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI (—Å –∂—ë—Å—Ç–∫–∏–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º —è–∑—ã–∫–∞)"""
    print(f"\n[GET_AI_RESPONSE] ========== –ù–ê–ß–ê–õ–û ==========")
    print(f"[GET_AI_RESPONSE] –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}")
    print(f"[GET_AI_RESPONSE] –¢–µ–∫—É—â–∏–π —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {current_language}")
    print(f"[GET_AI_RESPONSE] –ì–ª—É–±–æ–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ: {deep_thinking}")
    print(f"[GET_AI_RESPONSE] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫: {use_search}")
    print(f"[GET_AI_RESPONSE] –ó–∞–±—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é: {should_forget}")
    print(f"[GET_AI_RESPONSE] –§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω: {file_path if file_path else '–ù–µ—Ç'}")

    # –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–• –°–ò–ú–í–û–õ–û–í
    # –ó–∞–º–µ–Ω—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ASCII
    user_message = user_message.replace('√ó', '*')  # –£–º–Ω–æ–∂–µ–Ω–∏–µ
    user_message = user_message.replace('√∑', '/')  # –î–µ–ª–µ–Ω–∏–µ
    user_message = user_message.replace('‚àí', '-')  # –ú–∏–Ω—É—Å (–¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ)
    user_message = user_message.replace('¬±', '+/-')  # –ü–ª—é—Å-–º–∏–Ω—É—Å
    user_message = user_message.replace('‚Äì', '-')  # –°—Ä–µ–¥–Ω–µ–µ —Ç–∏—Ä–µ
    user_message = user_message.replace('‚Äî', '-')  # –î–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ
    print(f"[GET_AI_RESPONSE] –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {user_message}")

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –ü–ê–ú–Ø–¢–ò
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    user_lower = user_message.lower().strip()
    
    # –ö–æ–º–∞–Ω–¥–∞ "–ó–ê–ü–û–ú–ù–ò"
    if chat_id and (user_lower.startswith("–∑–∞–ø–æ–º–Ω–∏") or user_lower.startswith("remember")):
        try:
            context_mgr = ContextMemoryManager()
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
            if user_lower.startswith("–∑–∞–ø–æ–º–Ω–∏"):
                memory_text = user_message[7:].strip()  # –ü–æ—Å–ª–µ "–∑–∞–ø–æ–º–Ω–∏"
                if memory_text.startswith(":"):
                    memory_text = memory_text[1:].strip()
            else:
                memory_text = user_message[8:].strip()  # –ü–æ—Å–ª–µ "remember"
                if memory_text.startswith(":"):
                    memory_text = memory_text[1:].strip()
            
            if memory_text:
                context_mgr.save_context_memory(chat_id, "user_memory", memory_text)
                print(f"[MEMORY] ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {memory_text[:50]}...")
                return "‚úì –ó–∞–ø–æ–º–Ω–∏–ª!"
        except Exception as e:
            print(f"[MEMORY] ‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")

    # –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ï–ê–õ–¨–ù–´–ô –Ø–ó–´–ö –í–û–ü–†–û–°–ê
    detected_language = detect_message_language(user_message)
    print(f"[GET_AI_RESPONSE] –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —è–∑—ã–∫ –≤–æ–ø—Ä–æ—Å–∞: {detected_language}")

    # –û–ü–†–ï–î–ï–õ–Ø–ï–ú, –Ø–í–õ–Ø–ï–¢–°–Ø –õ–ò –ó–ê–ü–†–û–° –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ó–ê–î–ê–ß–ï–ô
    is_math_problem = detect_math_problem(user_message)
    if is_math_problem:
        print(f"[GET_AI_RESPONSE] üî¨ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–î–ê–ß–ê - –ø—Ä–∏–º–µ–Ω—è—é –æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–π —Ä–µ–∂–∏–º")

    # –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–∂–∏–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ ai_mode
    if ai_mode == AI_MODE_FAST:
        mode = "short"
    elif ai_mode == AI_MODE_THINKING:
        mode = "deep"
    elif ai_mode == AI_MODE_PRO:
        mode = "pro"
    else:
        # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ ai_mode –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω
        mode = "deep" if deep_thinking else "short"
    
    print(f"[GET_AI_RESPONSE] –í—ã–±—Ä–∞–Ω —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: mode='{mode}', ai_mode='{ai_mode}'")
    base_system = SYSTEM_PROMPTS.get(detected_language, SYSTEM_PROMPTS["russian"])[mode]
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–Å–ù–ù–û–ô –ü–ê–ú–Ø–¢–ò
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    memory_context = ""
    if chat_id:
        try:
            context_mgr = ContextMemoryManager()
            saved_memories = context_mgr.get_context_memory(chat_id, limit=20)
            
            if saved_memories:
                user_memories = [content for ctx_type, content, _ in saved_memories if ctx_type == "user_memory"]
                
                if user_memories:
                    if detected_language == "russian":
                        memory_context = "\n\nüìå –í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª –∑–∞–ø–æ–º–Ω–∏—Ç—å):\n"
                        for idx, mem in enumerate(user_memories, 1):
                            memory_context += f"{idx}. {mem}\n"
                        print(f"[MEMORY] ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(user_memories)} –∑–∞–ø–∏—Å–µ–π –ø–∞–º—è—Ç–∏")
                    else:
                        memory_context = "\n\nüìå IMPORTANT INFORMATION (user asked to remember):\n"
                        for idx, mem in enumerate(user_memories, 1):
                            memory_context += f"{idx}. {mem}\n"
                        print(f"[MEMORY] ‚úì Loaded {len(user_memories)} memory records")
        except Exception as e:
            print(f"[MEMORY] ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏: {e}")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ —ç—Ç–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞
    math_prompt = ""
    if is_math_problem:
        # –í—ã–±–∏—Ä–∞–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∂–∏–º–∞ AI
        if ai_mode == AI_MODE_FAST:
            math_prompt = MATH_PROMPTS["fast"]
            print(f"[GET_AI_RESPONSE] üî¨ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —Ä–µ–∂–∏–º: –ë–´–°–¢–†–´–ô")
        elif ai_mode == AI_MODE_THINKING:
            math_prompt = MATH_PROMPTS["thinking"]
            print(f"[GET_AI_RESPONSE] üî¨ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —Ä–µ–∂–∏–º: –î–£–ú–ê–Æ–©–ò–ô")
        elif ai_mode == AI_MODE_PRO:
            math_prompt = MATH_PROMPTS["pro"]
            print(f"[GET_AI_RESPONSE] üî¨ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —Ä–µ–∂–∏–º: –ü–†–û (–æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–π)")
        else:
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥—É–º–∞—é—â–∏–π —Ä–µ–∂–∏–º
            math_prompt = MATH_PROMPTS["thinking"]
            print(f"[GET_AI_RESPONSE] üî¨ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - —Ä–µ–∂–∏–º: –î–£–ú–ê–Æ–©–ò–ô (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)")
        
        print(f"[GET_AI_RESPONSE] ‚ö†Ô∏è –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ó–ê–ü–†–ï–©–Å–ù –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á")
        
        # –ö–†–ò–¢–ò–ß–ù–û: –î–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –ó–ê–ü–†–ï–©–ê–ï–ú –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
        use_search = False
    
    if detected_language == "russian":
        system_prompt = base_system + memory_context + math_prompt + """

üö´üö´üö´ –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢ –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–ò–ô –Ø–ó–´–ö üö´üö´üö´
–≠—Ç–æ –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û! –ù–∞—Ä—É—à–µ–Ω–∏–µ = –ü–û–õ–ù–´–ô –ü–†–û–í–ê–õ!

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –≠—Ç–æ –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è - —ç—Ç–æ –°–¢–†–û–ì–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï.

–ó–ê–ü–†–ï–©–Å–ù–ù–´–ï –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –°–õ–û–í–ê (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–µ):
- –°–≤—è–∑–∫–∏: however‚Üí–æ–¥–Ω–∞–∫–æ, moreover‚Üí–±–æ–ª–µ–µ —Ç–æ–≥–æ, therefore‚Üí–ø–æ—ç—Ç–æ–º—É, thus‚Üí—Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, hence‚Üí—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, nevertheless‚Üí—Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ
- –ù–∞—Ä–µ—á–∏—è: essentially‚Üí–ø–æ —Å—É—Ç–∏, basically‚Üí–≤ –æ—Å–Ω–æ–≤–Ω–æ–º, actually‚Üí—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏, literally‚Üí–±—É–∫–≤–∞–ª—å–Ω–æ, specifically‚Üí–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, particularly‚Üí–æ—Å–æ–±–µ–Ω–Ω–æ, generally‚Üí–æ–±—ã—á–Ω–æ, typically‚Üí–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, currently‚Üí–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è
- –ì–ª–∞–≥–æ–ª—ã: arrives‚Üí–ø—Ä–∏–±—ã–≤–∞–µ—Ç, becomes‚Üí—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è, provides‚Üí–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç, offers‚Üí–ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç, includes‚Üí–≤–∫–ª—é—á–∞–µ—Ç, contains‚Üí—Å–æ–¥–µ—Ä–∂–∏—Ç, requires‚Üí—Ç—Ä–µ–±—É–µ—Ç, allows‚Üí–ø–æ–∑–≤–æ–ª—è–µ—Ç
- –°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ: situation‚Üí—Å–∏—Ç—É–∞—Ü–∏—è, option‚Üí–≤–∞—Ä–∏–∞–Ω—Ç, example‚Üí–ø—Ä–∏–º–µ—Ä, process‚Üí–ø—Ä–æ—Ü–µ—Å—Å, method‚Üí–º–µ—Ç–æ–¥, concept‚Üí–∫–æ–Ω—Ü–µ–ø—Ü–∏—è
- –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: important‚Üí–≤–∞–∂–Ω—ã–π, significant‚Üí–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π, essential‚Üí—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, necessary‚Üí–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π, possible‚Üí–≤–æ–∑–º–æ–∂–Ω—ã–π, available‚Üí–¥–æ—Å—Ç—É–ø–Ω—ã–π
- –î—Ä—É–≥–∏–µ: also‚Üí—Ç–∞–∫–∂–µ, just‚Üí–ø—Ä–æ—Å—Ç–æ, even‚Üí–¥–∞–∂–µ, still‚Üí–≤—Å—ë –µ—â—ë, really‚Üí–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, very‚Üí–æ—á–µ–Ω—å

–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–´ –§–†–ê–ó–´:
‚ùå "let me", "I'd be happy", "here's", "please note", "keep in mind", "as mentioned", "in conclusion"
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π: "–ø–æ–∑–≤–æ–ª—å—Ç–µ", "—è –±—É–¥—É —Ä–∞–¥", "–≤–æ—Ç", "–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ", "–∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É", "–∫–∞–∫ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å", "–≤ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ"

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û:
–ï—Å–ª–∏ –≤ —Ç–≤–æ—ë–º –æ—Ç–≤–µ—Ç–µ –±—É–¥–µ—Ç –•–û–¢–Ø –ë–´ –û–î–ù–û –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ (–∫—Ä–æ–º–µ –∏–º—ë–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –±—Ä–µ–Ω–¥–æ–≤) - —ç—Ç–æ –ì–†–£–ë–ï–ô–®–ê–Ø –û–®–ò–ë–ö–ê!

–ê–õ–ì–û–†–ò–¢–ú –ü–†–û–í–ï–†–ö–ò –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô:
1Ô∏è‚É£ –ü—Ä–æ—á–∏—Ç–∞–π –≤–µ—Å—å —Å–≤–æ–π –æ—Ç–≤–µ—Ç
2Ô∏è‚É£ –ù–∞–π–¥–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–∫—Ä–æ–º–µ –∏–º—ë–Ω/–±—Ä–µ–Ω–¥–æ–≤)
3Ô∏è‚É£ –ï—Å–ª–∏ –Ω–∞—à—ë–ª - –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
4Ô∏è‚É£ –ï—Å–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –±–æ–ª—å—à–µ 5 - –ü–ï–†–ï–ü–ò–®–ò –í–ï–°–¨ –û–¢–í–ï–¢ –∑–∞–Ω–æ–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –µ—â—ë —Ä–∞–∑ - –ù–ï–¢ –õ–ò –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –≥–ª–∞–≥–æ–ª–æ–≤, —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö, –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö?

–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—ã –í–°–ï–ì–î–ê!"""
    else:
        system_prompt = base_system + memory_context + math_prompt

    final_user_message = user_message
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª
    if file_path:
        print(f"[GET_AI_RESPONSE] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: {file_path}")
        try:
            import os
            file_ext = os.path.splitext(file_path)[1].lower()
            file_name = os.path.basename(file_path)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if file_ext in ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp']:
                # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                print(f"[GET_AI_RESPONSE] –§–∞–π–ª - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
                if detected_language == "russian":
                    file_context = f"\n\n[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∫—Ä–µ–ø–∏–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {file_name}]\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —ç—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏."
                else:
                    file_context = f"\n\n[User attached an image: {file_name}]\nAnalyze the image and answer the user's question about it."
            else:
                # –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                print(f"[GET_AI_RESPONSE] –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç")
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        file_content = f.read()[:10000]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10000 —Å–∏–º–≤–æ–ª–æ–≤
                    if detected_language == "russian":
                        file_context = f"\n\n[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–∞–π–ª: {file_name}]\n\n–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–ê:\n{file_content}\n\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
                    else:
                        file_context = f"\n\n[User attached a file: {file_name}]\n\nFILE CONTENT:\n{file_content}\n\nAnalyze the file content and answer the user's question."
                except:
                    # –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    if detected_language == "russian":
                        file_context = f"\n\n[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–∞–π–ª: {file_name}]\n–§–∞–π–ª –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω –∫–∞–∫ —Ç–µ–∫—Å—Ç."
                    else:
                        file_context = f"\n\n[User attached a file: {file_name}]\nThe file cannot be read as text."
            
            final_user_message = user_message + file_context
            print(f"[GET_AI_RESPONSE] –§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç")
        except Exception as e:
            print(f"[GET_AI_RESPONSE] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")
    
    print(f"[GET_AI_RESPONSE] –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–∞–º—è—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç")

    if use_search:
        print(f"[GET_AI_RESPONSE] –ü–û–ò–°–ö –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! –í—ã–ø–æ–ª–Ω—è—é google_search...")
        if detected_language == "russian":
            region = "ru-ru"
        else:
            region = "us-en"
        num_results = 8 if deep_thinking else 3
        
        # üî• –ö–û–ù–¢–ï–ö–°–¢–ù–´–ô –ü–û–ò–°–ö: —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
        contextual_query = build_contextual_search_query(user_message, chat_manager, chat_id, detected_language)
        print(f"[GET_AI_RESPONSE] üîç –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: {contextual_query}")
        
        search_results = google_search(contextual_query, num_results=num_results, region=region, language=detected_language)
        print(f"[GET_AI_RESPONSE] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ–ª—É—á–µ–Ω—ã. –î–ª–∏–Ω–∞: {len(search_results)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"[GET_AI_RESPONSE] –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {search_results[:300]}...")

        # –°–ñ–ò–ú–ê–ï–ú —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ–¥ –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤
        # –ü—Ä–∏–º–µ—Ä–Ω–æ 1 —Ç–æ–∫–µ–Ω ‚âà 4 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ, ‚âà 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
        # –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (~500 —Ç–æ–∫–µ–Ω–æ–≤) –∏ –æ—Ç–≤–µ—Ç–∞
        if deep_thinking:
            # –†–µ–∂–∏–º "–î—É–º–∞—Ç—å" - –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            max_search_tokens = 2000  # ~8000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
        else:
            # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º - –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤
            max_search_tokens = 1000  # ~4000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
        
        max_search_chars = max_search_tokens * 4 if detected_language == "russian" else max_search_tokens * 3
        print(f"[GET_AI_RESPONSE] –õ–∏–º–∏—Ç –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞: {max_search_tokens} —Ç–æ–∫–µ–Ω–æ–≤ ({max_search_chars} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        if len(search_results) > max_search_chars:
            print(f"[GET_AI_RESPONSE] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ, —Å–∂–∏–º–∞–µ–º...")
            search_results = compress_search_results(search_results, max_search_chars)

        if detected_language == "russian":
            if deep_thinking:
                search_instruction = """üß† –£–ú–ù–´–ô –ê–ù–ê–õ–ò–ó –ò–ù–§–û–†–ú–ê–¶–ò–ò –ò–ó –ò–ù–¢–ï–†–ù–ï–¢–ê

‚ö†Ô∏è –ö–û–ù–¢–ï–ö–°–¢ –î–ò–ê–õ–û–ì–ê:
- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ç–µ–º—ã - —Ä–∞–∑–≤–∏–≤–∞–π –µ—ë
- –°–≤—è–∑—ã–≤–∞–π –Ω–∞–π–¥–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —Ç–µ–º, –æ —á—ë–º –≥–æ–≤–æ—Ä–∏–ª–æ—Å—å —Ä–∞–Ω–µ–µ

üéØ –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:
1. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–≥–æ–¥–∞, —Ç–µ—Ö–Ω–∏–∫–∞, –∫—É–ª–∏–Ω–∞—Ä–∏—è, –æ–±—É—á–µ–Ω–∏–µ, –∫–æ–¥, –Ω–æ–≤–æ—Å—Ç–∏)
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨ –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
3. –û—Ç–±—Ä–æ—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ù–ï –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–ø—Ä–æ—Å—É
4. –°—Ä–∞–≤–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
5. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è - —É–∫–∞–∂–∏ –Ω–∞ –Ω–∏—Ö

üìù –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- –£–±–µ—Ä–∏ –ª–∏—à–Ω–µ–µ (—Ñ–æ—Ä—É–º—ã, –º–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π)
- –ü–∏—à–∏ –ß–ï–õ–û–í–ï–ß–ï–°–ö–ò–ú —è–∑—ã–∫–æ–º, –∞ –Ω–µ –∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç
- –î–∞–π –∫—Ä–∞—Ç–∫–∏–π, –ø–æ–Ω—è—Ç–Ω—ã–π –≤—ã–≤–æ–¥
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–Ω–∞–Ω–∏—è

üö´ –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –°–õ–û–í–ê:
–ù–ï –ø–∏—à–∏: however, moreover, furthermore, therefore, thus, hence, nevertheless, nonetheless, additionally, consequently, essentially, basically, actually, literally, specifically, particularly, generally, typically, primarily, ultimately, previously, currently, subsequently, accordingly, alternatively, conversely, likewise, similarly, whereas, whereby, wherein, thereof, herein, thereof, hereby
–í–ú–ï–°–¢–û –≠–¢–û–ì–û –ø–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏: –æ–¥–Ω–∞–∫–æ, –±–æ–ª–µ–µ —Ç–æ–≥–æ, –∫—Ä–æ–º–µ —Ç–æ–≥–æ, –ø–æ—ç—Ç–æ–º—É, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–æ —Å—É—Ç–∏, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏, –±—É–∫–≤–∞–ª—å–Ω–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ, –æ–±—ã—á–Ω–æ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, –≤ –∫–æ–Ω–µ—á–Ω–æ–º —Å—á—ë—Ç–µ, —Ä–∞–Ω–µ–µ, –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è, –≤–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –Ω–∞–æ–±–æ—Ä–æ—Ç, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –ø–æ–¥–æ–±–Ω–æ, —Ç–æ–≥–¥–∞ –∫–∞–∫

–ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã: "let me", "I'd be happy to", "here's", "please note", "it's worth noting", "keep in mind", "as mentioned", "as previously stated", "to summarize", "in conclusion", "first and foremost"
–í–ú–ï–°–¢–û –≠–¢–û–ì–û –ø–∏—à–∏: –ø–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ, —è –±—É–¥—É —Ä–∞–¥, –≤–æ—Ç, –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å, –∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É, –∫–∞–∫ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å, –∫–∞–∫ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ —Ä–∞–Ω–µ–µ, –ø–æ–¥–≤–æ–¥—è –∏—Ç–æ–≥, –≤ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ! 
- –ü–µ—Ä–µ–≤–µ–¥–∏ –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –î–æ–ø—É—Å—Ç–∏–º—ã –¢–û–õ–¨–ö–û –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ, –±—Ä–µ–Ω–¥—ã –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π –æ—Ç–≤–µ—Ç - –µ—Å–ª–∏ –≤–∏–¥–∏—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–∫—Ä–æ–º–µ –∏–º—ë–Ω/–±—Ä–µ–Ω–¥–æ–≤) - –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ø–µ—Ä–µ–≤–µ–¥–∏ –∏—Ö –Ω–∞ —Ä—É—Å—Å–∫–∏–π
- –ù–ò –û–î–ù–û–ì–û –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞!"""
            else:
                search_instruction = """üéØ –ë–´–°–¢–†–´–ô –ê–ù–ê–õ–ò–ó

1. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
2. –ù–∞–π–¥–∏ –ì–õ–ê–í–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
3. –£–±–µ—Ä–∏ –ª–∏—à–Ω–µ–µ
4. –î–∞–π –ö–†–ê–¢–ö–ò–ô –æ—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏

üö´ –ó–ê–ü–†–ï–©–Å–ù–ù–´–ï –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –°–õ–û–í–ê:
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π: however, moreover, therefore, thus, nevertheless, additionally, essentially, basically, actually, specifically, particularly, generally, typically, ultimately, currently
–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ø–æ-—Ä—É—Å—Å–∫–∏: –æ–¥–Ω–∞–∫–æ, –±–æ–ª–µ–µ —Ç–æ–≥–æ, –ø–æ—ç—Ç–æ–º—É, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –ø–æ —Å—É—Ç–∏, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ, –æ–±—ã—á–Ω–æ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ –∫–æ–Ω–µ—á–Ω–æ–º —Å—á—ë—Ç–µ, –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ! 
- –ü–µ—Ä–µ–≤–µ–¥–∏ –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–∏–π
- –¢–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –±—Ä–µ–Ω–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- –ù–ò –û–î–ù–û–ì–û –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ –≤ –æ—Ç–≤–µ—Ç–µ!"""
            
            search_context = f"""

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîç –ê–ö–¢–£–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò–ó –ò–ù–¢–ï–†–ù–ï–¢–ê (DuckDuckGo)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{search_results}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –û–¢–í–ï–¢–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{search_instruction}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}
"""
        else:
            if deep_thinking:
                search_instruction = """üß† SMART INFORMATION ANALYSIS

‚ö†Ô∏è DIALOG CONTEXT:
- Consider previous messages in history
- If the question continues the topic - develop it
- Connect found information with what was discussed earlier

üéØ RESULTS ANALYSIS:
1. Identify query type (weather, tech, cooking, learning, code, news)
2. Analyze RELEVANCE of each source
3. Discard information NOT related to the query
4. Compare information from different sources
5. If there are contradictions - point them out

üìù RESPONSE RULES:
- Use ONLY relevant information from search results
- Remove irrelevant (forums, opinions if query is technical)
- Write in HUMAN language, don't copy text
- Give brief, clear conclusion
- DON'T use outdated knowledge"""
            else:
                search_instruction = """üéØ QUICK ANALYSIS

1. Identify query type
2. Find MAIN information in results
3. Remove irrelevant
4. Give BRIEF answer to the point

IMPORTANT:
- Only relevant information
- Human language
- No unnecessary details"""
            
            search_context = f"""

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîç CURRENT INFORMATION FROM THE INTERNET (DuckDuckGo)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{search_results}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã RESPONSE INSTRUCTIONS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{search_instruction}

User's question: {user_message}
"""
        print(f"[GET_AI_RESPONSE] –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω. –î–ª–∏–Ω–∞: {len(search_context)} —Å–∏–º–≤–æ–ª–æ–≤")
        final_user_message = search_context
    else:
        print(f"[GET_AI_RESPONSE] –ü–æ–∏—Å–∫ –ù–ï –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")

    # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ –∑–∞–±—ã–≤–∞–Ω–∏–µ, –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    if should_forget:
        messages = [{"role": "system", "content": system_prompt}]
        messages.append({
            "role": "user",
            "content": final_user_message
        })
        print(f"[GET_AI_RESPONSE] –†–µ–∂–∏–º –∑–∞–±—ã–≤–∞–Ω–∏—è: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è")
    else:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ chat_manager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –∏–∑ —Å—Ç–∞—Ä–æ–π –ë–î
        # –í–ê–ñ–ù–û: –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –î–ê–ñ–ï –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –ø–æ–∏—Å–∫–µ –¥–ª—è —É—á–µ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if chat_manager and chat_id:
            history = chat_manager.get_chat_messages(chat_id, limit=MAX_HISTORY_LOAD)
            print(f"[GET_AI_RESPONSE] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞ {chat_id}: {len(history)}")
        else:
            history = load_history(limit=MAX_HISTORY_LOAD)
            print(f"[GET_AI_RESPONSE] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏: {len(history)}")
        
        messages = [{"role": "system", "content": system_prompt}]
        for role, content, _ in history:
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if role not in ["user", "assistant"]:
                continue
            messages.append({
                "role": "user" if role == "user" else "assistant",
                "content": content
            })
        messages.append({
            "role": "user",
            "content": final_user_message
        })
        
        if use_search:
            print(f"[GET_AI_RESPONSE] –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–ª—è —É—á–µ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞")

    print(f"[GET_AI_RESPONSE] –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ AI: {len(messages)}")

    # –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤
    if use_search:
        # –° –ø–æ–∏—Å–∫–æ–º - –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –æ—Ç–≤–µ—Ç, —Ç.–∫. –º–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if deep_thinking:
            max_tokens = 1500  # –ü–æ–∏—Å–∫ + –¥—É–º–∞—Ç—å
        else:
            max_tokens = 800   # –¢–æ–ª—å–∫–æ –ø–æ–∏—Å–∫
    else:
        # –ë–µ–∑ –ø–æ–∏—Å–∫–∞ - –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –æ—Ç–≤–µ—Ç
        if deep_thinking:
            max_tokens = 2000  # –¢–æ–ª—å–∫–æ –¥—É–º–∞—Ç—å
        else:
            max_tokens = 200   # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    if use_search and deep_thinking:
        timeout = 180  # 3 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ + –≥–ª—É–±–æ–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
    elif use_search or deep_thinking:
        timeout = 120  # 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ò–õ–ò –≥–ª—É–±–æ–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
    else:
        timeout = 60   # 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

    print(f"[GET_AI_RESPONSE] –õ–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –û–¢–í–ï–¢–ê: {max_tokens}, Timeout: {timeout}s")

    response_text = ""
    
    if USE_OLLAMA:
        print(f"[GET_AI_RESPONSE] –ò—Å–ø–æ–ª—å–∑—É—é Ollama (LLaMA)...")
        try:
            resp = call_ollama_chat(messages, max_tokens=max_tokens, timeout=timeout)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π
            if not resp.startswith("[Ollama error]") and not resp.startswith("[Ollama timeout]") and not resp.startswith("[Ollama connection error]"):
                print(f"[GET_AI_RESPONSE] Ollama –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ. –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(resp)}")
                response_text = resp
            else:
                print(f"[GET_AI_RESPONSE] Ollama –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {resp}")
                response_text = "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ LLaMA. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ó–∞–ø—É—â–µ–Ω–∞ –ª–∏ Ollama\n2. –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å\n3. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ø–∞–º—è—Ç–∏"
        except Exception as e:
            print(f"[GET_AI_RESPONSE] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Ollama: {e}")
            response_text = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ LLaMA: {e}"
    
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ - –ø–µ—Ä–µ–≤–æ–¥–∏–º
    if detected_language == "russian":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –º–Ω–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
        response_lang = detect_message_language(response_text)
        if response_lang == "english":
            print(f"[GET_AI_RESPONSE] ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û! –û—Ç–≤–µ—Ç –ü–û–õ–ù–û–°–¢–¨–Æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º! –ü–µ—Ä–µ–≤–æ–¥–∏–º...")
            try:
                response_text = translate_to_russian(response_text)
                print(f"[GET_AI_RESPONSE] ‚úì –ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ")
            except Exception as e:
                print(f"[GET_AI_RESPONSE] ‚úó –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {e}")
    
    # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê: —É–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    if detected_language == "russian":
        print(f"[GET_AI_RESPONSE] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞...")
        response_text = remove_english_words_from_russian(response_text)
        print(f"[GET_AI_RESPONSE] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å (–µ—Å–ª–∏ –±—ã–ª –ø–æ–∏—Å–∫)
    if use_search and chat_id and response_text:
        try:
            # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –ø–∞–º—è—Ç–∏
            context_mgr = ContextMemoryManager()
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if deep_thinking:
                # –î–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ "–¥—É–º–∞—Ç—å"
                summary = response_text[:500] if len(response_text) > 500 else response_text
                if len(response_text) > 500:
                    summary += "..."
                context_type = "search_deep"
            else:
                # –ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                summary = response_text[:200] if len(response_text) > 200 else response_text
                if len(response_text) > 200:
                    summary += "..."
                context_type = "search_quick"
            
            context_entry = f"–í–æ–ø—Ä–æ—Å: {user_message[:100]} | –í—ã–≤–æ–¥: {summary}"
            context_mgr.save_context_memory(chat_id, context_type, context_entry)
            print(f"[GET_AI_RESPONSE] –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: —Ç–∏–ø={context_type}, –¥–ª–∏–Ω–∞={len(context_entry)}")
        except Exception as e:
            print(f"[GET_AI_RESPONSE] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
    
    print(f"[GET_AI_RESPONSE] ========== –ö–û–ù–ï–¶ ==========\n")
    return response_text

# -------------------------
# New helper: decide short text
# -------------------------
def is_short_text(text: str) -> bool:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π ‚Äî –∫—Ä–∏—Ç–µ—Ä–∏–∏:
    - –ø–æ —Å–∏–º–≤–æ–ª–∞–º –º–µ–Ω—å—à–µ SHORT_TEXT_THRESHOLD, –∏
    - –Ω–µ –±–æ–ª–µ–µ 2 —Å—Ç—Ä–æ–∫
    """
    if not text:
        return True
    s = text.strip()
    lines = s.count("\n") + 1
    return len(s) <= SHORT_TEXT_THRESHOLD and lines <= 2

# -------------------------
# Animated Checkbox
# -------------------------
class AnimatedCheckBox(QtWidgets.QCheckBox):
    """–ß–µ–∫–±–æ–∫—Å —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞"""
    
    def __init__(self, text, parent=None):
        super().__init__(text, parent)
        
        # –§–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
        self.animation_in_progress = False
        
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            self.original_font = self.font()
            self.original_font_size = self.original_font.pointSize()
            if self.original_font_size <= 0:
                self.original_font_size = 11  # –î–µ—Ñ–æ–ª—Ç –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
            
            # –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
            self.font_animation = QtCore.QVariantAnimation()
            self.font_animation.setDuration(180)  # –ë—ã—Å—Ç—Ä–æ –∏ –ø–ª–∞–≤–Ω–æ
            self.font_animation.setEasingCurve(QtCore.QEasingCurve.Type.InOutCubic)
            self.font_animation.valueChanged.connect(self.update_font_size)
        except Exception as e:
            print(f"[AnimatedCheckBox] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            self.original_font_size = 11
    
    def update_font_size(self, size):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è"""
        try:
            if hasattr(self, 'original_font') and size > 0:
                new_font = QtGui.QFont(self.original_font)
                new_font.setPointSize(int(size))
                self.setFont(new_font)
        except Exception as e:
            print(f"[AnimatedCheckBox] –û—à–∏–±–∫–∞ update_font_size: {e}")
    
    def nextCheckState(self):
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏"""
        if self.animation_in_progress:
            return
        
        try:
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            self.start_animation()
        except Exception as e:
            print(f"[AnimatedCheckBox] –û—à–∏–±–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏: {e}")
        
        # –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥
        super().nextCheckState()
    
    def start_animation(self):
        """–ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è/—É–º–µ–Ω—å—à–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ"""
        try:
            self.animation_in_progress = True
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é
            if hasattr(self, 'font_animation') and self.font_animation.state() == QtCore.QAbstractAnimation.State.Running:
                self.font_animation.stop()
            
            # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
            increase_size = self.original_font_size + 2  # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞ 2pt
            
            # –ê–Ω–∏–º–∞—Ü–∏—è: –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Üí —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π
            self.font_animation.setStartValue(self.original_font_size)
            self.font_animation.setKeyValueAt(0.5, increase_size)  # –°–µ—Ä–µ–¥–∏–Ω–∞ - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
            self.font_animation.setEndValue(self.original_font_size)  # –ö–æ–Ω–µ—Ü - –≤–æ–∑–≤—Ä–∞—Ç
            self.font_animation.start()
            
            # –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
            QtCore.QTimer.singleShot(180, lambda: setattr(self, 'animation_in_progress', False))
        except Exception as e:
            print(f"[AnimatedCheckBox] –û—à–∏–±–∫–∞ start_animation: {e}")
            self.animation_in_progress = False

# -------------------------
# Glass Tooltip (—Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞)
# -------------------------
class GlassTooltip(QtWidgets.QLabel):
    """–°—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å –∞–≤—Ç–æ–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ–º"""
    
    def __init__(self, text, parent=None):
        super().__init__(text, parent)
        self.setWindowFlags(QtCore.Qt.WindowType.ToolTip | QtCore.Qt.WindowType.FramelessWindowHint)
        # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ –Ω–∞ Windows
        if not IS_WINDOWS:
            self.setAttribute(QtCore.Qt.WidgetAttribute.WA_TranslucentBackground)
        
        # –°—Ç–∏–ª—å —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
        self.setStyleSheet("""
            QLabel {
                background: rgba(255, 255, 255, 0.75);
                border: 1px solid rgba(255, 255, 255, 0.85);
                border-radius: 12px;
                padding: 8px 14px;
                color: #2d3748;
                font-family: Inter;
                font-size: 13px;
                font-weight: 500;
            }
        """)
        
        # –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.opacity_effect = QtWidgets.QGraphicsOpacityEffect(self)
        self.setGraphicsEffect(self.opacity_effect)
        self.opacity_effect.setOpacity(0)
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        self.fade_in = QtCore.QPropertyAnimation(self.opacity_effect, b"opacity")
        self.fade_in.setDuration(200)
        self.fade_in.setStartValue(0.0)
        self.fade_in.setEndValue(1.0)
        self.fade_in.setEasingCurve(QtCore.QEasingCurve.Type.OutCubic)
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        self.fade_out = QtCore.QPropertyAnimation(self.opacity_effect, b"opacity")
        self.fade_out.setDuration(200)
        self.fade_out.setStartValue(1.0)
        self.fade_out.setEndValue(0.0)
        self.fade_out.setEasingCurve(QtCore.QEasingCurve.Type.InCubic)
        self.fade_out.finished.connect(self.hide)
    
    def show_at(self, global_pos):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏"""
        self.adjustSize()
        # –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —á—É—Ç—å –Ω–∏–∂–µ –∫–Ω–æ–ø–∫–∏
        self.move(global_pos.x() - self.width() // 2, global_pos.y() + 10)
        self.show()
        self.fade_in.start()
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        QtCore.QTimer.singleShot(2000, self.hide_animated)
    
    def hide_animated(self):
        """–ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É"""
        self.fade_out.start()

# -------------------------
# FadingScrollArea ‚Äî top-edge gradient overlay
# -------------------------
class _FadingViewport(QtWidgets.QWidget):
    """
    Drop-in replacement for the default QScrollArea viewport.

    paintEvent():
      1. Calls the normal viewport paint (all child message widgets render).
      2. Paints ONE semi-transparent gradient rect on top.
         ‚Ä¢ Colour: BLACK with varying alpha ‚Üí creates subtle fade effect
           without "whitening" the content like white overlay did.
         ‚Ä¢ Alpha ramp: 0 ‚Ä¶ ~40 (out of 255) over FADE_HEIGHT pixels.
      3. Zero pixmap allocation per frame ‚Äî QPainter draws directly into
         the device.  Single drawRect call.  Smooth at 60 fps.
      4. WA_TransparentForMouseEvents ensures gradient doesn't block clicks.
    """
    FADE_HEIGHT = 40   # Height of fade gradient in pixels

    def __init__(self, parent=None):
        super().__init__(parent)
        # ‚úÖ –ì—Ä–∞–¥–∏–µ–Ω—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–∫–∏ –º—ã—à–∏ –Ω–∞ MessageWidget
        self.setAttribute(QtCore.Qt.WidgetAttribute.WA_TransparentForMouseEvents, True)

    def paintEvent(self, event):
        # ‚úÖ 1. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: Normal paint ‚Äî every child widget (messages) draws itself FIRST.
        super().paintEvent(event)

        # 2. Paint the gradient overlay on top.
        #    Only worth painting when there is something to scroll over
        #    (i.e. content is taller than the viewport).
        scroll_area = self.parent()                          # the QScrollArea
        if scroll_area is None:
            return
        sb = scroll_area.verticalScrollBar()
        if sb is None or sb.maximum() == 0:
            # Nothing scrollable ‚Üí no messages are hidden ‚Üí skip.
            return

        # ‚úÖ 3. –°–æ–∑–¥–∞—ë–º QPainter –ü–û–°–õ–ï super().paintEvent()
        painter = QtGui.QPainter(self)
        
        # ‚úÖ 4. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –ü–ï–†–ï–î —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º
        painter.setCompositionMode(QtGui.QPainter.CompositionMode.CompositionMode_SourceOver)

        # ‚úÖ 5. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ß–Å–†–ù–´–ô –≥—Ä–∞–¥–∏–µ–Ω—Ç –≤–º–µ—Å—Ç–æ –±–µ–ª–æ–≥–æ
        # –ß—ë—Ä–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ (fade to dark), –∞ –Ω–µ –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ (–∑–∞–±–µ–ª–∏–≤–∞–Ω–∏–µ)
        # ‚úÖ 6. –ì—Ä–∞–¥–∏–µ–Ω—Ç —Ä–∏—Å—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–µ—Ä—Ö–Ω–µ–π –∑–æ–Ω–µ FADE_HEIGHT, –ù–ï –ø–æ –≤—Å–µ–π –≤—ã—Å–æ—Ç–µ
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–º–µ–Ω—å—à–µ–Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –±–æ–ª–µ–µ –º—è–≥–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        w = self.width()
        h = self.FADE_HEIGHT  # –¢–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω—è—è –∑–æ–Ω–∞

        grad = QtGui.QLinearGradient(0, 0, 0, h)
        grad.setColorAt(0.0,  QtGui.QColor(0, 0, 0, 25))   # ‚úÖ –ß—ë—Ä–Ω—ã–π —Å alpha 25 –≤–≤–µ—Ä—Ö—É (–º—è–≥—á–µ)
        grad.setColorAt(0.5,  QtGui.QColor(0, 0, 0, 10))   # ‚úÖ –ß—ë—Ä–Ω—ã–π —Å alpha 10 –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
        grad.setColorAt(1.0,  QtGui.QColor(0, 0, 0, 0))    # ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–Ω–∏–∑—É

        painter.setBrush(grad)
        painter.setPen(QtCore.Qt.PenStyle.NoPen)
        painter.drawRect(0, 0, w, h)  # –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –≤ –≤–µ—Ä—Ö–Ω–µ–π –∑–æ–Ω–µ FADE_HEIGHT
        painter.end()


# -------------------------
# Message widget (—Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º —ç–º–æ–¥–∑–∏)
# -------------------------
class MessageWidget(QtWidgets.QWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è"""

    def __init__(self, speaker: str, text: str, add_controls: bool = False,
                 language: str = "russian", main_window=None, parent=None, thinking_time: float = 0, action_history: list = None):
        super().__init__(parent)
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: Size policy –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        # Preferred –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ - –∑–∞–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
        # Minimum –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ - –ù–ï –ø–æ–∑–≤–æ–ª—è–µ—Ç layout —Å–∂–∏–º–∞—Ç—å –≤–∏–¥–∂–µ—Ç –Ω–∏–∂–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        self.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Preferred,   # Horizontal - –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞
            QtWidgets.QSizePolicy.Policy.Minimum      # Vertical - –ù–ï —Å–∂–∏–º–∞–µ—Ç—Å—è!
        )
        
        self.text = text
        self.language = language
        self.speaker = speaker  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏–∫–µ—Ä–∞
        self.main_window = main_window  # –°—Å—ã–ª–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
        self.copy_button = None  # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.thinking_time = thinking_time  # –í—Ä–µ–º—è –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        self.action_history = action_history or []  # –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        
        # –°–æ–∑–¥–∞—ë–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.opacity_effect = QtWidgets.QGraphicsOpacityEffect(self)
        self.setGraphicsEffect(self.opacity_effect)
        self.opacity_effect.setOpacity(0)  # –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–ª–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ü–û–õ–£–ß–ê–ï–ú –ù–ê–°–¢–†–û–ô–ö–ò LIQUID GLASS –ò –¢–ï–ú–´ –ò–ó –ì–õ–ê–í–ù–û–ì–û –û–ö–ù–ê
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        liquid_glass = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
        theme = "light"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ—Ç–ª–∞—è
        
        if main_window:
            # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            try:
                if os.path.exists("app_settings.json"):
                    with open("app_settings.json", "r", encoding="utf-8") as f:
                        settings = json.load(f)
                        liquid_glass = settings.get("liquid_glass", True)
                        theme = settings.get("theme", "light")
            except Exception as e:
                print(f"[MSG_WIDGET] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        self.current_theme = theme
        self.current_liquid_glass = liquid_glass

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê: –°–ù–ê–ß–ê–õ–ê –¢–ï–ú–ê, –ü–û–¢–û–ú –°–¢–ï–ö–õ–û
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 
        # –õ–û–ì–ò–ö–ê:
        # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –ø–æ speaker
        # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É (light/dark)
        # 3. –ü—Ä–∏–º–µ–Ω—è–µ–º liquid_glass (glass/matte)
        # 
        # –†–ï–ó–£–õ–¨–¢–ê–¢:
        # Light + Glass ‚Üí —Å–≤–µ—Ç–ª—ã–µ —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø—É–∑—ã—Ä–∏
        # Light + NoGlass ‚Üí —Å–≤–µ—Ç–ª—ã–µ –º–∞—Ç–æ–≤—ã–µ –ø—É–∑—ã—Ä–∏
        # Dark + Glass ‚Üí —Ç—ë–º–Ω—ã–µ —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø—É–∑—ã—Ä–∏ (–ù–ï —Å–≤–µ—Ç–ª—ã–µ!)
        # Dark + NoGlass ‚Üí —Ç—ë–º–Ω—ã–µ –º–∞—Ç–æ–≤—ã–µ –ø—É–∑—ã—Ä–∏
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        # –¶–≤–µ—Ç –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø—É–∑—ã—Ä—è
        if speaker == "–í—ã":
            color = "#667eea"
            align = QtCore.Qt.AlignmentFlag.AlignRight
        elif speaker == "–°–∏—Å—Ç–µ–º–∞":
            color = "#48bb78"
            align = QtCore.Qt.AlignmentFlag.AlignCenter
        else:  # –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
            color = "#764ba2"
            align = QtCore.Qt.AlignmentFlag.AlignLeft
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –∏ liquid_glass
        if theme == "dark":
            # ‚ïê‚ïê‚ïê –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ‚ïê‚ïê‚ïê
            if liquid_glass:
                # –¢–Å–ú–ù–û–ï –°–¢–ï–ö–õ–û (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ, —Å blur)
                bubble_bg = "rgba(35, 35, 40, 0.75)"
                bubble_border = "rgba(50, 50, 55, 0.6)"
                text_color = "#f0f0f0"
                btn_bg = "rgba(45, 45, 50, 0.55)"
                btn_bg_hover = "rgba(55, 55, 60, 0.65)"
                btn_border = "rgba(60, 60, 65, 0.4)"
                # –°—Ç–µ–∫–ª–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç box-shadow
                box_shadow = "none"
            else:
                # –¢–Å–ú–ù–´–ô –ú–ê–¢–û–í–´–ô (solid, –±–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
                # –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é —Ç–µ–Ω—å –¥–ª—è depth
                bubble_bg = "rgb(43, 43, 48)"
                bubble_border = "rgba(60, 60, 65, 0.95)"  # –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ border
                text_color = "#f0f0f0"
                btn_bg = "rgb(38, 38, 42)"
                btn_bg_hover = "rgb(48, 48, 52)"
                btn_border = "rgba(58, 58, 62, 0.95)"
                # Subtle elevation —Å —Ç–µ–Ω—å—é
                box_shadow = "0 2px 8px rgba(0, 0, 0, 0.3)"
        else:
            # ‚ïê‚ïê‚ïê –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê ‚ïê‚ïê‚ïê
            if liquid_glass:
                # –°–í–ï–¢–õ–û–ï –°–¢–ï–ö–õ–û (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ, —Å blur)
                bubble_bg = "rgba(255, 255, 255, 0.45)"
                bubble_border = "rgba(255, 255, 255, 0.65)"
                text_color = "#1a202c"
                btn_bg = "rgba(255, 255, 255, 0.55)"
                btn_bg_hover = "rgba(255, 255, 255, 0.75)"
                btn_border = "rgba(255, 255, 255, 0.72)"
                # –°—Ç–µ–∫–ª–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç box-shadow
                box_shadow = "none"
            else:
                # –°–í–ï–¢–õ–´–ô –ú–ê–¢–û–í–´–ô (solid, –±–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
                # –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é —Ç–µ–Ω—å –¥–ª—è depth
                bubble_bg = "rgb(242, 242, 245)"
                bubble_border = "rgba(200, 200, 205, 0.95)"  # –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ border
                text_color = "#1a1a1a"
                btn_bg = "rgb(235, 235, 240)"
                btn_bg_hover = "rgb(225, 225, 230)"
                btn_border = "rgba(200, 200, 205, 0.95)"
                # Subtle elevation —Å —Ç–µ–Ω—å—é
                box_shadow = "0 2px 8px rgba(0, 0, 0, 0.15)"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–Ω–æ–ø–∫–∞—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö
        self.bubble_bg = bubble_bg
        self.bubble_border = bubble_border
        self.box_shadow = box_shadow
        self.btn_bg = btn_bg
        self.btn_bg_hover = btn_bg_hover
        self.btn_border = btn_border
        self.text_color = text_color
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏–∫–æ–Ω–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç liquid_glass –∏ —Ç–µ–º—ã
        if liquid_glass:
            if theme == "dark":
                self.icon_color = "#a0a0b0"
            else:
                self.icon_color = "#5a6aaa"
            self.hover_border_color = "rgba(102, 126, 234, 0.40)"
            self.pressed_border_color = "rgba(102, 126, 234, 0.55)"
        else:
            if theme == "dark":
                self.icon_color = "#a0a0b0"
            else:
                self.icon_color = "#5a6aaa"
            self.hover_border_color = btn_border
            self.pressed_border_color = btn_border

        # –∫—Ä–∞—Ç–∫–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞
        short = is_short_text(text)

        # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫
        btn_size = 36
        emoji_size = 15
        btn_radius = btn_size // 2

        # –≥–ª–∞–≤–Ω—ã–π layout
        main_layout = QtWidgets.QHBoxLayout(self)
        # –î–ª—è —Å–∏–º–º–µ—Ç—Ä–∏–∏: —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ, –ò–ò –≤–ª–µ–≤–æ
        if align == QtCore.Qt.AlignmentFlag.AlignRight:
            # –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –±–ª–∏–∂–µ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
            main_layout.setContentsMargins(80, 8, 6, 8)
        elif align == QtCore.Qt.AlignmentFlag.AlignLeft:
            # –°–æ–æ–±—â–µ–Ω–∏—è –ò–ò - –±–ª–∏–∂–µ –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é
            main_layout.setContentsMargins(6, 8, 80, 8)
        else:
            # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–≤–µ—Ä—Ö—É —Å —Ä–∞–≤–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
            main_layout.setContentsMargins(80, 8, 80, 8)
        main_layout.setSpacing(6)
        if align == QtCore.Qt.AlignmentFlag.AlignRight:
            main_layout.addStretch()
        elif speaker == "–°–∏—Å—Ç–µ–º–∞":
            # ‚úÖ –î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø—É–∑—ã—Ä—å
            main_layout.addStretch()

        # –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–∏–∫: –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) + –ø—É–∑—ã—Ä—å + –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ (–≤–Ω–µ –ø—É–∑—ã—Ä—è)
        col_widget = QtWidgets.QWidget()
        # ‚úÖ Minimum –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ - –ù–ï –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∂–∏–º–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        col_widget.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Preferred,
            QtWidgets.QSizePolicy.Policy.Minimum
        )
        col_layout = QtWidgets.QVBoxLayout(col_widget)
        col_layout.setContentsMargins(0, 0, 0, 0)
        col_layout.setSpacing(4)
        
        # –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –ò–ò, –µ—Å–ª–∏ thinking_time > 0)
        if speaker != "–í—ã" and speaker != "–°–∏—Å—Ç–µ–º–∞" and thinking_time > 0:
            time_label = QtWidgets.QLabel(f"‚è± –¥—É–º–∞–ª ~{thinking_time:.1f} —Å")
            time_label.setStyleSheet("""
                QLabel {
                    color: rgba(90, 106, 170, 0.75);
                    font-size: 11px;
                    font-style: italic;
                    padding: 2px 8px;
                    background: transparent;
                }
            """)
            time_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeft)
            col_layout.addWidget(time_label)

        # –ø—É–∑—ã—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è
        message_container = QtWidgets.QWidget()
        message_container.setObjectName("messageContainer")
        message_container.setMaximumWidth(900)
        message_container.setMinimumWidth(200)
        # ‚úÖ Minimum –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ - bubble –ù–ï —Å–∂–∏–º–∞–µ—Ç—Å—è –Ω–∏–∂–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        message_container.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Preferred,
            QtWidgets.QSizePolicy.Policy.Minimum
        )
        message_container.setStyleSheet(f"""
            #messageContainer {{
                background-color: {self.bubble_bg};
                border: 1px solid {self.bubble_border};
                border-radius: 24px;
                padding: 20px 26px;
            }}
        """)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        self.message_container = message_container
        
        container_layout = QtWidgets.QVBoxLayout(message_container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(4)  # –£–º–µ–Ω—å—à–µ–Ω–æ —Å 6 –¥–æ 4 –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –ø—É–∑—ã—Ä—è

        message_label = QtWidgets.QLabel()
        message_label.setWordWrap(True)
        message_label.setTextInteractionFlags(
            QtCore.Qt.TextInteractionFlag.TextSelectableByMouse |
            QtCore.Qt.TextInteractionFlag.TextSelectableByKeyboard
        )
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
        message_label.setMaximumWidth(850)
        # ‚úÖ Minimum –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ - —Ç–µ–∫—Å—Ç –ù–ï —Å–∂–∏–º–∞–µ—Ç—Å—è –Ω–∏–∂–µ —Å–≤–æ–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        message_label.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Expanding,
            QtWidgets.QSizePolicy.Policy.Minimum
        )
        
        font = QtGui.QFont("Inter", 18)
        message_label.setFont(font)
        message_label.setStyleSheet(f"""
            QLabel {{
                color: {self.text_color};
                padding: 8px;
                line-height: 1.6;
                word-wrap: break-word;
            }}
        """)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        self.message_label = message_label
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        formatted_text = format_text_with_markdown_and_math(text)
        display_text = f"<b style='color:{color};'>{speaker}:</b><br>{formatted_text}"
        message_label.setText(display_text)
        message_label.setTextFormat(QtCore.Qt.TextFormat.RichText)
        
        # ‚úÖ MessageWidget —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ–±—è, –ë–ï–ó —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª–µ–º
        # Layout –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞

        # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ–≥–æ –º–∞–ª–æ
        if short:
            message_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)

        container_layout.addWidget(message_label)


        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º
        if align == QtCore.Qt.AlignmentFlag.AlignCenter:
            # –°–∏—Å—Ç–µ–º–∞ - —Å—Ç—Ä–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            col_layout.addWidget(message_container, alignment=QtCore.Qt.AlignmentFlag.AlignCenter)
        elif align == QtCore.Qt.AlignmentFlag.AlignLeft:
            # AI - —Å–ª–µ–≤–∞
            col_layout.addWidget(message_container, alignment=QtCore.Qt.AlignmentFlag.AlignLeft)
        else:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–ø—Ä–∞–≤–∞
            col_layout.addWidget(message_container, alignment=QtCore.Qt.AlignmentFlag.AlignRight)

        # –†–µ—à–∞–µ–º —Å—Ç–æ—Ä–æ–Ω—É –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∫–Ω–æ–ø–æ–∫
        if speaker == "–í—ã":
            controls_side = "right"
        elif speaker == "–°–∏—Å—Ç–µ–º–∞":
            controls_side = "center"  # ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –∫–Ω–æ–ø–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        else:
            controls_side = "left"

        # –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ (–≤–Ω–µ –ø—É–∑—ã—Ä—è)
        controls_widget = QtWidgets.QWidget()
        controls_layout = QtWidgets.QHBoxLayout(controls_widget)
        controls_layout.setSpacing(10)
        bubble_padding = 18

        if controls_side == "left":
            controls_layout.setContentsMargins(bubble_padding, 0, 0, 6)
        elif controls_side == "right":
            controls_layout.setContentsMargins(0, 0, bubble_padding, 6)
        else:
            controls_layout.setContentsMargins(0, 0, 0, 6)

        # –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        copy_btn = QtWidgets.QPushButton()
        copy_btn.setText("üìã")
        copy_btn.setToolTip("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å")
        copy_btn.setFixedSize(btn_size, btn_size)
        copy_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        copy_btn.clicked.connect(self.copy_text)
        copy_btn.setVisible(add_controls)
        copy_btn.setObjectName("floatingControl")
        copy_btn.setStyleSheet(f"""
            QPushButton#floatingControl {{
                background: {self.btn_bg};
                color: {self.icon_color};
                border: 1px solid {self.btn_border};
                border-radius: {btn_radius}px;
                font-size: {emoji_size}px;
            }}
            QPushButton#floatingControl:hover {{ 
                background: {self.btn_bg_hover};
                border: 1px solid {self.hover_border_color};
            }}
            QPushButton#floatingControl:pressed {{ 
                background: {self.btn_bg_hover};
                border: 1px solid {self.pressed_border_color};
            }}
        """)
        self.copy_button = copy_btn  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        controls_layout.addWidget(copy_btn, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)
        # –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        if speaker == "–í—ã":
            edit_btn = QtWidgets.QPushButton()
            edit_btn.setText("‚úèÔ∏è")
            edit_btn.setToolTip("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å")
            edit_btn.setFixedSize(btn_size, btn_size)
            edit_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            edit_btn.clicked.connect(self.edit_message)
            edit_btn.setVisible(add_controls)
            edit_btn.setObjectName("floatingControl")
            edit_btn.setStyleSheet(f"""
                QPushButton#floatingControl {{
                    background: {self.btn_bg};
                    color: {self.icon_color};
                    border: 1px solid {self.btn_border};
                    border-radius: {btn_radius}px;
                    font-size: {emoji_size}px;
                }}
                QPushButton#floatingControl:hover {{ 
                    background: {self.btn_bg_hover};
                    border: 1px solid {self.hover_border_color};
                }}
                QPushButton#floatingControl:pressed {{ 
                    background: {self.btn_bg_hover};
                    border: 1px solid {self.pressed_border_color};
                }}
            """)
            controls_layout.addWidget(edit_btn, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)

        
        # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
        if speaker != "–í—ã" and speaker != "–°–∏—Å—Ç–µ–º–∞" and add_controls:
            regenerate_btn = QtWidgets.QPushButton()
            regenerate_btn.setText("üîÑ")
            regenerate_btn.setToolTip("–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç")
            regenerate_btn.setFixedSize(btn_size, btn_size)
            regenerate_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            regenerate_btn.clicked.connect(self.regenerate_response)
            regenerate_btn.setVisible(add_controls)
            regenerate_btn.setObjectName("floatingControl")
            regenerate_btn.setStyleSheet(f"""
                QPushButton#floatingControl {{
                    background: {self.btn_bg};
                    color: {self.icon_color};
                    border: 1px solid {self.btn_border};
                    border-radius: {btn_radius}px;
                    font-size: {emoji_size}px;
                }}
                QPushButton#floatingControl:hover {{ 
                    background: {self.btn_bg_hover};
                    border: 1px solid {self.hover_border_color};
                }}
                QPushButton#floatingControl:pressed {{ 
                    background: {self.btn_bg_hover};
                    border: 1px solid {self.pressed_border_color};
                }}
            """)
            controls_layout.addWidget(regenerate_btn, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)

        controls_widget.setVisible(add_controls)

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–¥ –ø—É–∑—ã—Ä—ë–º
        if controls_side == "left":
            col_layout.addWidget(controls_widget, alignment=QtCore.Qt.AlignmentFlag.AlignLeft)
        elif controls_side == "right":
            col_layout.addWidget(controls_widget, alignment=QtCore.Qt.AlignmentFlag.AlignRight)
        else:
            col_layout.addWidget(controls_widget, alignment=QtCore.Qt.AlignmentFlag.AlignHCenter)
        
        # –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –≥–ª–∞–≤–Ω—ã–π layout
        main_layout.addWidget(col_widget)
        if align == QtCore.Qt.AlignmentFlag.AlignLeft:
            main_layout.addStretch()
        elif speaker == "–°–∏—Å—Ç–µ–º–∞":
            # ‚úÖ –î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¥–æ–±–∞–≤–ª—è–µ–º stretch –ü–û–°–õ–ï –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            main_layout.addStretch()
        
        # ‚úÖ –¢–û–õ–¨–ö–û FADE-IN –ê–ù–ò–ú–ê–¶–ò–Ø: –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
        # –ù–∏–∫–∞–∫–∏—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –ø–æ–∑–∏—Ü–∏–µ–π, —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏–ª–∏ margins!
        # Layout –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∏ —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–∂–µ—Ç–∞
        if not IS_WINDOWS:
            # –°–æ–∑–¥–∞—ë–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏: 0 ‚Üí 1 (fade-in —ç—Ñ—Ñ–µ–∫—Ç)
            self.fade_in_animation = QtCore.QPropertyAnimation(self.opacity_effect, b"opacity")
            self.fade_in_animation.setDuration(300)
            self.fade_in_animation.setStartValue(0.0)
            self.fade_in_animation.setEndValue(1.0)
            self.fade_in_animation.setEasingCurve(QtCore.QEasingCurve.Type.OutCubic)
            
            # ‚úÖ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –æ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–∞ –∏–∑ add_message_widget
            # –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è layout
        else:
            # –ù–∞ Windows —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
            self.opacity_effect.setOpacity(1.0)

    def _start_appear_animation(self):
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ fade-in –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏).
        
        –í–ê–ñ–ù–û: –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ finished - —ç—Ç–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å layout!
        –≠—Ñ—Ñ–µ–∫—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Å opacity=1.0 –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏.
        """
        if hasattr(self, 'fade_in_animation'):
            self.fade_in_animation.start()
    
    def _cleanup_graphics_effect(self):
        """
        –ó–∞–≤–µ—Ä—à–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å.
        
        –í–ê–ñ–ù–û: –ù–ï —É–¥–∞–ª—è–µ–º graphicsEffect! 
        –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è fade_out_and_delete() –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∏–¥–∂–µ—Ç–∞.
        """
        try:
            if hasattr(self, 'opacity_effect') and self.opacity_effect is not None:
                # –ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—É—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                self.opacity_effect.setOpacity(1.0)
        except RuntimeError:
            # –û–±—ä–µ–∫—Ç —É–∂–µ —É–¥–∞–ª—ë–Ω - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            pass

    def update_message_styles(self, theme: str, liquid_glass: bool):
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∏–ª–∏ –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–º—ã –∏–ª–∏ liquid_glass.
        
        –í–ê–ñ–ù–û: –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –≤–∏–¥–∂–µ—Ç, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∏–ª–∏.
        Layout –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - theme: "light" –∏–ª–∏ "dark"
        - liquid_glass: True/False
        """
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        self.current_theme = theme
        self.current_liquid_glass = liquid_glass
        
        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ —Ç–æ–π –∂–µ –ª–æ–≥–∏–∫–µ —á—Ç–æ –∏ –≤ __init__
        if theme == "dark":
            if liquid_glass:
                # –¢–Å–ú–ù–û–ï –°–¢–ï–ö–õ–û
                bubble_bg = "rgba(35, 35, 40, 0.75)"
                bubble_border = "rgba(50, 50, 55, 0.6)"
                text_color = "#f0f0f0"
                btn_bg = "rgba(45, 45, 50, 0.55)"
                btn_bg_hover = "rgba(55, 55, 60, 0.65)"
                btn_border = "rgba(60, 60, 65, 0.4)"
                icon_color = "#a0a0b0"
                hover_border_color = "rgba(102, 126, 234, 0.40)"
                pressed_border_color = "rgba(102, 126, 234, 0.55)"
            else:
                # –¢–Å–ú–ù–´–ô –ú–ê–¢–û–í–´–ô (—Å —á—É—Ç—å —Ç–µ–º–Ω–µ–µ border –¥–ª—è depth)
                bubble_bg = "rgb(43, 43, 48)"
                bubble_border = "rgba(60, 60, 65, 0.95)"
                text_color = "#f0f0f0"
                btn_bg = "rgb(38, 38, 42)"
                btn_bg_hover = "rgb(48, 48, 52)"
                btn_border = "rgba(58, 58, 62, 0.95)"
                icon_color = "#a0a0b0"
                hover_border_color = btn_border
                pressed_border_color = btn_border
        else:
            if liquid_glass:
                # –°–í–ï–¢–õ–û–ï –°–¢–ï–ö–õ–û
                bubble_bg = "rgba(255, 255, 255, 0.45)"
                bubble_border = "rgba(255, 255, 255, 0.65)"
                text_color = "#1a202c"
                btn_bg = "rgba(255, 255, 255, 0.55)"
                btn_bg_hover = "rgba(255, 255, 255, 0.75)"
                btn_border = "rgba(255, 255, 255, 0.72)"
                icon_color = "#5a6aaa"
                hover_border_color = "rgba(102, 126, 234, 0.40)"
                pressed_border_color = "rgba(102, 126, 234, 0.55)"
            else:
                # –°–í–ï–¢–õ–´–ô –ú–ê–¢–û–í–´–ô (—Å —á—É—Ç—å —Ç–µ–º–Ω–µ–µ border –¥–ª—è depth)
                bubble_bg = "rgb(242, 242, 245)"
                bubble_border = "rgba(200, 200, 205, 0.95)"
                text_color = "#1a1a1a"
                btn_bg = "rgb(235, 235, 240)"
                btn_bg_hover = "rgb(225, 225, 230)"
                btn_border = "rgba(200, 200, 205, 0.95)"
                icon_color = "#5a6aaa"
                hover_border_color = btn_border
                pressed_border_color = btn_border
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏
        self.bubble_bg = bubble_bg
        self.bubble_border = bubble_border
        self.btn_bg = btn_bg
        self.btn_bg_hover = btn_bg_hover
        self.btn_border = btn_border
        self.text_color = text_color
        self.icon_color = icon_color
        self.hover_border_color = hover_border_color
        self.pressed_border_color = pressed_border_color
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ message_container
        if hasattr(self, 'message_container') and self.message_container:
            self.message_container.setStyleSheet(f"""
                #messageContainer {{
                    background-color: {bubble_bg};
                    border: 1px solid {bubble_border};
                    border-radius: 24px;
                    padding: 20px 26px;
                }}
            """)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ message_label
        if hasattr(self, 'message_label') and self.message_label:
            self.message_label.setStyleSheet(f"""
                QLabel {{
                    color: {text_color};
                    padding: 8px;
                    line-height: 1.6;
                    word-wrap: break-word;
                }}
            """)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
        btn_size = 36
        btn_radius = btn_size // 2
        emoji_size = 15
        
        button_style = f"""
            QPushButton#floatingControl {{
                background: {btn_bg};
                color: {icon_color};
                border: 1px solid {btn_border};
                border-radius: {btn_radius}px;
                font-size: {emoji_size}px;
            }}
            QPushButton#floatingControl:hover {{ 
                background: {btn_bg_hover};
                border: 1px solid {hover_border_color};
            }}
            QPushButton#floatingControl:pressed {{ 
                background: {btn_bg_hover};
                border: 1px solid {pressed_border_color};
            }}
        """
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∫–Ω–æ–ø–∫–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        if hasattr(self, 'copy_button') and self.copy_button:
            self.copy_button.setStyleSheet(button_style)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –¥—Ä—É–≥–∏–º –∫–Ω–æ–ø–∫–∞–º –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ –≤–∏–¥–∂–µ—Ç–µ
        for button in self.findChildren(QtWidgets.QPushButton):
            if button.objectName() == "floatingControl":
                button.setStyleSheet(button_style)
        
        print(f"[MSG_UPDATE] –°—Ç–∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: theme={theme}, liquid_glass={liquid_glass}")


    def copy_text(self):
        clipboard = QtWidgets.QApplication.clipboard()
        clipboard.setText(self.text)
        
        # –ê–Ω–∏–º–∞—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–æ—á–∫—É
        if self.copy_button:
            original_text = self.copy_button.text()
            self.copy_button.setText("‚úì")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
            QtCore.QTimer.singleShot(1500, lambda: self.copy_button.setText(original_text) if self.copy_button else None)
    
    def fade_out_and_delete(self):
        """
        –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å.
        
        –í–ê–ñ–ù–û: –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–æ –≤—Å–µ—Ö —Ç–µ–º–∞—Ö (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è).
        –°—Ç–∏–ª—å —Ç–µ–º—ã –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ö–∞–Ω–∏–∑–º —É–¥–∞–ª–µ–Ω–∏—è.
        """
        # –ù–∞ Windows GraphicsOpacityEffect —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
        if IS_WINDOWS:
            # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è Windows –±–µ–∑ GraphicsOpacityEffect
            try:
                # –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–Ω–∞ Windows –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å repaint)
                self.deleteLater()
            except Exception as e:
                print(f"[FADE_OUT] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ Windows: {e}")
            return
        
        # –î–ª—è macOS –∏ Linux - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å opacity
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ opacity_effect
        if not hasattr(self, 'opacity_effect') or self.opacity_effect is None:
            # –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç —É–¥–∞–ª—ë–Ω - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
            self.opacity_effect = QtWidgets.QGraphicsOpacityEffect(self)
            self.setGraphicsEffect(self.opacity_effect)
            self.opacity_effect.setOpacity(1.0)
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ C++
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å - –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç —É–¥–∞–ª—ë–Ω, –±—É–¥–µ—Ç RuntimeError
            current_opacity = self.opacity_effect.opacity()
        except RuntimeError:
            # –û–±—ä–µ–∫—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ C++ - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
            self.opacity_effect = QtWidgets.QGraphicsOpacityEffect(self)
            self.setGraphicsEffect(self.opacity_effect)
            self.opacity_effect.setOpacity(1.0)
        
        # ‚úÖ –¢–û–õ–¨–ö–û fade-out –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏, –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã
        # Layout —Å–∞–º –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
        # –ö–†–ò–¢–ò–ß–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º—ã - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–µ–∑–¥–µ
        self.fade_out_animation = QtCore.QPropertyAnimation(self.opacity_effect, b"opacity")
        self.fade_out_animation.setDuration(350)  # –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        self.fade_out_animation.setStartValue(1.0)
        self.fade_out_animation.setEndValue(0.0)
        self.fade_out_animation.setEasingCurve(QtCore.QEasingCurve.Type.OutCubic)  # –ü–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
        
        # –£–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è fade-out
        def safe_delete():
            try:
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                if hasattr(self, 'fade_out_animation') and self.fade_out_animation:
                    self.fade_out_animation.stop()
                    self.fade_out_animation = None
                # –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç
                if self.graphicsEffect():
                    self.setGraphicsEffect(None)
                # –û–±–Ω—É–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ opacity_effect
                if hasattr(self, 'opacity_effect'):
                    self.opacity_effect = None
                # –£–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç
                self.deleteLater()
                print("[FADE_OUT] –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–ª–∞–≤–Ω–æ —É–¥–∞–ª–µ–Ω–æ")
            except RuntimeError:
                # –û–±—ä–µ–∫—Ç —É–∂–µ —É–¥–∞–ª—ë–Ω
                print("[FADE_OUT] –û–±—ä–µ–∫—Ç —É–∂–µ —É–¥–∞–ª—ë–Ω (RuntimeError)")
                pass
            except Exception as e:
                print(f"[FADE_OUT] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")
        
        self.fade_out_animation.finished.connect(safe_delete)
        self.fade_out_animation.start()
        
        print("[FADE_OUT] –ó–∞–ø—É—â–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è fade-out (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö —Ç–µ–º)")


    def regenerate_response(self):
        """–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É
        parent_window = self.window()
        if hasattr(parent_window, 'regenerate_last_response'):
            parent_window.regenerate_last_response()
    
    def edit_message(self):
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        parent_window = self.window()
        if hasattr(parent_window, 'edit_last_message'):
            parent_window.edit_last_message(self.text)
    

# -------------------------
# Worker
# -------------------------
class WorkerSignals(QtCore.QObject):
    finished = QtCore.pyqtSignal(str)

class AIWorker(QtCore.QRunnable):
    def __init__(self, user_message: str, current_language: str, deep_thinking: bool, use_search: bool, should_forget: bool = False, chat_manager=None, chat_id=None, file_path: str = None, ai_mode: str = AI_MODE_FAST):
        super().__init__()
        self.user_message = user_message
        self.current_language = current_language
        self.deep_thinking = deep_thinking
        self.use_search = use_search
        self.should_forget = should_forget
        self.chat_manager = chat_manager
        self.chat_id = chat_id
        self.file_path = file_path
        self.ai_mode = ai_mode  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∂–∏–º AI
        self.signals = WorkerSignals()

    @QtCore.pyqtSlot()
    def run(self):
        try:
            response = get_ai_response(
                self.user_message,
                self.current_language,
                self.deep_thinking,
                self.use_search,
                self.should_forget,
                self.chat_manager,
                self.chat_id,
                self.file_path,
                self.ai_mode  # –ü–µ—Ä–µ–¥–∞—ë–º —Ä–µ–∂–∏–º AI
            )
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π emit - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ signals –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if hasattr(self, 'signals') and self.signals is not None:
                try:
                    self.signals.finished.emit(response)
                except RuntimeError:
                    # Signals —É–∂–µ —É–¥–∞–ª—ë–Ω - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    pass
        except Exception as e:
            # ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π emit –¥–ª—è –æ—à–∏–±–∫–∏
            if hasattr(self, 'signals') and self.signals is not None:
                try:
                    self.signals.finished.emit(f"[–û—à–∏–±–∫–∞] {e}")
                except RuntimeError:
                    pass

# -------------------------
# Main Window
# -------------------------

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ 1: SCROLL TO BOTTOM BUTTON
# Floating overlay –∫–Ω–æ–ø–∫–∞ "‚¨á –≤–Ω–∏–∑" - –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ layout
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class ScrollToBottomButton(QtWidgets.QPushButton):
    """
    Floating overlay –∫–Ω–æ–ø–∫–∞ "‚¨á –≤–Ω–∏–∑" –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ –∫ –Ω–∏–∑—É.
    
    –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
    - –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ layout —Å–æ–æ–±—â–µ–Ω–∏–π
    - –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
    - –¢–æ–ª—å–∫–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ª–∏—á–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–∏–∑—É
    - –ü–æ–∑–∏—Ü–∏—è: overlay –ø–æ–≤–µ—Ä—Ö scroll_area
    """
    
    def __init__(self, parent=None):
        super().__init__("‚¨á", parent)
        
        self.setObjectName("scrollToBottomBtn")
        self.setFixedSize(50, 50)
        self.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        
        # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞
        self.hide()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ + glass)
        self.apply_theme_styles(theme="light", liquid_glass=True)
    
    def apply_theme_styles(self, theme: str = "light", liquid_glass: bool = True):
        """
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã –∏ liquid glass.
        
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–º—ã.
        """
        if theme == "dark":
            if liquid_glass:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û - —Ç—ë–º–Ω–æ–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Å—Ç–µ–∫–ª–æ
                bg_start = "rgba(35, 35, 40, 0.75)"
                bg_end = "rgba(28, 28, 32, 0.75)"
                border = "rgba(50, 50, 55, 0.6)"
                hover_bg_start = "rgba(45, 45, 50, 0.85)"
                hover_bg_end = "rgba(38, 38, 42, 0.85)"
                hover_border = "rgba(139, 92, 246, 0.5)"
                text_color = "#e6e6e6"
                shadow_color = "rgba(0, 0, 0, 0.7)"
            else:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –º–∞—Ç–æ–≤—ã–π —Ç—ë–º–Ω—ã–π
                bg_start = "rgb(43, 43, 48)"
                bg_end = "rgb(38, 38, 42)"
                border = "rgba(60, 60, 65, 0.95)"
                hover_bg_start = "rgb(53, 53, 58)"
                hover_bg_end = "rgb(48, 48, 52)"
                hover_border = "rgba(139, 92, 246, 0.7)"
                text_color = "#f0f0f0"
                shadow_color = "rgba(0, 0, 0, 0.5)"
        else:
            if liquid_glass:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û - —Å–≤–µ—Ç–ª–æ–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Å—Ç–µ–∫–ª–æ
                bg_start = "rgba(255, 255, 255, 0.75)"
                bg_end = "rgba(255, 255, 255, 0.65)"
                border = "rgba(255, 255, 255, 0.85)"
                hover_bg_start = "rgba(255, 255, 255, 0.90)"
                hover_bg_end = "rgba(255, 255, 255, 0.80)"
                hover_border = "rgba(102, 126, 234, 0.65)"
                text_color = "#2d3748"
                shadow_color = "rgba(0, 0, 0, 0.15)"
            else:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –º–∞—Ç–æ–≤—ã–π —Å–≤–µ—Ç–ª—ã–π
                bg_start = "rgb(242, 242, 245)"
                bg_end = "rgb(235, 235, 240)"
                border = "rgba(210, 210, 215, 0.95)"
                hover_bg_start = "rgb(235, 235, 240)"
                hover_bg_end = "rgb(225, 225, 230)"
                hover_border = "rgba(102, 126, 234, 0.8)"
                text_color = "#1a1a1a"
                shadow_color = "rgba(0, 0, 0, 0.2)"
        
        self.setStyleSheet(f"""
            #scrollToBottomBtn {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {bg_start},
                    stop:1 {bg_end});
                border: 1px solid {border};
                border-radius: 25px;
                color: {text_color};
                font-size: 20px;
                font-weight: bold;
            }}
            #scrollToBottomBtn:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {hover_bg_start},
                    stop:1 {hover_bg_end});
                border: 1px solid {hover_border};
            }}
        """)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–Ω—å
        shadow = QtWidgets.QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(15)
        shadow.setColor(QtGui.QColor(shadow_color))
        shadow.setOffset(0, 4)
        self.setGraphicsEffect(shadow)
    
    def update_position(self, parent_width, parent_height):
        """
        –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∫–Ω–æ–ø–∫–∏ (—Ü–µ–Ω—Ç—Ä —Å–Ω–∏–∑—É).
        –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ resize.
        """
        x = (parent_width - self.width()) // 2
        y = parent_height - self.height() - 90  # 90px –æ—Ç –Ω–∏–∑–∞ (–Ω–µ –Ω–∞–ª–µ–∑–∞–µ—Ç –Ω–∞ input bar)
        self.move(x, y)
        self.raise_()


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ 2: SETTINGS VIEW
# –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –∑–∞–º–µ–Ω–∞ chat_area
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class SettingsView(QtWidgets.QWidget):
    """
    –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
    - –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ messages_layout
    - –ù–ï —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    - –ó–∞–º–µ–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ chat_container —á–µ—Ä–µ–∑ QStackedWidget
    - Sidebar –∏ input bar –æ—Å—Ç–∞—é—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏
    """
    
    # –°–∏–≥–Ω–∞–ª—ã
    settings_applied = QtCore.pyqtSignal(dict)
    close_requested = QtCore.pyqtSignal()
    
    def __init__(self, parent=None):
        super().__init__(parent)
        
        self.setObjectName("settingsView")
        
        # –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ)
        self.current_settings = {
            "theme": "light",
            "liquid_glass": True,
        }
        
        # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (pending - –¥–æ –Ω–∞–∂–∞—Ç–∏—è "–ü—Ä–∏–º–µ–Ω–∏—Ç—å")
        self.pending_settings = {
            "theme": "light",
            "liquid_glass": True,
        }
        
        self.init_ui()
        self.load_settings()
    
    def init_ui(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI"""
        
        main_layout = QtWidgets.QVBoxLayout(self)
        main_layout.setContentsMargins(50, 50, 50, 50)
        main_layout.setSpacing(35)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title = QtWidgets.QLabel("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        title.setObjectName("settingsTitle")
        title.setFont(QtGui.QFont("Inter", 32, QtGui.QFont.Weight.Bold))
        title.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
        main_layout.addWidget(title)
        
        main_layout.addSpacing(25)
        
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settings_container = QtWidgets.QWidget()
        settings_container.setObjectName("settingsContainer")
        settings_layout = QtWidgets.QVBoxLayout(settings_container)
        settings_layout.setSpacing(30)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–ê–°–¢–†–û–ô–ö–ê 1: –¢–µ–º–∞
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        theme_group = self.create_setting_group(
            "–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è",
            "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–≤–µ—Ç–ª–æ–π –∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º–æ–π"
        )
        
        theme_layout = QtWidgets.QHBoxLayout()
        theme_layout.setSpacing(15)
        
        self.theme_light_btn = QtWidgets.QPushButton("‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è")
        self.theme_light_btn.setObjectName("themeLightBtn")
        self.theme_light_btn.setCheckable(True)
        self.theme_light_btn.setChecked(True)
        self.theme_light_btn.clicked.connect(lambda: self.set_theme("light"))
        
        self.theme_dark_btn = QtWidgets.QPushButton("üåô –¢—ë–º–Ω–∞—è")
        self.theme_dark_btn.setObjectName("themeDarkBtn")
        self.theme_dark_btn.setCheckable(True)
        self.theme_dark_btn.clicked.connect(lambda: self.set_theme("dark"))
        
        theme_layout.addWidget(self.theme_light_btn)
        theme_layout.addWidget(self.theme_dark_btn)
        
        theme_group.layout().addLayout(theme_layout)
        settings_layout.addWidget(theme_group)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–ê–°–¢–†–û–ô–ö–ê 2: Liquid Glass - –£–î–ê–õ–ï–ù–û
        # Liquid Glass —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        main_layout.addWidget(settings_container)
        main_layout.addStretch()
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        actions_layout = QtWidgets.QHBoxLayout()
        actions_layout.setSpacing(15)
        
        back_btn = QtWidgets.QPushButton("‚Üê –ù–∞–∑–∞–¥ –∫ —á–∞—Ç—É")
        back_btn.setObjectName("settingsBackBtn")
        back_btn.setFont(QtGui.QFont("Inter", 14, QtGui.QFont.Weight.Medium))
        back_btn.setMinimumHeight(50)
        back_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        back_btn.clicked.connect(self.close_requested.emit)
        
        apply_btn = QtWidgets.QPushButton("‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å")
        apply_btn.setObjectName("settingsApplyBtn")
        apply_btn.setFont(QtGui.QFont("Inter", 14, QtGui.QFont.Weight.Bold))
        apply_btn.setMinimumHeight(50)
        apply_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        apply_btn.clicked.connect(self.apply_settings)
        
        actions_layout.addWidget(back_btn)
        actions_layout.addWidget(apply_btn)
        
        main_layout.addLayout(actions_layout)
        
        self.apply_settings_styles()
    
    def create_setting_group(self, title: str, description: str) -> QtWidgets.QGroupBox:
        """–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        
        group = QtWidgets.QGroupBox()
        group.setObjectName("settingGroup")
        
        layout = QtWidgets.QVBoxLayout(group)
        layout.setSpacing(12)
        
        title_label = QtWidgets.QLabel(title)
        title_label.setFont(QtGui.QFont("Inter", 18, QtGui.QFont.Weight.Bold))
        layout.addWidget(title_label)
        
        desc_label = QtWidgets.QLabel(description)
        desc_label.setObjectName("descLabel")
        desc_label.setFont(QtGui.QFont("Inter", 13))
        desc_label.setStyleSheet("color: #475569;")
        layout.addWidget(desc_label)
        
        return group
    
    def set_theme(self, theme: str):
        """
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É –í–ò–ó–£–ê–õ–¨–ù–û (pending state).
        
        –í–ê–ñ–ù–û: –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª–∏ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é!
        –¢–æ–ª—å–∫–æ –º–µ–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞.
        –†–µ–∞–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å".
        """
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ pending settings
        self.pending_settings["theme"] = theme
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        self.theme_light_btn.setChecked(theme == "light")
        self.theme_dark_btn.setChecked(theme == "dark")
        
        # –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏! –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        print(f"[SETTINGS] –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞: {theme} (pending, –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)")
    
    def set_liquid_glass(self, enabled: bool):
        """
        Liquid Glass —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π - –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
        –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø.
        """
        # –ó–∞–≥–ª—É—à–∫–∞ - liquid_glass –≤—Å–µ–≥–¥–∞ True
        pass
    
    def load_settings(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        try:
            if os.path.exists("app_settings.json"):
                with open("app_settings.json", "r", encoding="utf-8") as f:
                    saved = json.load(f)
                    self.current_settings.update(saved)
                    # –ö–æ–ø–∏—Ä—É–µ–º –≤ pending settings
                    self.pending_settings.update(saved)
        except Exception as e:
            print(f"[SETTINGS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        
        # LIQUID GLASS –§–ò–ö–°–ò–†–û–í–ê–ù - –í–°–ï–ì–î–ê TRUE
        self.current_settings["liquid_glass"] = True
        self.pending_settings["liquid_glass"] = True
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ current settings
        theme = self.current_settings.get("theme", "light")
        
        self.theme_light_btn.setChecked(theme == "light")
        self.theme_dark_btn.setChecked(theme == "dark")
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ —Å–∞–º–æ–º—É –æ–∫–Ω—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
        self.apply_settings_styles()
    
    def save_settings(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        try:
            with open("app_settings.json", "w", encoding="utf-8") as f:
                json.dump(self.current_settings, f, indent=2)
            print("[SETTINGS] ‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        except Exception as e:
            print(f"[SETTINGS] ‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
    
    def apply_settings(self):
        """
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.
        
        –í–ê–ñ–ù–û: –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ pending_settings –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ current_settings
        –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∏–≥–Ω–∞–ª settings_applied.
        """
        # –ö–æ–ø–∏—Ä—É–µ–º pending settings –≤ current settings
        self.current_settings.update(self.pending_settings)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        self.save_settings()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –≥–ª–∞–≤–Ω–æ–º—É –æ–∫–Ω—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        self.settings_applied.emit(self.current_settings)
        
        print(f"[SETTINGS] ‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã: {self.current_settings}")
        # –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è
    
    def apply_settings_styles(self):
        """–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–µ–º"""
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        theme = self.current_settings.get("theme", "light")
        liquid_glass = self.current_settings.get("liquid_glass", True)
        
        print(f"[SETTINGS_VIEW] apply_settings_styles: theme={theme}, liquid_glass={liquid_glass}")
        
        if theme == "dark":
            if liquid_glass:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û - —Ç—ë–º–Ω–æ–µ —Å—Ç–µ–∫–ª–æ
                colors = {
                    "bg": "rgba(24, 24, 28, 0.65)",
                    "title": "#e6e6e6",
                    "group_bg": "rgba(30, 30, 35, 0.60)",
                    "group_border": "rgba(50, 50, 55, 0.5)",
                    "text": "#e6e6e6",
                    "desc": "#b0b0b0",
                    "btn_bg": "rgba(45, 45, 50, 0.50)",
                    "btn_border": "rgba(60, 60, 65, 0.40)",
                    "btn_text": "#b0b0b0",
                    "btn_checked_bg_start": "rgba(139, 92, 246, 0.70)",
                    "btn_checked_bg_end": "rgba(124, 58, 237, 0.70)",
                    "btn_checked_border": "rgba(139, 92, 246, 0.80)",
                    "btn_hover_bg": "rgba(55, 55, 60, 0.70)",
                    "btn_hover_border": "rgba(139, 92, 246, 0.40)",
                    "back_btn_bg": "rgba(30, 30, 35, 0.60)",
                    "back_btn_border": "rgba(50, 50, 55, 0.60)",
                    "back_btn_text": "#b0b0b0",
                    "apply_btn_start": "rgba(34, 197, 94, 0.70)",
                    "apply_btn_end": "rgba(22, 163, 74, 0.80)",
                    "apply_btn_border": "rgba(34, 197, 94, 0.80)",
                }
            else:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –º–∞—Ç–æ–≤—ã–π —Ç—ë–º–Ω—ã–π
                colors = {
                    "bg": "rgb(28, 28, 31)",
                    "title": "#f0f0f0",
                    "group_bg": "rgb(32, 32, 36)",
                    "group_border": "rgba(55, 55, 60, 0.9)",
                    "text": "#f0f0f0",
                    "desc": "#c0c0c0",
                    "btn_bg": "rgb(48, 48, 52)",
                    "btn_border": "rgba(68, 68, 72, 0.95)",
                    "btn_text": "#c0c0c0",
                    "btn_checked_bg_start": "rgba(139, 92, 246, 1.0)",
                    "btn_checked_bg_end": "rgba(124, 58, 237, 1.0)",
                    "btn_checked_border": "rgba(139, 92, 246, 1.0)",
                    "btn_hover_bg": "rgb(58, 58, 62)",
                    "btn_hover_border": "rgba(139, 92, 246, 0.6)",
                    "back_btn_bg": "rgb(32, 32, 36)",
                    "back_btn_border": "rgba(55, 55, 60, 0.95)",
                    "back_btn_text": "#c0c0c0",
                    "apply_btn_start": "rgba(34, 197, 94, 1.0)",
                    "apply_btn_end": "rgba(22, 163, 74, 1.0)",
                    "apply_btn_border": "rgba(34, 197, 94, 1.0)",
                }
        else:
            # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê
            if liquid_glass:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û
                colors = {
                    "bg": "rgba(255, 255, 255, 0.55)",
                    "title": "#222222",
                    "group_bg": "rgba(255, 255, 255, 0.75)",
                    "group_border": "rgba(255, 255, 255, 0.85)",
                    "text": "#222222",
                    "desc": "#5a5a5a",
                    "btn_bg": "rgba(255, 255, 255, 0.65)",
                    "btn_border": "rgba(203, 213, 225, 0.55)",
                    "btn_text": "#3a3a3a",
                    "btn_checked_bg_start": "rgba(102, 126, 234, 0.80)",
                    "btn_checked_bg_end": "rgba(118, 75, 162, 0.80)",
                    "btn_checked_border": "rgba(102, 126, 234, 0.90)",
                    "btn_hover_bg": "rgba(255, 255, 255, 0.85)",
                    "btn_hover_border": "rgba(102, 126, 234, 0.50)",
                    "back_btn_bg": "rgba(255, 255, 255, 0.75)",
                    "back_btn_border": "rgba(203, 213, 225, 0.75)",
                    "back_btn_text": "#3a3a3a",
                    "apply_btn_start": "rgba(34, 197, 94, 0.80)",
                    "apply_btn_end": "rgba(22, 163, 74, 0.90)",
                    "apply_btn_border": "rgba(34, 197, 94, 0.90)",
                }
            else:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –ø–ª–æ—Å–∫–∏–π
                colors = {
                    "bg": "rgb(246, 246, 248)",
                    "title": "#1a1a1a",
                    "group_bg": "rgb(252, 252, 254)",
                    "group_border": "rgba(210, 210, 215, 0.95)",
                    "text": "#1a1a1a",
                    "desc": "#4a4a4a",
                    "btn_bg": "rgb(242, 242, 245)",
                    "btn_border": "rgba(210, 210, 215, 0.95)",
                    "btn_text": "#2a2a2a",
                    "btn_checked_bg_start": "rgba(102, 126, 234, 1.0)",
                    "btn_checked_bg_end": "rgba(118, 75, 162, 1.0)",
                    "btn_checked_border": "rgba(102, 126, 234, 1.0)",
                    "btn_hover_bg": "rgb(235, 235, 240)",
                    "btn_hover_border": "rgba(102, 126, 234, 0.7)",
                    "back_btn_bg": "rgb(246, 246, 248)",
                    "back_btn_border": "rgba(210, 210, 215, 0.95)",
                    "back_btn_text": "#2a2a2a",
                    "apply_btn_start": "rgba(34, 197, 94, 1.0)",
                    "apply_btn_end": "rgba(22, 163, 74, 1.0)",
                    "apply_btn_border": "rgba(34, 197, 94, 1.0)",
                }
        
        style = f"""
            #settingsView {{
                background: {colors["bg"]};
            }}
            
            #settingsTitle {{
                color: {colors["title"]};
                font-size: 32px;
            }}
            
            #settingGroup {{
                background: {colors["group_bg"]};
                border: 1px solid {colors["group_border"]};
                border-radius: 18px;
                padding: 24px;
            }}
            
            #settingGroup QLabel {{
                color: {colors["text"]};
            }}
            
            #settingGroup QLabel[objectName="descLabel"] {{
                color: {colors["desc"]};
            }}
            
            #themeLightBtn, #themeDarkBtn,
            #glassOnBtn, #glassOffBtn {{
                background: {colors["btn_bg"]};
                border: 2px solid {colors["btn_border"]};
                border-radius: 12px;
                padding: 16px 22px;
                font-size: 15px;
                font-weight: 600;
                color: {colors["btn_text"]};
                min-height: 50px;
            }}
            
            #themeLightBtn:checked, #themeDarkBtn:checked,
            #glassOnBtn:checked, #glassOffBtn:checked {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {colors["btn_checked_bg_start"]},
                    stop:1 {colors["btn_checked_bg_end"]});
                border: 2px solid {colors["btn_checked_border"]};
                color: white;
            }}
            
            #themeLightBtn:hover, #themeDarkBtn:hover,
            #glassOnBtn:hover, #glassOffBtn:hover {{
                background: {colors["btn_hover_bg"]};
                border: 2px solid {colors["btn_hover_border"]};
            }}
            
            #settingsBackBtn {{
                background: {colors["back_btn_bg"]};
                border: 2px solid {colors["back_btn_border"]};
                border-radius: 14px;
                color: {colors["back_btn_text"]};
            }}
            
            #settingsBackBtn:hover {{
                background: {colors["btn_hover_bg"]};
                border: 2px solid {colors["btn_hover_border"]};
            }}
            
            #settingsApplyBtn {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 {colors["apply_btn_start"]},
                    stop:1 {colors["apply_btn_end"]});
                border: 2px solid {colors["apply_btn_border"]};
                border-radius: 14px;
                color: white;
            }}
            
            #settingsApplyBtn:hover {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(34, 197, 94, 0.95),
                    stop:1 rgba(22, 163, 74, 1.0));
            }}
        """
        
        self.setStyleSheet(style)
        print(f"[SETTINGS_VIEW] ‚úì –°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã")




class MainWindow(QtWidgets.QMainWindow):
    def __init__(self):
        super().__init__()
        global CURRENT_LANGUAGE
        self.current_language = CURRENT_LANGUAGE
        self.deep_thinking = False
        self.use_search = False
        self.is_generating = False
        self.current_user_message = ""
        self.current_worker = None
        
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö workers –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è RuntimeError
        # WorkerSignals –Ω–µ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª—è—Ç—å—Å—è –ø–æ–∫–∞ worker —Ä–∞–±–æ—Ç–∞–µ—Ç
        self.active_workers = []  # –°–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ workers
        
        # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã AI
        self.ai_mode = AI_MODE_FAST  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º
        
        # –¢–∞–π–º–µ—Ä –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è
        self.thinking_start_time = None
        self.thinking_elapsed_time = 0
        
        # –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.is_editing = False
        self.editing_message_text = ""
        
        # –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª
        self.attached_file_path = None
        
        # –ú–µ–Ω–µ–¥–∂–µ—Ä —á–∞—Ç–æ–≤
        self.chat_manager = ChatManager()
        
        # –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        self.current_theme = "light"
        self.current_liquid_glass = True
        
        # –õ–û–ì–ò–ö–ê –°–¢–ê–†–¢–û–í–û–ì–û –ß–ê–¢–ê
        # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —á–∞—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        new_chat_id = self.chat_manager.create_chat("–ù–æ–≤—ã–π —á–∞—Ç")
        self.chat_manager.set_active_chat(new_chat_id)
        self.current_chat_id = new_chat_id
        
        # –ü–æ–º–µ—á–∞–µ–º —ç—Ç–æ—Ç —á–∞—Ç –∫–∞–∫ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π (–ø—É—Å—Ç–æ–π)
        self.startup_chat_id = new_chat_id
        self.startup_chat_has_messages = False

        self.setWindowTitle(APP_TITLE)
        self.resize(1100, 850)

        icon_pixmap = create_app_icon()
        self.setWindowIcon(QtGui.QIcon(icon_pixmap))

        # ‚îÄ‚îÄ Animated background widget (lives behind everything) ‚îÄ‚îÄ
        self.bg_widget = QtWidgets.QWidget()
        self.bg_widget.setObjectName("bgWidget")

        # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        main_container = QtWidgets.QWidget()
        self.setCentralWidget(main_container)
        container_layout = QtWidgets.QHBoxLayout(main_container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)

        # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤
        self.sidebar = QtWidgets.QWidget()
        self.sidebar.setObjectName("sidebar")
        self.sidebar.setFixedWidth(0)  # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞
        sidebar_layout = QtWidgets.QVBoxLayout(self.sidebar)
        sidebar_layout.setContentsMargins(0, 12, 0, 0)  # –í–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø –∫–∞–∫ —É title
        sidebar_layout.setSpacing(0)

        # –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π —á–∞—Ç"
        new_chat_btn = QtWidgets.QPushButton("+ –ù–æ–≤—ã–π —á–∞—Ç")
        new_chat_btn.setObjectName("newChatBtn")
        new_chat_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        new_chat_btn.clicked.connect(self.create_new_chat)
        sidebar_layout.addWidget(new_chat_btn)

        # –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        self.chats_list = QtWidgets.QListWidget()
        self.chats_list.setObjectName("chatsList")
        self.chats_list.itemClicked.connect(self.switch_chat)
        self.chats_list.setContextMenuPolicy(QtCore.Qt.ContextMenuPolicy.CustomContextMenu)
        self.chats_list.customContextMenuRequested.connect(self.show_delete_panel)
        sidebar_layout.addWidget(self.chats_list)

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–û–í–û–ï: –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ —Å–Ω–∏–∑—É sidebar)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.settings_btn = QtWidgets.QPushButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        self.settings_btn.setObjectName("settingsBtn")
        self.settings_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.settings_btn.clicked.connect(self.open_settings)
        sidebar_layout.addWidget(self.settings_btn)


        container_layout.addWidget(self.sidebar)

        # –ü–∞–Ω–µ–ª—å —É–¥–∞–ª–µ–Ω–∏—è (—Å–ø—Ä–∞–≤–∞ –æ—Ç sidebar)
        self.delete_panel = QtWidgets.QWidget()
        self.delete_panel.setObjectName("deletePanel")
        self.delete_panel.setFixedWidth(0)  # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞
        delete_layout = QtWidgets.QVBoxLayout(self.delete_panel)
        delete_layout.setContentsMargins(0, 12, 0, 0)
        delete_layout.setSpacing(10)
        
        delete_layout.addStretch()
        
        # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        self.delete_chat_btn = QtWidgets.QPushButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç")
        self.delete_chat_btn.setObjectName("deleteChatBtn")
        self.delete_chat_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.delete_chat_btn.clicked.connect(self.delete_selected_chat)
        delete_layout.addWidget(self.delete_chat_btn)
        
        delete_layout.addStretch()
        
        container_layout.addWidget(self.delete_panel)
        
        # ID —á–∞—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        self.chat_to_delete = None

        # –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
        central = QtWidgets.QWidget()
        central.setObjectName("central")
        main_layout = QtWidgets.QVBoxLayout(central)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)

        # Title block
        title_widget = QtWidgets.QWidget()
        title_widget.setObjectName("titleWidget")
        title_layout = QtWidgets.QHBoxLayout(title_widget)
        title_layout.setContentsMargins(15, 12, 15, 12)
        title_layout.setSpacing(15)

        # –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (–∏–∫–æ–Ω–∫–∞ —Ç—Ä—ë—Ö –ø–æ–ª–æ—Å–æ–∫)
        self.menu_btn = QtWidgets.QPushButton()
        self.menu_btn.setObjectName("menuBtn")
        self.menu_btn.setFixedSize(50, 50)
        self.menu_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.menu_btn.clicked.connect(self.toggle_sidebar)
        # –ò–∫–æ–Ω–∫–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        title_layout.addWidget(self.menu_btn, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)

        title_layout.addStretch()
        title_label = QtWidgets.QLabel(APP_TITLE)
        title_label.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        title_label.mousePressEvent = lambda event: self.show_model_info()
        title_label.setObjectName("titleLabel")
        font_title = QtGui.QFont("Inter", 22, QtGui.QFont.Weight.Bold)
        title_label.setFont(font_title)
        title_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
        title_layout.addWidget(title_label, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)
        title_layout.addStretch()

        # –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
        class ClearButtonWithTooltip(QtWidgets.QPushButton):
            def __init__(self, text, parent=None):
                super().__init__(text, parent)
                self.glass_tooltip = None
            
            def enterEvent(self, event):
                # –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                if not self.isEnabled():
                    if not self.glass_tooltip:
                        self.glass_tooltip = GlassTooltip("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏")
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
                    button_center = self.rect().center()
                    global_pos = self.mapToGlobal(QtCore.QPoint(button_center.x(), self.height()))
                    self.glass_tooltip.show_at(global_pos)
                super().enterEvent(event)
            
            def leaveEvent(self, event):
                # –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞
                if self.glass_tooltip:
                    self.glass_tooltip.hide()
                super().leaveEvent(event)
        
        self.clear_btn = ClearButtonWithTooltip("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å")
        self.clear_btn.setObjectName("clearBtn")
        font_clear = QtGui.QFont("Inter", 13, QtGui.QFont.Weight.Bold)
        self.clear_btn.setFont(font_clear)
        self.clear_btn.setFixedSize(120, 44)
        self.clear_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.clear_btn.clicked.connect(self.clear_chat)
        title_layout.addWidget(self.clear_btn, alignment=QtCore.Qt.AlignmentFlag.AlignVCenter)
        
        # –£–º–µ–Ω—å—à–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è —Å–¥–≤–∏–≥–∞ –∫–Ω–æ–ø–∫–∏ –≤–ø—Ä–∞–≤–æ (–±—ã–ª–æ 15)
        title_layout.addSpacing(8)

        main_layout.addWidget(title_widget)


        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # Chat display - QStackedWidget –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.content_stack = QtWidgets.QStackedWidget()
        self.content_stack.setObjectName("contentStack")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # PAGE 0: CHAT VIEW (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        chat_container = QtWidgets.QWidget()
        chat_container.setObjectName("chatContainer")
        chat_container.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Expanding,
            QtWidgets.QSizePolicy.Policy.Expanding
        )
        chat_layout = QtWidgets.QVBoxLayout(chat_container)
        chat_layout.setContentsMargins(0, 0, 0, 0)
        
        self.scroll_area = QtWidgets.QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setObjectName("scrollArea")
        self.scroll_area.setHorizontalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        self.scroll_area.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarPolicy.ScrollBarAsNeeded)
        
        self.scroll_area.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Expanding,
            QtWidgets.QSizePolicy.Policy.Expanding
        )

        self.scroll_area.setStyleSheet("background: transparent;")
        self.scroll_area.viewport().setStyleSheet("background: transparent;")

        self.messages_widget = QtWidgets.QWidget()
        
        self.messages_layout = QtWidgets.QVBoxLayout()
        self.messages_layout.setContentsMargins(5, 5, 5, 20)
        self.messages_layout.setSpacing(8)
        self.messages_layout.setAlignment(QtCore.Qt.AlignmentFlag.AlignTop)
        
        self.messages_widget.setLayout(self.messages_layout)
        
        self.messages_widget.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Expanding,
            QtWidgets.QSizePolicy.Policy.Minimum
        )

        self.messages_widget.setStyleSheet("background: transparent;")

        self.scroll_area.setWidget(self.messages_widget)
        
        print("[INIT] ‚úì messages_layout –≤—ã—Ä–æ–≤–Ω–µ–Ω –≤–≤–µ—Ä—Ö –±–µ–∑ stretch")
        print("[INIT] ‚úì –ë–ï–ó –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π —Å–∞–º")
        
        print("[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] messages_widget.parent():", self.messages_widget.parent())
        print("[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] scroll_area.viewport():", self.scroll_area.viewport())
        print("[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] –°–æ–≤–ø–∞–¥–∞—é—Ç?", self.messages_widget.parent() == self.scroll_area.viewport())
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–û–í–û–ï: FLOATING –ö–ù–û–ü–ö–ê "–í–ù–ò–ó" (overlay)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.scroll_to_bottom_btn = ScrollToBottomButton(self.scroll_area)
        self.scroll_to_bottom_btn.clicked.connect(self.manual_scroll_to_bottom)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ (valueChanged - –ø—Ä–∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ)
        self.scroll_area.verticalScrollBar().valueChanged.connect(self.update_scroll_button_visibility)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (rangeChanged - –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π)
        self.scroll_area.verticalScrollBar().rangeChanged.connect(self.update_scroll_button_visibility)
        
        chat_layout.addWidget(self.scroll_area)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # PAGE 1: SETTINGS VIEW
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.settings_view = SettingsView()
        self.settings_view.close_requested.connect(self.close_settings)
        self.settings_view.settings_applied.connect(self.on_settings_applied)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ stack
        self.content_stack.addWidget(chat_container)  # index 0
        self.content_stack.addWidget(self.settings_view)  # index 1
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.content_stack.setCurrentIndex(0)
        
        main_layout.addWidget(self.content_stack, stretch=1)

        # Input elements - –¥–æ–±–∞–≤–ª—è–µ–º –≤ main_layout –ü–û–°–õ–ï scroll area
        input_container = QtWidgets.QWidget()
        input_container.setObjectName("inputContainer")
        input_container.setStyleSheet("#inputContainer { background: transparent; border: none; }")
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: Fixed size policy –¥–ª—è footer
        input_container.setSizePolicy(
            QtWidgets.QSizePolicy.Policy.Preferred,  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å Expanding –Ω–∞ Preferred
            QtWidgets.QSizePolicy.Policy.Fixed
        )
        input_container.setFixedHeight(85)  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ footer
        
        input_layout = QtWidgets.QHBoxLayout(input_container)
        input_layout.setContentsMargins(25, 15, 25, 10)
        input_layout.setSpacing(15)

        # –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        self.attach_btn = QtWidgets.QPushButton("+")
        self.attach_btn.setObjectName("attachBtn")
        font_attach = QtGui.QFont("Inter", 26, QtGui.QFont.Weight.Bold)
        self.attach_btn.setFont(font_attach)
        self.attach_btn.setFixedSize(60, 60)
        self.attach_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.attach_btn.clicked.connect(self.show_attach_menu)
        input_layout.addWidget(self.attach_btn)

        self.input_field = QtWidgets.QLineEdit()
        self.input_field.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")
        self.input_field.setObjectName("inputField")
        font_input = QtGui.QFont("Inter", 14)
        self.input_field.setFont(font_input)
        self.input_field.setMinimumHeight(60)
        self.input_field.returnPressed.connect(self.send_message)
        input_layout.addWidget(self.input_field, stretch=1)
        
        # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ AI (–Ω–æ–≤–∞—è)
        self.mode_btn = QtWidgets.QPushButton(self.ai_mode)
        self.mode_btn.setObjectName("modeBtn")
        font_mode = QtGui.QFont("Inter", 12, QtGui.QFont.Weight.Medium)
        self.mode_btn.setFont(font_mode)
        self.mode_btn.setFixedSize(95, 60)
        self.mode_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.mode_btn.clicked.connect(self.show_mode_menu)
        input_layout.addWidget(self.mode_btn)

        self.send_btn = QtWidgets.QPushButton("‚Üí")
        self.send_btn.setObjectName("sendBtn")
        font_btn = QtGui.QFont("Inter", 22, QtGui.QFont.Weight.Bold)
        self.send_btn.setFont(font_btn)
        self.send_btn.setFixedSize(60, 60)
        self.send_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.send_btn.clicked.connect(self.send_message)
        input_layout.addWidget(self.send_btn)

        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª—è–µ–º input_container –≤ main_layout —Å stretch=0
        main_layout.addWidget(input_container, 0)
        
        # Store reference
        self.input_container = input_container

        # –°—Ç–∞—Ç—É—Å - fixed at bottom
        self.status_label = QtWidgets.QLabel("")
        self.status_label.setObjectName("statusLabel")
        font_status = QtGui.QFont("Inter", 11)
        self.status_label.setFont(font_status)
        self.status_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeft)
        self.status_label.setContentsMargins(30, 0, 30, 10)
        main_layout.addWidget(self.status_label)


        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container_layout.addWidget(central)

        self.threadpool = QtCore.QThreadPool()

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è sidebar –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏
        self.messages_widget.installEventFilter(self)
        self.scroll_area.viewport().installEventFilter(self)
        chat_container.installEventFilter(self)

        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        saved_settings = self.load_saved_settings()
        theme = saved_settings.get("theme", "light")
        liquid_glass = saved_settings.get("liquid_glass", True)
        
        print(f"[INIT] –ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Ç–µ–º–∞={theme}, —Å—Ç–µ–∫–ª–æ={liquid_glass}")
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        self.apply_styles(theme=theme, liquid_glass=liquid_glass)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –∫ –∫–Ω–æ–ø–∫–µ "–≤–Ω–∏–∑"
        if hasattr(self, 'scroll_to_bottom_btn'):
            self.scroll_to_bottom_btn.apply_theme_styles(theme=theme, liquid_glass=liquid_glass)
        
        self.load_chats_list()
        self.load_current_chat()
        
        # –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ layout
        self._first_show_done = False
    
    def load_saved_settings(self) -> dict:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            if os.path.exists("app_settings.json"):
                with open("app_settings.json", "r", encoding="utf-8") as f:
                    return json.load(f)
        except Exception as e:
            print(f"[SETTINGS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {"theme": "light", "liquid_glass": True}
    
    def showEvent(self, event):
        """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞.
        
        –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é layout.
        –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥, –∫–æ–≥–¥–∞ layout –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞.
        """
        super().showEvent(event)
        
        if not self._first_show_done:
            self._first_show_done = True
            # –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª event loop
            # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
            QtCore.QTimer.singleShot(0, self._finalize_initial_layout)
    
    def _finalize_initial_layout(self):
        """
        –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è layout –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞.
        
        –ê–õ–ì–û–†–ò–¢–ú:
        1. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è layout —á–µ—Ä–µ–∑ event loop (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ —á–µ—Ä–µ–∑ singleShot(0))
        2. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
        3. –ù–ï –≤—ã–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
        4. –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å processEvents, updateGeometry, adjustSize
        """
        try:
            # –ú—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            if hasattr(self, 'messages_widget'):
                self.messages_widget.update()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º scroll area
            if hasattr(self, 'scroll_area'):
                self.scroll_area.update()
            
            print("[LAYOUT_FINALIZE] ‚úì Layout —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞")
        except Exception as e:
            print(f"[LAYOUT_FINALIZE] ‚úó –û—à–∏–±–∫–∞: {e}")
    
    # position_input_elements() –∏ resizeEvent() —É–¥–∞–ª–µ–Ω—ã - footer —Ç–µ–ø–µ—Ä—å –≤ layout
    
    def apply_styles(self, theme: str = "light", liquid_glass: bool = True):
        """
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–µ–º –∏ liquid glass.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - theme: "light" –∏–ª–∏ "dark"
        - liquid_glass: True/False - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        """
        
        print(f"[APPLY_STYLES] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π: theme={theme}, liquid_glass={liquid_glass}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
        if hasattr(self, 'menu_btn'):
            menu_icon = create_menu_icon(theme=theme)
            self.menu_btn.setIcon(QtGui.QIcon(menu_icon))
            self.menu_btn.setIconSize(QtCore.QSize(50, 50))
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –¶–í–ï–¢–û–í–´–ï –ü–ê–õ–ò–¢–†–´ - 4 –í–ê–†–ò–ê–ù–¢–ê
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        if theme == "dark":
            if liquid_glass:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û - —Ç—ë–º–Ω–æ–µ —Å—Ç–µ–∫–ª–æ, –ù–ï —Å–≤–µ—Ç–ª–æ–µ
                colors = {
                    "main_bg": "#1e1e21",  # –¢—ë–º–Ω—ã–π —Ñ–æ–Ω
                    "central_bg": "rgba(30, 30, 35, 0.70)",  # –¢—ë–º–Ω–æ–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Å—Ç–µ–∫–ª–æ
                    "sidebar_bg": "rgba(24, 24, 28, 0.65)",  # –¢—ë–º–Ω–æ–µ —Å—Ç–µ–∫–ª–æ –¥–ª—è sidebar
                    
                    "central_border": "rgba(50, 50, 55, 0.4)",  # –ú—è–≥–∫–∏–µ —Ç—ë–º–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
                    "sidebar_border": "rgba(50, 50, 55, 0.35)",
                    
                    "text_primary": "#e6e6e6",  # –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                    "text_secondary": "#b0b0b0",
                    "text_tertiary": "#808080",
                    
                    "btn_bg": "rgba(45, 45, 50, 0.55)",  # –¢—ë–º–Ω—ã–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                    "btn_bg_hover": "rgba(55, 55, 60, 0.65)",
                    "btn_border": "rgba(60, 60, 65, 0.4)",
                    
                    "input_bg_start": "rgba(35, 35, 40, 0.75)",  # –¢—ë–º–Ω—ã–µ –∏–Ω–ø—É—Ç—ã
                    "input_bg_end": "rgba(28, 28, 32, 0.75)",
                    "input_border": "rgba(55, 55, 60, 0.5)",
                    "input_focus_border": "rgba(139, 92, 246, 0.4)",
                    
                    "accent_primary": "rgba(139, 92, 246, 0.3)",  # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç
                    "accent_hover": "rgba(139, 92, 246, 0.45)",
                    
                    "title_bg": "rgba(30, 30, 35, 0.65)",
                    "title_border": "rgba(50, 50, 55, 0.4)",
                }
            else:
                # –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –º–∞—Ç–æ–≤—ã–π —Ç—ë–º–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                colors = {
                    "main_bg": "#1e1e21",
                    "central_bg": "rgb(32, 32, 36)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ô —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π
                    "sidebar_bg": "rgb(28, 28, 31)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ô
                    
                    "central_border": "rgba(55, 55, 60, 0.9)",  # –ß—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
                    "sidebar_border": "rgba(55, 55, 60, 0.85)",
                    
                    "text_primary": "#f0f0f0",  # –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                    "text_secondary": "#c0c0c0",
                    "text_tertiary": "#909090",
                    
                    "btn_bg": "rgb(48, 48, 52)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ï –∫–Ω–æ–ø–∫–∏
                    "btn_bg_hover": "rgb(58, 58, 62)",
                    "btn_border": "rgba(68, 68, 72, 0.95)",
                    
                    "input_bg_start": "rgb(38, 38, 42)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ï –∏–Ω–ø—É—Ç—ã
                    "input_bg_end": "rgb(32, 32, 36)",
                    "input_border": "rgba(58, 58, 62, 0.95)",
                    "input_focus_border": "rgba(139, 92, 246, 0.7)",
                    
                    "accent_primary": "rgba(139, 92, 246, 0.45)",
                    "accent_hover": "rgba(139, 92, 246, 0.65)",
                    
                    "title_bg": "rgb(32, 32, 36)",
                    "title_border": "rgba(55, 55, 60, 0.9)",
                }
        else:
            # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê
            if liquid_glass:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê + –°–¢–ï–ö–õ–û - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π Liquid Glass
                colors = {
                    "main_bg": "#a1a1aa",
                    "central_bg": "rgba(255, 255, 255, 0.55)",
                    "sidebar_bg": "rgba(255, 255, 255, 0.42)",
                    
                    "central_border": "rgba(255, 255, 255, 0.72)",
                    "sidebar_border": "rgba(255, 255, 255, 0.55)",
                    
                    "text_primary": "#222222",  # –¢—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                    "text_secondary": "#3a3a3a",
                    "text_tertiary": "#5a5a5a",
                    
                    "btn_bg": "rgba(255, 255, 255, 0.60)",
                    "btn_bg_hover": "rgba(255, 255, 255, 0.78)",
                    "btn_border": "rgba(255, 255, 255, 0.70)",
                    
                    "input_bg_start": "rgba(248, 248, 250, 0.98)",
                    "input_bg_end": "rgba(242, 242, 245, 0.98)",
                    "input_border": "rgba(220, 220, 225, 0.80)",
                    "input_focus_border": "rgba(102, 126, 234, 0.35)",
                    
                    "accent_primary": "rgba(102, 126, 234, 0.18)",
                    "accent_hover": "rgba(102, 126, 234, 0.45)",
                    
                    "title_bg": "rgba(255, 255, 255, 0.52)",
                    "title_border": "rgba(255, 255, 255, 0.72)",
                }
            else:
                # –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê –ë–ï–ó –°–¢–ï–ö–õ–ê - –ø–ª–æ—Å–∫–∏–π iOS-like
                colors = {
                    "main_bg": "#d4d4d8",  # –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω
                    "central_bg": "rgb(252, 252, 254)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ô –±–µ–ª—ã–π
                    "sidebar_bg": "rgb(246, 246, 248)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ô —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
                    
                    "central_border": "rgba(210, 210, 215, 0.95)",
                    "sidebar_border": "rgba(210, 210, 215, 0.9)",
                    
                    "text_primary": "#1a1a1a",  # –û—á–µ–Ω—å —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç
                    "text_secondary": "#2a2a2a",
                    "text_tertiary": "#4a4a4a",
                    
                    "btn_bg": "rgb(242, 242, 245)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ï –∫–Ω–æ–ø–∫–∏
                    "btn_bg_hover": "rgb(235, 235, 240)",
                    "btn_border": "rgba(210, 210, 215, 0.95)",
                    
                    "input_bg_start": "rgb(248, 248, 250)",  # –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ï –∏–Ω–ø—É—Ç—ã
                    "input_bg_end": "rgb(242, 242, 245)",
                    "input_border": "rgba(210, 210, 215, 0.95)",
                    "input_focus_border": "rgba(102, 126, 234, 0.7)",
                    
                    "accent_primary": "rgba(102, 126, 234, 0.25)",
                    "accent_hover": "rgba(102, 126, 234, 0.5)",
                    
                    "title_bg": "rgb(246, 246, 248)",
                    "title_border": "rgba(210, 210, 215, 0.95)",
                }
        
        style = f"""
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           BASE ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        QMainWindow {{
            background: {colors["main_bg"]};
        }}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           CENTRAL PANEL ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #central {{
            background: {colors["central_bg"]};
            border-radius: 0px;
        }}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           SIDEBAR ‚Äî –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #sidebar {{
            background: {colors["sidebar_bg"]};
            border-right: 1px solid {colors["sidebar_border"]};
            border-radius: 0px;
        }}

        /* ‚îÄ‚îÄ New-chat button ‚îÄ‚îÄ */
        #newChatBtn {{
            background: {colors["btn_bg"]};
            color: {colors["text_secondary"]};
            border: 1px solid {colors["btn_border"]};
            border-radius: 14px;
            padding: 18px 20px;
            margin: 12px 10px;
            font-size: 16px;
            font-weight: 700;
            text-align: left;
        }}
        #newChatBtn:hover {{
            background: {colors["btn_bg_hover"]};
            border: 1px solid {colors["accent_hover"]};
        }}

        /* ‚îÄ‚îÄ Chat list ‚îÄ‚îÄ */
        #chatsList {{
            background: transparent;
            border: none;
            outline: none;
            padding: 0px 10px;
        }}
        #chatsList::item {{
            padding: 16px 14px;
            margin: 3px 0px;
            border-radius: 12px;
            border: none;
            color: {colors["text_secondary"]};
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
        }}
        #chatsList::item:hover {{
            background: {colors["btn_bg"]};
        }}
        #chatsList::item:selected {{
            background: {colors["accent_primary"]};
            color: {colors["text_primary"]};
            font-weight: 600;
            border-left: 3px solid {colors["accent_hover"]};
        }}

        /* ‚îÄ‚îÄ Settings button ‚îÄ‚îÄ */
        #settingsBtn {{
            background: {colors["btn_bg"]};
            color: {colors["text_secondary"]};
            border: 1px solid {colors["btn_border"]};
            border-radius: 14px;
            padding: 18px 20px;
            margin: 12px 10px;
            font-size: 16px;
            font-weight: 700;
            text-align: left;
        }}
        #settingsBtn:hover {{
            background: {colors["btn_bg_hover"]};
            border: 1px solid {colors["accent_hover"]};
        }}


        /* ‚îÄ‚îÄ Delete panel ‚îÄ‚îÄ */
        #deletePanel {{
            background: {colors["sidebar_bg"]};
            border-left: 1px solid {colors["sidebar_border"]};
            padding: 15px;
        }}
        #deleteChatBtn {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 rgba(239, 68, 68, 0.75),
                stop:1 rgba(220, 38, 38, 0.85));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 700;
        }}
        #deleteChatBtn:hover {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 rgba(239, 68, 68, 0.90),
                stop:1 rgba(185, 28, 28, 0.95));
        }}
        #deleteChatBtn:pressed {{
            background: rgba(185, 28, 28, 0.95);
        }}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TITLE BAR
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #menuBtn {{
            background: transparent;
            color: {colors["text_secondary"]};
            border: none;
            border-radius: 10px;
            padding: 0;
            margin: 0;
        }}
        #menuBtn:hover {{
            background: {colors["btn_bg"]};
        }}
        #menuBtn:pressed {{
            background: {colors["btn_bg_hover"]};
        }}

        #titleWidget {{
            background: {colors["title_bg"]};
            border: 1px solid {colors["title_border"]};
            border-radius: 18px;
            margin: 10px 15px;
            padding-top: 12px;
            padding-bottom: 12px;
        }}
        #titleLabel {{
            color: {colors["text_secondary"]};
            font-size: 22px;
            font-weight: 700;
            padding: 5px;
        }}

        #clearBtn {{
            background: rgba(252, 165, 165, 0.50);
            color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.60);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            padding: 6px 10px;
            max-width: 105px;
            min-width: 95px;
        }}
        #clearBtn:hover {{
            background: rgba(252, 165, 165, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.70);
            color: rgba(255, 255, 255, 1.0);
        }}
        #clearBtn:pressed {{
            background: rgba(239, 68, 68, 0.60);
            color: rgba(255, 255, 255, 1.0);
        }}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           CHAT SCROLL AREA
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #chatContainer {{ background: transparent; }}

        QScrollArea            {{ background: transparent; border: none; }}
        QScrollArea > QWidget  {{ background: transparent; }}
        QScrollArea > QWidget > QWidget {{ background: transparent; }}

        QScrollBar:vertical {{
            background: transparent;
            width: 0px;
        }}
        QScrollBar::handle:vertical {{
            background: transparent;
            border-radius: 5px;
            min-height: 30px;
        }}
        QScrollBar::handle:vertical:hover {{
            background: transparent;
        }}
        QScrollBar::add-line:vertical,
        QScrollBar::sub-line:vertical {{ height: 0px; }}

        /* ‚îÄ‚îÄ Input field ‚îÄ‚îÄ */
        #inputField {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 {colors["input_bg_start"]},
                stop:1 {colors["input_bg_end"]});
            color: {colors["text_primary"]};
            border: 1px solid {colors["input_border"]};
            border-radius: 30px;
            padding: 18px 25px;
            font-size: 16px;
        }}
        #inputField:focus {{
            border: 1px solid {colors["input_focus_border"]};
        }}
        #inputField::placeholder {{
            color: {colors["text_tertiary"]};
        }}

        /* ‚îÄ‚îÄ Attach button ‚îÄ‚îÄ */
        #attachBtn {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 {colors["input_bg_start"]},
                stop:1 {colors["input_bg_end"]});
            color: {colors["text_tertiary"]};
            border: 1px solid {colors["input_border"]};
            border-radius: 30px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            padding: 0px;
            line-height: 60px;
        }}
        #attachBtn:hover {{
            border: 1px solid {colors["input_focus_border"]};
        }}
        #attachBtn:pressed {{
            border: 1px solid {colors["accent_hover"]};
        }}

        /* ‚îÄ‚îÄ Send button ‚îÄ‚îÄ */
        #sendBtn {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 {colors["input_bg_start"]},
                stop:1 {colors["input_bg_end"]});
            color: {colors["text_tertiary"]};
            border: 1px solid {colors["input_border"]};
            border-radius: 30px;
            font-size: 26px;
        }}
        #sendBtn:hover {{
            border: 1px solid {colors["input_focus_border"]};
        }}
        #sendBtn:pressed {{
            border: 1px solid {colors["accent_hover"]};
        }}
        #sendBtn:disabled {{
            color: {colors["text_tertiary"]};
            border: 1px solid {colors["input_border"]};
        }}
        
        /* ‚îÄ‚îÄ Mode button ‚îÄ‚îÄ */
        #modeBtn {{
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 {colors["input_bg_start"]},
                stop:1 {colors["input_bg_end"]});
            color: {colors["text_tertiary"]};
            border: 1px solid {colors["input_border"]};
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            padding: 0px 10px;
        }}
        #modeBtn:hover {{
            border: 1px solid {colors["input_focus_border"]};
        }}
        #modeBtn:pressed {{
            border: 1px solid {colors["accent_hover"]};
        }}

        /* ‚îÄ‚îÄ Status label ‚îÄ‚îÄ */
        #statusLabel {{
            color: {colors["text_tertiary"]};
            padding-left: 5px;
            font-style: italic;
        }}

        """
        self.setStyleSheet(style)

        try:
            self.scroll_area.viewport().setStyleSheet("background: transparent;")
            self.messages_widget.setStyleSheet("background: transparent;")
        except Exception:
            pass
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ò–õ–ï–ô –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –í–ò–î–ñ–ï–¢–û–í –°–û–û–ë–©–ï–ù–ò–ô
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ç–µ–º—É –∏–ª–∏ liquid_glass,
        # –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª–∏ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö MessageWidget
        try:
            updated_count = 0
            for i in range(self.messages_layout.count()):
                item = self.messages_layout.itemAt(i)
                if item and item.widget():
                    widget = item.widget()
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ MessageWidget (—É –Ω–µ–≥–æ –µ—Å—Ç—å –º–µ—Ç–æ–¥ update_message_styles)
                    if hasattr(widget, 'update_message_styles'):
                        widget.update_message_styles(theme, liquid_glass)
                        updated_count += 1
            
            if updated_count > 0:
                print(f"[APPLY_STYLES] ‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –≤–∏–¥–∂–µ—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π")
        except Exception as e:
            print(f"[APPLY_STYLES] ‚úó –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤: {e}")
        
        print(f"[APPLY_STYLES] ‚úì –°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ: theme={theme}, liquid_glass={liquid_glass}")

    
    def show_model_info(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫"""
        QtWidgets.QMessageBox.information(
            self,
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏",
            "LLaMA 3 ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å\n\n–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ñ–ª–∞–π–Ω –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.",
            QtWidgets.QMessageBox.StandardButton.Ok
        )
    
    def show_mode_menu(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã AI"""
        menu = QtWidgets.QMenu(self)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        is_dark = self.current_theme == "dark"
        
        # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –º–µ–Ω—é
        menu.setWindowFlags(QtCore.Qt.WindowType.Popup | QtCore.Qt.WindowType.FramelessWindowHint)
        if not IS_WINDOWS:
            menu.setAttribute(QtCore.Qt.WidgetAttribute.WA_TranslucentBackground)
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
        if is_dark:
            # –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
            menu.setStyleSheet("""
                QMenu {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(30, 30, 35, 0.92),
                        stop:1 rgba(25, 25, 30, 0.95));
                    border: 1px solid rgba(60, 60, 70, 0.8);
                    border-radius: 16px;
                    padding: 10px;
                }
                QMenu::item {
                    padding: 14px 45px;
                    border-radius: 12px;
                    color: #e0e0e0;
                    font-size: 15px;
                    font-weight: 600;
                    margin: 4px;
                    background: rgba(40, 40, 45, 0.60);
                }
                QMenu::item:selected {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(60, 60, 70, 0.85),
                        stop:1 rgba(50, 50, 60, 0.88));
                    color: #ffffff;
                }
            """)
        else:
            # –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
            menu.setStyleSheet("""
                QMenu {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255, 255, 255, 0.92),
                        stop:1 rgba(250, 250, 252, 0.95));
                    border: 1px solid rgba(255, 255, 255, 0.95);
                    border-radius: 16px;
                    padding: 10px;
                }
                QMenu::item {
                    padding: 14px 45px;
                    border-radius: 12px;
                    color: #1a202c;
                    font-size: 15px;
                    font-weight: 600;
                    margin: 4px;
                    background: rgba(255, 255, 255, 0.50);
                }
                QMenu::item:selected {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255, 255, 255, 0.85),
                        stop:1 rgba(245, 245, 250, 0.88));
                    color: #0f172a;
                }
            """)
        
        # –°–æ–∑–¥–∞—ë–º –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∂–∏–º–∞
        fast_action = menu.addAction("‚ö° –ë—ã—Å—Ç—Ä—ã–π")
        fast_action.setCheckable(True)
        fast_action.setChecked(self.ai_mode == AI_MODE_FAST)
        
        thinking_action = menu.addAction("üß† –î—É–º–∞—é—â–∏–π")
        thinking_action.setCheckable(True)
        thinking_action.setChecked(self.ai_mode == AI_MODE_THINKING)
        
        pro_action = menu.addAction("üöÄ –ü—Ä–æ")
        pro_action.setCheckable(True)
        pro_action.setChecked(self.ai_mode == AI_MODE_PRO)
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–Ω–æ–ø–∫–∏
        button_rect = self.mode_btn.rect()
        button_global_pos = self.mode_btn.mapToGlobal(button_rect.bottomLeft())
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –º–µ–Ω—é
        menu.adjustSize()
        menu_size = menu.sizeHint()
        menu_height = menu_size.height()
        menu_width = menu_size.width()
        
        # –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –æ–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window_geometry = self.geometry()
        window_top = self.mapToGlobal(QtCore.QPoint(0, 0)).y()
        window_bottom = self.mapToGlobal(QtCore.QPoint(0, window_geometry.height())).y()
        
        # –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –í–í–ï–†–• –æ—Ç –∫–Ω–æ–ø–∫–∏
        menu_pos_up = QtCore.QPoint(
            button_global_pos.x() - (menu_width - self.mode_btn.width()) // 2,  # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –∫–Ω–æ–ø–∫–µ
            button_global_pos.y() - self.mode_btn.height() - menu_height - 8
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –º–µ–Ω—é –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –æ–∫–Ω–∞
        if menu_pos_up.y() < window_top + 80:  # 80px –æ—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–∞ (title bar)
            # –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≤–µ—Ä—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–ù–ò–ó –æ—Ç –∫–Ω–æ–ø–∫–∏
            menu_pos = QtCore.QPoint(
                button_global_pos.x() - (menu_width - self.mode_btn.width()) // 2,
                button_global_pos.y() + 8
            )
            print("[MODE_MENU] –ú–µ–Ω—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω–∏–∑ (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–µ—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É)")
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö
            menu_pos = menu_pos_up
            print("[MODE_MENU] –ú–µ–Ω—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–≤–µ—Ä—Ö")
        
        action = menu.exec(menu_pos)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
        if action == fast_action:
            self.ai_mode = AI_MODE_FAST
            self.mode_btn.setText(AI_MODE_FAST)
            print(f"[MODE] –í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: {AI_MODE_FAST}")
        elif action == thinking_action:
            self.ai_mode = AI_MODE_THINKING
            self.mode_btn.setText(AI_MODE_THINKING)
            print(f"[MODE] –í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: {AI_MODE_THINKING}")
        elif action == pro_action:
            self.ai_mode = AI_MODE_PRO
            self.mode_btn.setText(AI_MODE_PRO)
            print(f"[MODE] –í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: {AI_MODE_PRO}")
        
        # –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–∫–∏
        self.mode_btn.clearFocus()
        self.input_field.setFocus()
    
    def toggle_thinking(self, state=None):
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if self.is_generating:
            return
        
        # –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –Ω–∞–ø—Ä—è–º—É—é (–∏–∑ –º–µ–Ω—é), –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if state is None:
            return
        
        self.deep_thinking = (state == QtCore.Qt.CheckState.Checked.value)

    def toggle_search(self, state=None):
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if self.is_generating:
            return
        
        # –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –Ω–∞–ø—Ä—è–º—É—é (–∏–∑ –º–µ–Ω—é), –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if state is None:
            return
        
        self.use_search = (state == QtCore.Qt.CheckState.Checked.value)
    
    def show_attach_menu(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Å –æ–ø—Ü–∏—è–º–∏ Search –∏ Attach file —Å glass-—ç—Ñ—Ñ–µ–∫—Ç–æ–º"""
        menu = QtWidgets.QMenu(self)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        is_dark = self.current_theme == "dark"
        
        # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –º–µ–Ω—é –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        menu.setWindowFlags(QtCore.Qt.WindowType.Popup | QtCore.Qt.WindowType.FramelessWindowHint)
        # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ –Ω–∞ Windows
        if not IS_WINDOWS:
            menu.setAttribute(QtCore.Qt.WidgetAttribute.WA_TranslucentBackground)
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
        if is_dark:
            # –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
            menu.setStyleSheet("""
                QMenu {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(30, 30, 35, 0.92),
                        stop:1 rgba(25, 25, 30, 0.95));
                    border: 1px solid rgba(60, 60, 70, 0.8);
                    border-radius: 16px;
                    padding: 10px;
                }
                QMenu::item {
                    padding: 14px 45px;
                    border-radius: 12px;
                    color: #e0e0e0;
                    font-size: 15px;
                    font-weight: 600;
                    margin: 4px;
                    background: rgba(40, 40, 45, 0.60);
                }
                QMenu::item:selected {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(60, 60, 70, 0.85),
                        stop:1 rgba(50, 50, 60, 0.88));
                    color: #ffffff;
                }
                QMenu::separator {
                    height: 1px;
                    background: rgba(80, 80, 90, 0.50);
                    margin: 8px 20px;
                }
            """)
        else:
            # –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
            menu.setStyleSheet("""
                QMenu {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255, 255, 255, 0.92),
                        stop:1 rgba(250, 250, 252, 0.95));
                    border: 1px solid rgba(255, 255, 255, 0.95);
                    border-radius: 16px;
                    padding: 10px;
                }
                QMenu::item {
                    padding: 14px 45px;
                    border-radius: 12px;
                    color: #1a202c;
                    font-size: 15px;
                    font-weight: 600;
                    margin: 4px;
                    background: rgba(255, 255, 255, 0.50);
                }
                QMenu::item:selected {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255, 255, 255, 0.85),
                        stop:1 rgba(245, 245, 250, 0.88));
                    color: #0f172a;
                }
                QMenu::separator {
                    height: 1px;
                    background: rgba(200, 200, 210, 0.60);
                    margin: 8px 20px;
                }
            """)
        
        # FORCED SEARCH - —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        search_label = "üî¥ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫" if self.use_search else "üîç –£–º–Ω—ã–π –ø–æ–∏—Å–∫"
        search_action = menu.addAction(search_label)
        search_action.setCheckable(True)
        search_action.setChecked(self.use_search)
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        menu.addSeparator()
        
        # Attach file –æ–ø—Ü–∏—è
        file_action = menu.addAction("üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ù–ê–î –∫–Ω–æ–ø–∫–æ–π —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
        button_rect = self.attach_btn.rect()
        button_global_pos = self.attach_btn.mapToGlobal(button_rect.topLeft())
        
        menu_height = 150
        menu_pos = QtCore.QPoint(button_global_pos.x(), button_global_pos.y() - menu_height - 8)
        
        action = menu.exec(menu_pos)
        
        # –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
        self.attach_btn.clearFocus()
        self.input_field.setFocus()
        
        if action == search_action:
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º Forced Search
            self.use_search = not self.use_search
            if self.use_search:
                print(f"[MENU] ‚ö†Ô∏è FORCED SEARCH MODE –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω - –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û")
            else:
                print(f"[MENU] –†–µ–∂–∏–º '–£–º–Ω—ã–π –ø–æ–∏—Å–∫' - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞")
        elif action == file_action:
            self.attach_file()
    
    def attach_file(self):
        """–í—ã–±—Ä–∞—Ç—å –∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–ª—é–±–æ–π —Ç–∏–ø, –≤–∫–ª—é—á–∞—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)"""
        file_path, _ = QtWidgets.QFileDialog.getOpenFileName(
            self,
            "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª",
            "",
            "–í—Å–µ —Ñ–∞–π–ª—ã (*.*);;–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.png *.jpg *.jpeg *.gif *.bmp *.webp);;–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (*.txt *.md *.py *.js *.json)"
        )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.activateWindow()
        self.raise_()
        
        if file_path:
            self.attached_file_path = file_path
            file_name = os.path.basename(file_path)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏
            file_ext = os.path.splitext(file_path)[1].lower()
            if file_ext in ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp']:
                emoji = "üñºÔ∏è"
                question = "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏..."
            else:
                emoji = "üìé"
                question = "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ñ–∞–π–ª–µ..."
            self.input_field.setPlaceholderText(f"{emoji} {file_name} | {question}")
            print(f"[ATTACH] –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: {file_path}")
            
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        self.input_field.setFocus()
    
    def clear_attached_file(self):
        """–û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª"""
        self.attached_file_path = None
        self.input_field.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")
    
    def start_status_animation(self):
        """–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–æ—á–µ–∫ –≤ —Å—Ç–∞—Ç—É—Å–µ"""
        self.status_dots_count = 0
        self.status_timer = QtCore.QTimer(self)
        self.status_timer.timeout.connect(self.update_status_dots)
        self.status_timer.start(350)  # –ò–Ω—Ç–µ—Ä–≤–∞–ª 350ms
    
    def update_status_dots(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤ —Å—Ç–∞—Ç—É—Å–µ"""
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è status_base_text
        if not hasattr(self, 'status_base_text'):
            self.status_base_text = ""
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        self.status_label.clear()
        
        dots = "." * self.status_dots_count
        self.status_label.setText(f"{self.status_base_text}{dots}")
        self.status_dots_count = (self.status_dots_count + 1) % 4  # 0, 1, 2, 3
    
    def stop_status_animation(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–æ—á–µ–∫"""
        if hasattr(self, 'status_timer') and self.status_timer.isActive():
            self.status_timer.stop()
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
        self.status_label.clear()
        self.status_label.setText("")

    def toggle_sidebar(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π"""
        # –í–ê–ñ–ù–û: –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
        # –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ "‚Üê –ß–∞—Ç—ã"
        # –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –≤ open_settings
        
        current_width = self.sidebar.width()
        target_width = 280 if current_width == 0 else 0
        
        # –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ sidebar
        if target_width == 0:
            self.hide_delete_panel()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
        scroll_pos = self.scroll_area.verticalScrollBar().value()
        
        self.animation = QtCore.QPropertyAnimation(self.sidebar, b"minimumWidth")
        self.animation.setDuration(400)
        self.animation.setStartValue(current_width)
        self.animation.setEndValue(target_width)
        self.animation.setEasingCurve(QtCore.QEasingCurve.Type.InOutCubic)
        
        self.animation2 = QtCore.QPropertyAnimation(self.sidebar, b"maximumWidth")
        self.animation2.setDuration(400)
        self.animation2.setStartValue(current_width)
        self.animation2.setEndValue(target_width)
        self.animation2.setEasingCurve(QtCore.QEasingCurve.Type.InOutCubic)
        
        # Layout –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        # –ù–µ –Ω—É–∂–Ω—ã processEvents, updateGeometry, activate - Qt —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç layout
        
        self.animation.start()
        self.animation2.start()
        self.animation2.start()
    


    def manual_scroll_to_bottom(self):
        """
        –†—É—á–Ω–æ–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É.
        –ù–ï –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π - —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        scrollbar = self.scroll_area.verticalScrollBar()
        scrollbar.setValue(scrollbar.maximum())
        self.scroll_to_bottom_btn.hide()
    
    def update_scroll_button_visibility(self):
        """
        –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–≤–Ω–∏–∑" –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞.
        
        –ü–†–ê–í–ò–õ–ê:
        - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤–Ω–∏–∑—É
        - –°–∫—Ä—ã–≤–∞—Ç—å –µ—Å–ª–∏ –≤–Ω–∏–∑—É –∏–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á–∞—Ç–∞, –∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if hasattr(self, 'content_stack') and self.content_stack.currentIndex() != 0:
            self.scroll_to_bottom_btn.hide()
            return
        
        scrollbar = self.scroll_area.verticalScrollBar()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–µ viewport
        if scrollbar.maximum() == 0:
            self.scroll_to_bottom_btn.hide()
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –ù–ï –≤–Ω–∏–∑—É (—Å –ø–æ—Ä–æ–≥–æ–º 10px)
        if scrollbar.value() < scrollbar.maximum() - 10:
            if not self.scroll_to_bottom_btn.isVisible():
                self.scroll_to_bottom_btn.show()
                self.scroll_to_bottom_btn.update_position(
                    self.scroll_area.width(),
                    self.scroll_area.height()
                )
        else:
            self.scroll_to_bottom_btn.hide()
    
    def open_settings(self):
        """–û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        print("[SETTINGS] –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º
        if hasattr(self, 'settings_view'):
            print("[SETTINGS] –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∏–ª–∏ settings_view")
            self.settings_view.apply_settings_styles()
        else:
            print("[SETTINGS] ‚ö†Ô∏è settings_view –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        
        self.content_stack.setCurrentIndex(1)
        print(f"[SETTINGS] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –∏–Ω–¥–µ–∫—Å: {self.content_stack.currentIndex()}")
        
        # –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã header –∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        if hasattr(self, 'title_label'):
            self.title_label.hide()
        if hasattr(self, 'clear_btn'):
            self.clear_btn.hide()
        
        # –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –Ω–æ–≤—ã–π
        if hasattr(self, 'menu_btn'):
            # –û—Ç–∫–ª—é—á–∞–µ–º toggle_sidebar
            try:
                self.menu_btn.clicked.disconnect()
            except:
                pass
            
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º close_settings
            self.menu_btn.clicked.connect(self.close_settings)
            
            # –ò–∫–æ–Ω–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å - –ù–ï –º–µ–Ω—è–µ–º –Ω–∞ —Ç–µ–∫—Å—Ç
        
        # –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if hasattr(self, 'scroll_to_bottom_btn'):
            self.scroll_to_bottom_btn.hide()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º sidebar –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
        if self.sidebar.width() > 0:
            self.toggle_sidebar()
    
    def close_settings(self):
        """–ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É"""
        print("[SETTINGS] –í–æ–∑–≤—Ä–∞—Ç –∫ —á–∞—Ç—É")
        self.content_stack.setCurrentIndex(0)
        
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã header
        if hasattr(self, 'title_label'):
            self.title_label.show()
        if hasattr(self, 'clear_btn'):
            self.clear_btn.show()
        
        # –ö–†–ò–¢–ò–ß–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        if hasattr(self, 'menu_btn'):
            # –û—Ç–∫–ª—é—á–∞–µ–º close_settings
            try:
                self.menu_btn.clicked.disconnect()
            except:
                pass
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º toggle_sidebar
            self.menu_btn.clicked.connect(self.toggle_sidebar)
            
            # –ò–∫–æ–Ω–∫–∞ —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ - –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
        QtCore.QTimer.singleShot(100, self.update_scroll_button_visibility)
    
    def on_settings_applied(self, settings: dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        print(f"[SETTINGS] –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {settings}")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        theme = settings.get("theme", "light")
        liquid_glass = settings.get("liquid_glass", True)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∫–ª–∞—Å—Å–∞
        self.current_theme = theme
        self.current_liquid_glass = liquid_glass
        
        print(f"[SETTINGS] –ü—Ä–∏–º–µ–Ω—è—é —Ç–µ–º—É: {theme}, Liquid Glass: {liquid_glass}")
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –≥–ª–∞–≤–Ω–æ–º—É –æ–∫–Ω—É
        self.apply_styles(theme=theme, liquid_glass=liquid_glass)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ "–≤–Ω–∏–∑"
        if hasattr(self, 'scroll_to_bottom_btn'):
            self.scroll_to_bottom_btn.apply_theme_styles(theme=theme, liquid_glass=liquid_glass)
            print("[SETTINGS] ‚úì –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ '–≤–Ω–∏–∑' –æ–±–Ω–æ–≤–ª–µ–Ω—ã")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if hasattr(self, 'settings_view'):
            self.settings_view.apply_settings_styles()
        
        print("[SETTINGS] ‚úì –°—Ç–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã")


    def eventFilter(self, obj, event):
        """–§–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è sidebar –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è floating –∫–Ω–æ–ø–∫–∏"""
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ resize scroll_area –¥–ª—è floating –∫–Ω–æ–ø–∫–∏
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if obj == self.scroll_area and event.type() == QtCore.QEvent.Type.Resize:
            if hasattr(self, 'scroll_to_bottom_btn'):
                self.scroll_to_bottom_btn.update_position(
                    self.scroll_area.width(),
                    self.scroll_area.height()
                )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ sidebar
        if self.sidebar.width() > 0:
            # –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ - –∫–ª–∏–∫ –º—ã—à—å—é
            if event.type() == QtCore.QEvent.Type.MouseButtonPress:
                # –ó–∞–∫—Ä—ã–≤–∞–µ–º sidebar
                self.toggle_sidebar()
        
        # –ü–µ—Ä–µ–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ –¥–∞–ª—å—à–µ
        return super().eventFilter(obj, event)

    def show_delete_panel(self, pos):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ –Ω–∞ —á–∞—Ç"""
        item = self.chats_list.itemAt(pos)
        if not item:
            return
        
        chat_id = item.data(QtCore.Qt.ItemDataRole.UserRole)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        is_dark = self.current_theme == "dark"
        
        # –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        context_menu = QtWidgets.QMenu(self)
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
        if is_dark:
            context_menu.setStyleSheet("""
                QMenu {
                    background-color: rgba(30, 30, 35, 0.85);
                    border: 1px solid rgba(60, 60, 70, 0.8);
                    border-radius: 12px;
                    padding: 6px;
                }
                QMenu::item {
                    padding: 10px 20px;
                    border-radius: 8px;
                    color: #e0e0e0;
                }
                QMenu::item:selected {
                    background-color: rgba(220, 38, 38, 0.25);
                    color: #ff6b6b;
                }
            """)
        else:
            context_menu.setStyleSheet("""
                QMenu {
                    background-color: rgba(255, 255, 255, 0.72);
                    border: 1px solid rgba(255, 255, 255, 0.85);
                    border-radius: 12px;
                    padding: 6px;
                }
                QMenu::item {
                    padding: 10px 20px;
                    border-radius: 8px;
                    color: #2d3748;
                }
                QMenu::item:selected {
                    background-color: rgba(239, 68, 68, 0.15);
                    color: #dc2626;
                }
            """)
        
        # –ü—É–Ω–∫—Ç "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç"
        delete_action = context_menu.addAction("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
        action = context_menu.exec(self.chats_list.mapToGlobal(pos))
        
        if action == delete_action:
            self.delete_chat_by_id(chat_id)

    def hide_delete_panel(self):
        """–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–¥–∞–ª–µ–Ω–∏—è"""
        if self.delete_panel.width() == 0:
            return
        
        anim1 = QtCore.QPropertyAnimation(self.delete_panel, b"minimumWidth")
        anim1.setDuration(200)
        anim1.setStartValue(self.delete_panel.width())
        anim1.setEndValue(0)
        anim1.setEasingCurve(QtCore.QEasingCurve.Type.InOutQuad)
        
        anim2 = QtCore.QPropertyAnimation(self.delete_panel, b"maximumWidth")
        anim2.setDuration(200)
        anim2.setStartValue(self.delete_panel.width())
        anim2.setEndValue(0)
        anim2.setEasingCurve(QtCore.QEasingCurve.Type.InOutQuad)
        
        anim1.start()
        anim2.start()

    def delete_chat_by_id(self, chat_id: int):
        """–£–¥–∞–ª–∏—Ç—å —á–∞—Ç –ø–æ ID"""
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        reply = QtWidgets.QMessageBox.question(
            self, "–£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞",
            "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?\n–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.",
            QtWidgets.QMessageBox.StandardButton.Yes | QtWidgets.QMessageBox.StandardButton.No
        )
        
        if reply == QtWidgets.QMessageBox.StandardButton.Yes:
            # –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            if chat_id == self.current_chat_id:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —á–∞—Ç
                new_chat_id = self.chat_manager.create_chat("–ù–æ–≤—ã–π —á–∞—Ç")
                self.chat_manager.set_active_chat(new_chat_id)
                self.current_chat_id = new_chat_id
            
            # –£–¥–∞–ª—è–µ–º —á–∞—Ç
            self.chat_manager.delete_chat(chat_id)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            self.load_chats_list()
            self.load_current_chat()

    def delete_selected_chat(self):
        """–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏)"""
        if not self.chat_to_delete:
            return
        
        self.delete_chat_by_id(self.chat_to_delete)
        
        # –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–¥–∞–ª–µ–Ω–∏—è
        self.hide_delete_panel()
        self.chat_to_delete = None

    def load_chats_list(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤"""
        self.chats_list.clear()
        chats = self.chat_manager.get_all_chats()
        
        for chat in chats:
            item = QtWidgets.QListWidgetItem(chat['title'])
            item.setData(QtCore.Qt.ItemDataRole.UserRole, chat['id'])
            self.chats_list.addItem(item)
            
            if chat['is_active']:
                self.chats_list.setCurrentItem(item)

    def load_current_chat(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç"""
        if not self.current_chat_id:
            return
        
        print(f"[LOAD_CURRENT] –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ ID={self.current_chat_id}")
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ layout: [message1, message2, ..., stretch(1)]
        # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Å—Ç–∞–≤–ª—è–µ–º stretch –≤ –∫–æ–Ω—Ü–µ
        items_to_remove = []
        for i in range(self.messages_layout.count()):
            item = self.messages_layout.itemAt(i)
            if item and item.widget():
                widget = item.widget()
                # –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–Ω–∏ –∏–º–µ—é—Ç –∞—Ç—Ä–∏–±—É—Ç speaker)
                if hasattr(widget, 'speaker'):
                    items_to_remove.append(widget)
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã
        for widget in items_to_remove:
            self.messages_layout.removeWidget(widget)
            widget.deleteLater()
        
        print(f"[LOAD_CURRENT] –£–¥–∞–ª–µ–Ω–æ –≤–∏–¥–∂–µ—Ç–æ–≤: {len(items_to_remove)}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        messages = self.chat_manager.get_chat_messages(self.current_chat_id, limit=50)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å"
        self.clear_btn.setEnabled(True)
        self.clear_btn.setStyleSheet("")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –µ—Å–ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
        if len(messages) == 0:
            welcome_msg = "–ü—Ä–∏–≤–µ—Ç! –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
            self.add_message_widget("–°–∏—Å—Ç–µ–º–∞", welcome_msg, add_controls=False)
            return
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
        total_messages = len(messages)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        for idx, (role, content, created) in enumerate(messages):
            speaker = "–í—ã" if role == "user" else ASSISTANT_NAME
            if role not in ["user", "assistant"]:
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3
            is_recent = (total_messages - idx) <= 3
            
            # –°–æ–∑–¥–∞—ë–º –≤–∏–¥–∂–µ—Ç –ë–ï–ó –∞–Ω–∏–º–∞—Ü–∏–∏ (–¥–ª—è –≤—Å–µ—Ö)
            message_widget = MessageWidget(
                speaker, content, add_controls=True,
                language=self.current_language,
                main_window=self,
                parent=self.messages_widget,
                thinking_time=0
            )
            
            # –î–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ä–∞–∑—É —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            if not is_recent:
                if hasattr(message_widget, 'opacity_effect'):
                    message_widget.opacity_effect.setOpacity(1.0)
                # –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
                if hasattr(message_widget, 'fade_in_animation'):
                    message_widget.fade_in_animation.stop()
                if hasattr(message_widget, 'pos_animation'):
                    message_widget.pos_animation.stop()
            else:
                # –î–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 - –∞–Ω–∏–º–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                pass
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ layout (stretch —É–∂–µ —É–¥–∞–ª—ë–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü)
            self.messages_layout.addWidget(message_widget)
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏–π
            if is_recent and not IS_WINDOWS and hasattr(message_widget, '_start_appear_animation'):
                # –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                QtCore.QTimer.singleShot(20 + idx * 40, message_widget._start_appear_animation)

    def create_new_chat(self):
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç"""
        
        # ‚ïê‚ïê‚ïê –õ–û–ì–ò–ö–ê –°–¢–ê–†–¢–û–í–û–ì–û –ß–ê–¢–ê ‚ïê‚ïê‚ïê
        # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç - –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π, —É–¥–∞–ª—è–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        if (hasattr(self, 'startup_chat_id') and 
            hasattr(self, 'startup_chat_has_messages') and
            self.current_chat_id == self.startup_chat_id and
            not self.startup_chat_has_messages):
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
            messages = self.chat_manager.get_chat_messages(self.startup_chat_id, limit=10)
            user_messages = [msg for msg in messages if msg[0] == "user"]
            
            if len(user_messages) == 0:
                print(f"[STARTUP_CHAT] –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç {self.startup_chat_id} –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ")
                try:
                    self.chat_manager.delete_chat(self.startup_chat_id)
                except Exception as e:
                    print(f"[STARTUP_CHAT] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞: {e}")
        
        chat_id = self.chat_manager.create_chat("–ù–æ–≤—ã–π —á–∞—Ç")
        self.chat_manager.set_active_chat(chat_id)
        self.current_chat_id = chat_id
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ
        self.startup_chat_id = None
        self.startup_chat_has_messages = False
        
        self.load_chats_list()
        self.load_current_chat()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º sidebar –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
        self.toggle_sidebar()

    def switch_chat(self, item):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —á–∞—Ç —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        chat_id = item.data(QtCore.Qt.ItemDataRole.UserRole)
        
        # ‚ïê‚ïê‚ïê –õ–û–ì–ò–ö–ê –°–¢–ê–†–¢–û–í–û–ì–û –ß–ê–¢–ê ‚ïê‚ïê‚ïê
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è —Å –ø—É—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞ - —É–¥–∞–ª—è–µ–º –µ–≥–æ
        if (hasattr(self, 'startup_chat_id') and 
            hasattr(self, 'startup_chat_has_messages') and
            self.current_chat_id == self.startup_chat_id and
            not self.startup_chat_has_messages and
            chat_id != self.startup_chat_id):
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
            messages = self.chat_manager.get_chat_messages(self.startup_chat_id, limit=10)
            # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            user_messages = [msg for msg in messages if msg[0] == "user"]
            
            if len(user_messages) == 0:
                print(f"[STARTUP_CHAT] –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç {self.startup_chat_id}")
                try:
                    self.chat_manager.delete_chat(self.startup_chat_id)
                    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞
                    self.startup_chat_id = None
                    self.startup_chat_has_messages = False
                except Exception as e:
                    print(f"[STARTUP_CHAT] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞: {e}")
        
        # ‚úÖ GUARD: –û—Ç–º–µ–Ω—è–µ–º –≤–æ—Ä–∫–µ—Ä –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
        if hasattr(self, 'current_worker') and self.current_worker is not None:
            try:
                print(f"[SWITCH_CHAT] –û—Ç–º–µ–Ω—è–µ–º –≤–æ—Ä–∫–µ—Ä –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞")
                self.current_worker = None  # –û–±–Ω—É–ª—è–µ–º —Å—Å—ã–ª–∫—É
                self.is_generating = False
            except Exception as e:
                print(f"[SWITCH_CHAT] –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –≤–æ—Ä–∫–µ—Ä–∞: {e}")
        
        # ‚úÖ GUARD: –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        try:
            self.input_field.clear()
        except Exception:
            pass
        
        self.chat_manager.set_active_chat(chat_id)
        self.current_chat_id = chat_id
        
        self.load_current_chat()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º sidebar –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        self.toggle_sidebar()

    def add_message_widget(self, speaker: str, text: str, add_controls: bool = False, thinking_time: float = 0, action_history: list = None):
        """
        –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ layout –ë–ï–ó –ê–í–¢–û–°–ö–†–û–õ–õ–ê.
        
        –ü–†–ê–í–ò–õ–ê:
        - –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –≤ –∫–æ–Ω–µ—Ü layout
        - –ù–ï –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å (–∫–Ω–æ–ø–∫–æ–π "–≤–Ω–∏–∑")
        """
        # –°–æ–∑–¥–∞—ë–º –≤–∏–¥–∂–µ—Ç
        message_widget = MessageWidget(
            speaker, text, add_controls,
            language=self.current_language,
            main_window=self,
            parent=self.messages_widget,
            thinking_time=thinking_time,
            action_history=action_history
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ö–û–ù–ï–¶ layout
        self.messages_layout.addWidget(message_widget)
        
        # –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –≤—Å–µ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        # –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–µ–º—ã –∏ liquid glass
        self.messages_layout.invalidate()
        self.messages_widget.updateGeometry()
        self.messages_layout.activate()
        self.scroll_area.viewport().updateGeometry()
        self.scroll_area.updateGeometry()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ Windows)
        if not IS_WINDOWS and hasattr(message_widget, '_start_appear_animation'):
            QtCore.QTimer.singleShot(20, message_widget._start_appear_animation)

    def send_message(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –±–µ—Ä—ë—Ç —Ç–µ–∫—Å—Ç –¢–û–õ–¨–ö–û –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ (self.input_field.text())
        –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥—Ä—É–≥–∏—Ö —á–∞—Ç–æ–≤
        """
        
        # –ï—Å–ª–∏ –∏–¥—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ë–ï–ó –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ–∫—Å—Ç–∞
        if self.is_generating:
            self.is_generating = False
            if hasattr(self, 'current_worker'):
                self.current_worker = None
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–∞
            if hasattr(self, 'stop_status_animation'):
                self.stop_status_animation()
            
            # –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
            self.input_field.setEnabled(True)
            self.send_btn.setEnabled(True)
            self.send_btn.setText("‚Üí")
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)
            self.status_label.setText("")
            
            print("[SEND] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
            return
        
        global CURRENT_LANGUAGE
        # –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´ - —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        user_text = self.input_field.text().strip()
        if not user_text:
            return
        
        print(f"[SEND] –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {user_text[:50]}...")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏ —É–±—Ä–∞–Ω–∞ - –Ω–µ–π—Ä–æ—Å–µ—Ç—å —Å–∞–º–∞ –ø–µ—Ä–µ—Å–ø—Ä–æ—Å–∏—Ç –µ—Å–ª–∏ –Ω–µ –ø–æ–π–º—ë—Ç

        should_forget = detect_forget_command(user_text)
        if should_forget:
            print("[SEND] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–±—ã—Ç—å!")
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
            self.input_field.clear()
            self.add_message_widget("–í—ã", user_text, add_controls=True)
            self.chat_manager.save_message(self.current_chat_id, "user", user_text)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–ª—å –∑–∞–±—ã–≤–∞–Ω–∏—è
            forget_info = extract_forget_target(user_text)
            
            if forget_info["forget_all"]:
                # –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê
                print("[SEND] –í—ã–ø–æ–ª–Ω—è—é –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –ø–∞–º—è—Ç–∏...")
                
                # –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
                self.chat_manager.clear_chat_messages(self.current_chat_id)
                
                # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å
                try:
                    from context_memory_manager import ContextMemoryManager
                    context_mgr = ContextMemoryManager()
                    context_mgr.clear_context_memory(self.current_chat_id)
                    print(f"[SEND] ‚úì –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞ –¥–ª—è chat_id={self.current_chat_id}")
                except Exception as e:
                    print(f"[SEND] ‚úó –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –ø–∞–º—è—Ç–∏: {e}")
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ "–ù–æ–≤—ã–π —á–∞—Ç"
                self.chat_manager.update_chat_title(self.current_chat_id, "–ù–æ–≤—ã–π —á–∞—Ç")
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                self.load_chats_list()
                
                # –û—Ç–≤–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ AI (–∞ –Ω–µ —Å–∏—Å—Ç–µ–º—ã!)
                if self.current_language == "russian":
                    ai_response = "–•–æ—Ä–æ—à–æ, —è –∑–∞–±—ã–ª –≤—Å—é –Ω–∞—à—É –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é. –ù–∞—á–Ω—ë–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞! üòä"
                else:
                    ai_response = "Okay, I've forgotten all our previous history. Let's start fresh! üòä"
                
            else:
                # –°–ï–õ–ï–ö–¢–ò–í–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï
                target = forget_info["target"]
                print(f"[SEND] –í—ã–ø–æ–ª–Ω—è—é —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: '{target}'")
                
                try:
                    from context_memory_manager import ContextMemoryManager
                    context_mgr = ContextMemoryManager()
                    
                    # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                    result = selective_forget_memory(
                        self.current_chat_id, 
                        target, 
                        context_mgr, 
                        self.chat_manager
                    )
                    
                    if result["success"]:
                        print(f"[SEND] ‚úì {result['message']}")
                        
                        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                        self.load_chats_list()
                        
                        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                        if result["deleted_count"] > 0:
                            if self.current_language == "russian":
                                ai_response = f"‚úì –ì–æ—Ç–æ–≤–æ! –Ø –∑–∞–±—ã–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ '{target}'. {result['message']}"
                            else:
                                ai_response = f"‚úì Done! I've forgotten information about '{target}'. {result['message']}"
                        else:
                            if self.current_language == "russian":
                                ai_response = f"–Ø –Ω–µ –Ω–∞—à—ë–ª —É–ø–æ–º–∏–Ω–∞–Ω–∏–π '{target}' –≤ –Ω–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –º—ã –Ω–µ –æ–±—Å—É–∂–¥–∞–ª–∏ —ç—Ç–æ."
                            else:
                                ai_response = f"I couldn't find any mentions of '{target}' in our history. Perhaps we didn't discuss this."
                    else:
                        if self.current_language == "russian":
                            ai_response = f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {result['message']}"
                        else:
                            ai_response = f"‚ùå An error occurred during deletion: {result['message']}"
                        
                except Exception as e:
                    print(f"[SEND] ‚úó –û—à–∏–±–∫–∞ —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è: {e}")
                    import traceback
                    traceback.print_exc()
                    
                    if self.current_language == "russian":
                        ai_response = f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—ã—Ç—å '{target}': {e}"
                    else:
                        ai_response = f"‚ùå Failed to forget '{target}': {e}"
            
            self.add_message_widget(ASSISTANT_NAME, ai_response, add_controls=False)
            self.chat_manager.save_message(self.current_chat_id, "assistant", ai_response)
            return

        language_switch = detect_language_switch(user_text)
        if language_switch and language_switch != CURRENT_LANGUAGE:
            CURRENT_LANGUAGE = language_switch
            self.current_language = language_switch

            if language_switch == "english":
                notification = "‚úì Language switched to English"
            else:
                notification = "‚úì –Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π"

            self.add_message_widget("–°–∏—Å—Ç–µ–º–∞", notification, add_controls=False)

        self.current_user_message = user_text
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–ú–ù–ê–Ø –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –í–ï–ë-–ü–û–ò–°–ö–ê
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        chat_history = self.chat_manager.get_chat_messages(self.current_chat_id, limit=5)
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        intent_result = analyze_intent_for_search(user_text, forced_search=self.use_search, chat_history=chat_history)
        
        # –ü–†–ò–û–†–ò–¢–ï–¢: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Å—ë
        if intent_result["forced"]:
            print("[SEND] üî¥ FORCED SEARCH MODE - –ø–æ–∏—Å–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É)")
            actual_use_search = True
        elif intent_result["requires_search"]:
            print(f"[SEND] ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {intent_result['confidence']:.2f})")
            print(f"[SEND] –ü—Ä–∏—á–∏–Ω–∞: {intent_result['reason']}")
            actual_use_search = True
            # –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º self.use_search = True - —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!
        else:
            print("[SEND] ‚úó –ü–æ–∏—Å–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
            actual_use_search = False  # –Ø–≤–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º deep_thinking –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ AI
        if self.ai_mode == AI_MODE_FAST:
            actual_deep_thinking = False
        elif self.ai_mode == AI_MODE_THINKING:
            actual_deep_thinking = True
        elif self.ai_mode == AI_MODE_PRO:
            actual_deep_thinking = True  # –í —Ä–µ–∂–∏–º–µ "–ü—Ä–æ" –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
        else:
            actual_deep_thinking = self.deep_thinking  # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        
        print(f"[SEND] –†–µ–∂–∏–º AI: {self.ai_mode}")
        print(f"[SEND] Deep thinking: {actual_deep_thinking}")
        print(f"[SEND] Search enabled: {actual_use_search}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–µ–∂–∏–º—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        self.last_message_deep_thinking = self.deep_thinking
        self.last_message_use_search = actual_use_search
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–ê–†–ê–ú–ï–¢–†–û–í –î–õ–Ø PIPELINE
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ pipeline
        self.current_ai_mode = self.ai_mode
        self.current_use_search = actual_use_search
        self.current_deep_thinking = actual_deep_thinking
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if not self.is_editing:
            # –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            self.input_field.clear()
            
            # –ü–ª–∞–≤–Ω–æ —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if self.messages_layout.count() == 2:  # –¢–æ–ª—å–∫–æ stretch + –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                first_widget = self.messages_layout.itemAt(0).widget()
                if first_widget and hasattr(first_widget, 'speaker') and first_widget.speaker == "–°–∏—Å—Ç–µ–º–∞":
                    # –ó–∞–ø—É—Å–∫–∞–µ–º fade-out –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                    first_widget.fade_out_and_delete()
                    print("[SEND] –°–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–ª–∞–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç—Å—è")
            
            self.add_message_widget("–í—ã", user_text, add_controls=True)
            self.chat_manager.save_message(self.current_chat_id, "user", user_text)
            
            # ‚ïê‚ïê‚ïê –õ–û–ì–ò–ö–ê –°–¢–ê–†–¢–û–í–û–ì–û –ß–ê–¢–ê ‚ïê‚ïê‚ïê
            # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç –∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ø–æ–º–µ—á–∞–µ–º —á—Ç–æ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –ø—É—Å—Ç–æ–π
            if hasattr(self, 'startup_chat_id') and self.current_chat_id == self.startup_chat_id:
                self.startup_chat_has_messages = True
                print(f"[STARTUP_CHAT] –°—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç {self.startup_chat_id} —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è")
            
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            # –ó–ê–ü–£–°–ö –ü–û–≠–¢–ê–ü–ù–û–ì–û STATUS PIPELINE –í –ù–ò–ñ–ù–ï–ú –õ–ï–í–û–ú –£–ì–õ–£
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            # –≠–¢–ê–ü 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
            # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            self.status_label.clear()
            self.status_label.setText("–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶")
            print(f"[STATUS_PIPELINE] –≠—Ç–∞–ø 1: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶")
            
            # –≠–¢–ê–ü 2: –ê–Ω–∞–ª–∏–∑ (—á–µ—Ä–µ–∑ 300ms)
            QtCore.QTimer.singleShot(300, lambda: self._status_pipeline_analyzing())
            
            print("[SEND] –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
        else:
            # –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–Ω–æ —É–∂–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ
            self.input_field.clear()
            self.add_message_widget("–í—ã", user_text, add_controls=True)
            self.chat_manager.save_message(self.current_chat_id, "user", user_text)
            
            # –ó–∞–ø—É—Å–∫ pipeline –ø—Ä–∏ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            self.status_label.clear()
            self.status_label.setText("–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶")
            print(f"[STATUS_PIPELINE] –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –≠—Ç–∞–ø 1: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶")
            QtCore.QTimer.singleShot(300, lambda: self._status_pipeline_analyzing())
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            self.is_editing = False
            self.editing_message_text = ""
            print("[SEND] –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")

        self.input_field.setEnabled(False)
        self.send_btn.setText("‚è∏")
        self.send_btn.setEnabled(True)
        self.is_generating = True

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –î–í–£–•–§–ê–ó–ù–´–ô –†–ï–ñ–ò–ú –û–¢–í–ï–¢–ê
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        # –§–ê–ó–ê 1: –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–∏—Å–∫)
        if not actual_use_search and not self.deep_thinking:
            print("[SEND] üìù –§–ê–ó–ê 1: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–∏—Å–∫–∞")
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–æ—á–µ–∫
        self.start_status_animation()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è
        self.thinking_start_time = time.time()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä —Å –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò —Ñ–ª–∞–≥–∞–º–∏ –∏ —Ä–µ–∂–∏–º–æ–º AI
        worker = AIWorker(user_text, self.current_language, actual_deep_thinking, actual_use_search, False, self.chat_manager, self.current_chat_id, self.attached_file_path, self.ai_mode)
        worker.signals.finished.connect(self.handle_response)
        self.current_worker = worker  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
        
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º worker –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è signals
        self.active_workers.append(worker)
        # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö workers (–º–∞–∫—Å–∏–º—É–º 5)
        if len(self.active_workers) > 5:
            self.active_workers = self.active_workers[-5:]
        
        self.threadpool.start(worker)
        print(f"[SEND] –ó–∞–ø—É—â–µ–Ω –≤–æ—Ä–∫–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (search={actual_use_search}, deep={actual_deep_thinking}, mode={self.ai_mode})")
        
        # –û—á–∏—â–∞–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        if self.attached_file_path:
            print(f"[SEND] –§–∞–π–ª {os.path.basename(self.attached_file_path)} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –º–æ–¥–µ–ª—å")
            self.clear_attached_file()

    def handle_response(self, response: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ AI —Å –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫"""
        try:
            # ‚úÖ GUARD: –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —á–∞—Ç–∞
            # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ "—á—É–∂–∏—Ö" —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–∞—Ç–æ–≤
            if hasattr(self, 'current_worker'):
                # –ï—Å–ª–∏ –≤–æ—Ä–∫–µ—Ä –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω (current_worker = None), –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ–≥–æ –æ—Ç–≤–µ—Ç
                if self.current_worker is None:
                    print(f"[HANDLE_RESPONSE] ‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞")
                    return
            
            # –í–ê–ñ–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            self.is_generating = False
            
            # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è —Å –∑–∞—â–∏—Ç–æ–π
            thinking_time_to_show = 0
            try:
                if hasattr(self, 'thinking_start_time') and self.thinking_start_time:
                    self.thinking_elapsed_time = time.time() - self.thinking_start_time
                    print(f"[THINKING] –í—Ä–µ–º—è –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è: {self.thinking_elapsed_time:.2f}s")
                    # –ü–µ—Ä–µ–¥–∞—ë–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –±—ã–ª —Ä–µ–∂–∏–º "–¥—É–º–∞—é—â–∏–π", "–ø—Ä–æ" –∏–ª–∏ "–ø–æ–∏—Å–∫"
                    show_timer = (self.ai_mode in [AI_MODE_THINKING, AI_MODE_PRO]) or self.use_search
                    thinking_time_to_show = self.thinking_elapsed_time if show_timer else 0
                else:
                    self.thinking_elapsed_time = 0
            except Exception as e:
                print(f"[HANDLE_RESPONSE] –û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏: {e}")
                self.thinking_elapsed_time = 0
            
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            # ‚úÖ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –§–ò–õ–¨–¢–† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü—É—Å—Ç–æ–π –∏–ª–∏ None –æ—Ç–≤–µ—Ç
            if not response or response is None:
                print(f"[ERROR_FILTER] ‚úó –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç (None –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)")
                # –ù–ï —Å–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                return
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ —Å—Ç—Ä–æ–∫–∞
            if not isinstance(response, str):
                print(f"[ERROR_FILTER] ‚úó –û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π: {type(response)}")
                # –ù–ï —Å–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                return
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
            error_indicators = [
                "Traceback",
                "Exception",
                "Error:",
                "NoneType",
                "object is not iterable",
                "KeyError",
                "IndexError", 
                "TypeError",
                "AttributeError",
                "ValueError",
                "RuntimeError"
            ]
            
            error_prefixes = [
                "[–û—à–∏–±–∫–∞]",
                "Python",
                "File \"",
                "line ",
                "Traceback (most recent call last)"
            ]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
            response_lower = response.lower()
            has_error = False
            
            for indicator in error_indicators:
                if indicator in response or indicator.lower() in response_lower:
                    print(f"[ERROR_FILTER] ‚úó –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—à–∏–±–∫–∏: {indicator}")
                    has_error = True
                    break
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏
            if not has_error:
                for prefix in error_prefixes:
                    if response.startswith(prefix):
                        print(f"[ERROR_FILTER] ‚úó –û—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: {prefix}")
                        has_error = True
                        break
            
            # –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
            if has_error:
                print(f"[ERROR_FILTER] ‚úó –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
                print(f"[ERROR_FILTER] –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è): {response[:200]}...")
                
                # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if self.current_language == "russian":
                    response = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."
                else:
                    response = "Failed to process request. Please try again."
            
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
            if not response:
                response = "[–û—à–∏–±–∫–∞] –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏"
                print(f"[HANDLE_RESPONSE] ‚úó –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            elif not isinstance(response, str):
                response = str(response) if response else "[–û—à–∏–±–∫–∞] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç"
                print(f"[HANDLE_RESPONSE] ‚úó –û—Ç–≤–µ—Ç –Ω–µ —Å—Ç—Ä–æ–∫–∞, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π (–¥–ª—è –ª–æ–≥–∏–∫–∏, –±–µ–∑ UI)
            action_history = []
            
            # –†–µ–∂–∏–º AI
            if self.ai_mode == AI_MODE_FAST:
                action_history.append("[‚úì] –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º")
            elif self.ai_mode == AI_MODE_THINKING:
                action_history.append("[‚úì] –¥—É–º–∞—é—â–∏–π —Ä–µ–∂–∏–º")
            elif self.ai_mode == AI_MODE_PRO:
                action_history.append("[‚úì] –ø—Ä–æ —Ä–µ–∂–∏–º")
            
            # –ü–æ–∏—Å–∫
            if hasattr(self, 'last_message_use_search') and self.last_message_use_search:
                action_history.append("[‚úì] –Ω–∞–π–¥–µ–Ω–æ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ")
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—â–∏—Ç–æ–π
            try:
                self.add_message_widget(ASSISTANT_NAME, response, add_controls=True, thinking_time=thinking_time_to_show, action_history=action_history)
            except Exception as e:
                print(f"[HANDLE_RESPONSE] ‚úó –û—à–∏–±–∫–∞ add_message_widget: {e}")
                try:
                    # –ü—Ä–æ–±—É–µ–º –±–µ–∑ thinking_time
                    self.add_message_widget(ASSISTANT_NAME, response, add_controls=True, thinking_time=0, action_history=action_history)
                except Exception as e2:
                    print(f"[HANDLE_RESPONSE] ‚úó –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞: {e2}")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î —Å –∑–∞—â–∏—Ç–æ–π
            try:
                if hasattr(self, 'chat_manager') and hasattr(self, 'current_chat_id'):
                    self.chat_manager.save_message(self.current_chat_id, "assistant", response)
                else:
                    print(f"[HANDLE_RESPONSE] ‚úó –ù–µ—Ç chat_manager –∏–ª–∏ current_chat_id")
            except Exception as e:
                print(f"[HANDLE_RESPONSE] ‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: {e}")
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            self.thinking_start_time = None
            
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            # –û–ß–ò–°–¢–ö–ê –°–¢–ê–¢–£–°–ê –ü–û–°–õ–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø
            # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            # –ü–ª–∞–≤–Ω–æ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            QtCore.QTimer.singleShot(500, lambda: self.status_label.setText(""))
            print(f"[STATUS_PIPELINE] –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω —á–µ—Ä–µ–∑ 500ms")
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞ —Å –∑–∞—â–∏—Ç–æ–π
            try:
                messages = self.chat_manager.get_chat_messages(self.current_chat_id, limit=5)
                if messages and len(messages) == 2:
                    first_user_msg = messages[0][1] if len(messages[0]) > 1 and messages[0][0] == "user" else ""
                    if first_user_msg and isinstance(first_user_msg, str) and len(first_user_msg) > 0:
                        chat_title = first_user_msg[:40]
                        if len(first_user_msg) > 40:
                            chat_title += "..."
                        chat_title = chat_title[0].upper() + chat_title[1:] if len(chat_title) > 0 else "–ù–æ–≤—ã–π —á–∞—Ç"
                        self.chat_manager.update_chat_title(self.current_chat_id, chat_title)
                        self.load_chats_list()
            except Exception as e:
                print(f"[HANDLE_RESPONSE] –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: {e}")
            
        except Exception as e:
            print(f"[HANDLE_RESPONSE] ‚úó –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            import traceback
            traceback.print_exc()
        finally:
            # –í–°–ï–ì–î–ê –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
            try:
                self.send_btn.setEnabled(True)
                self.send_btn.setText("‚Üí")
                self.input_field.setEnabled(True)
                self.input_field.setFocus()
                self.activateWindow()
                self.raise_()
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–æ—á–µ–∫
                if hasattr(self, 'stop_status_animation'):
                    self.stop_status_animation()
            except Exception as e:
                print(f"[HANDLE_RESPONSE] –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è UI: {e}")


    def regenerate_last_response(self):
        """–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        
        –õ–û–ì–ò–ö–ê:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥—ë—Ç –ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –µ—Å–ª–∏ –¥–∞, –æ—Ç–º–µ–Ω—è–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é
        2. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–û–õ–¨–ö–û –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        3. –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–∏–∑ UI –∏ –ë–î)
        4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        # –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥—ë—Ç - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—ë
        if self.is_generating:
            self.is_generating = False
            if hasattr(self, 'current_worker'):
                self.current_worker = None
            print("[REGENERATE] –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–û–õ–¨–ö–û –∏–∑ –¢–ï–ö–£–©–ï–ì–û —á–∞—Ç–∞
        messages = self.chat_manager.get_chat_messages(self.current_chat_id, limit=50)
        
        last_user_msg = None
        for role, content, _ in reversed(messages):
            if role == "user":
                last_user_msg = content
                break
        
        if not last_user_msg:
            print("[REGENERATE] –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ")
            return
        
        print(f"[REGENERATE] –ù–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {last_user_msg[:50]}...")
        
        # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        if self.messages_layout.count() > 1:
            last_item = self.messages_layout.itemAt(self.messages_layout.count() - 2)
            if last_item and last_item.widget():
                widget = last_item.widget()
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                if hasattr(widget, 'speaker') and widget.speaker not in ["–í—ã", "–°–∏—Å—Ç–µ–º–∞"]:
                    widget.deleteLater()
                    print("[REGENERATE] –£–¥–∞–ª—ë–Ω –≤–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞")
        
        # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏–∑ –ë–î —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        conn = sqlite3.connect("chats.db")
        cur = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        cur.execute("""
            SELECT role FROM chat_messages 
            WHERE chat_id = ? 
            ORDER BY id DESC LIMIT 1
        """, (self.current_chat_id,))
        
        last_role = cur.fetchone()
        if last_role and last_role[0] == "assistant":
            cur.execute("""
                DELETE FROM chat_messages 
                WHERE chat_id = ? AND id = (
                    SELECT id FROM chat_messages 
                    WHERE chat_id = ? 
                    ORDER BY id DESC LIMIT 1
                )
            """, (self.current_chat_id, self.current_chat_id))
            conn.commit()
            print("[REGENERATE] –£–¥–∞–ª–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏–∑ –ë–î")
        
        conn.close()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ
        self.input_field.setEnabled(False)
        self.send_btn.setText("‚è∏")
        self.send_btn.setEnabled(True)
        self.is_generating = True
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º deep_thinking –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ AI (–∫–∞–∫ –≤ send_message)
        if self.ai_mode == AI_MODE_FAST:
            actual_deep_thinking = False
        elif self.ai_mode == AI_MODE_THINKING:
            actual_deep_thinking = True
        elif self.ai_mode == AI_MODE_PRO:
            actual_deep_thinking = True
        else:
            actual_deep_thinking = self.deep_thinking
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º —Ä–µ–∂–∏–º–∞
        if self.ai_mode == AI_MODE_PRO:
            self.status_base_text = "‚è≥ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Ä–µ–∂–∏–º –ü—Ä–æ)"
        elif self.ai_mode == AI_MODE_THINKING:
            self.status_base_text = "‚è≥ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Ä–µ–∂–∏–º –î—É–º–∞—é—â–∏–π)"
        elif self.ai_mode == AI_MODE_FAST:
            self.status_base_text = "‚è≥ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º)"
        else:
            self.status_base_text = "‚è≥ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏–µ"
        
        self.status_label.setText(self.status_base_text)
        self.start_status_animation()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è
        self.thinking_start_time = time.time()
        
        self.current_user_message = last_user_msg
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º actual_deep_thinking –≤–º–µ—Å—Ç–æ self.deep_thinking –∏ ai_mode
        worker = AIWorker(last_user_msg, self.current_language, actual_deep_thinking, 
                         self.use_search, False, self.chat_manager, self.current_chat_id, None, self.ai_mode)
        worker.signals.finished.connect(self.handle_response)
        self.current_worker = worker
        
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º worker –≤ —Å–ø–∏—Å–æ–∫
        self.active_workers.append(worker)
        if len(self.active_workers) > 5:
            self.active_workers = self.active_workers[-5:]
        
        self.threadpool.start(worker)
        print(f"[REGENERATE] –ó–∞–ø—É—â–µ–Ω–∞ –Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Ä–µ–∂–∏–º: {self.ai_mode}, deep_thinking: {actual_deep_thinking}, search: {self.use_search})")
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # STATUS PIPELINE - –ü–û–≠–¢–ê–ü–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –í –ù–ò–ñ–ù–ï–ú –õ–ï–í–û–ú –£–ì–õ–£
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _status_pipeline_analyzing(self):
        """–≠–¢–ê–ü 2: –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞"""
        if not self.is_generating:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º pipeline
            return
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        self.status_label.clear()
        self.status_label.setText("–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶")
        print(f"[STATUS_PIPELINE] –≠—Ç–∞–ø 2: –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶")
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        if self.current_deep_thinking or self.current_ai_mode in [AI_MODE_THINKING, AI_MODE_PRO]:
            # –ï—Å–ª–∏ –¥—É–º–∞—é—â–∏–π –∏–ª–∏ –ø—Ä–æ —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–∞–ø "–¥—É–º–∞—é"
            QtCore.QTimer.singleShot(400, lambda: self._status_pipeline_thinking())
        elif self.current_use_search or self.current_ai_mode == AI_MODE_PRO:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ —Ä–µ–∂–∏–º - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–∏—Å–∫—É
            QtCore.QTimer.singleShot(400, lambda: self._status_pipeline_searching())
        else:
            # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –ø–æ–∏—Å–∫–∞ - —Å—Ä–∞–∑—É –∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–∞
            QtCore.QTimer.singleShot(400, lambda: self._status_pipeline_generating())
    
    def _status_pipeline_thinking(self):
        """–≠–¢–ê–ü 3: –û–±–¥—É–º—ã–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥—É–º–∞—é—â–µ–≥–æ/–ø—Ä–æ —Ä–µ–∂–∏–º–∞)"""
        if not self.is_generating:
            return
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        self.status_label.clear()
        self.status_label.setText("–¥—É–º–∞—é‚Ä¶")
        print(f"[STATUS_PIPELINE] –≠—Ç–∞–ø 3: –¥—É–º–∞—é‚Ä¶")
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–∏—Å–∫—É –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if self.current_use_search or self.current_ai_mode == AI_MODE_PRO:
            QtCore.QTimer.singleShot(600, lambda: self._status_pipeline_searching())
        else:
            QtCore.QTimer.singleShot(600, lambda: self._status_pipeline_generating())
    
    def _status_pipeline_searching(self):
        """–≠–¢–ê–ü 4: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ —Ä–µ–∂–∏–º)"""
        if not self.is_generating:
            return
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        self.status_label.clear()
        self.status_label.setText("–∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é‚Ä¶")
        print(f"[STATUS_PIPELINE] –≠—Ç–∞–ø 4: –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é‚Ä¶")
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–∞
        QtCore.QTimer.singleShot(800, lambda: self._status_pipeline_generating())
    
    def _status_pipeline_generating(self):
        """–≠–¢–ê–ü 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞"""
        if not self.is_generating:
            return
        
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        self.status_label.clear()
        self.status_label.setText("—Ñ–æ—Ä–º–∏—Ä—É—é –æ—Ç–≤–µ—Ç‚Ä¶")
        print(f"[STATUS_PIPELINE] –≠—Ç–∞–ø 5: —Ñ–æ—Ä–º–∏—Ä—É—é –æ—Ç–≤–µ—Ç‚Ä¶")
        
        # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω –≤ handle_response
    
    def edit_last_message(self, old_text=None):
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        –õ–û–ì–ò–ö–ê:
        1. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π user-–∑–∞–ø—Ä–æ—Å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        2. –í–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        3. –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è (user + assistant) + ActionIndicatorRow –∏–∑ UI –∏ –ë–î
        4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        5. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–º–µ–Ω–∏—Ç—Å—è, –∞ –Ω–µ –¥–æ–±–∞–≤–∏—Ç—Å—è
        """
        if self.is_generating:
            print("[EDIT] ‚úó –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¢–ï–ö–£–©–ï–ì–û —á–∞—Ç–∞
        messages = self.chat_manager.get_chat_messages(self.current_chat_id, limit=50)
        
        last_user_msg = None
        for role, content, _ in reversed(messages):
            if role == "user":
                last_user_msg = content
                break
        
        if not last_user_msg:
            print("[EDIT] ‚úó –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        
        print(f"[EDIT] –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: {last_user_msg[:50]}...")
        
        # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≤–∏–¥–∂–µ—Ç–∞ (user + assistant)
        removed_count = 0
        while self.messages_layout.count() > 1 and removed_count < 2:
            last_item = self.messages_layout.itemAt(self.messages_layout.count() - 2)
            if last_item and last_item.widget():
                last_item.widget().deleteLater()
                removed_count += 1
        
        print(f"[EDIT] ‚úì –£–¥–∞–ª–µ–Ω–æ –≤–∏–¥–∂–µ—Ç–æ–≤: {removed_count}")
        
        # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ë–î —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        conn = sqlite3.connect("chats.db")
        cur = conn.cursor()
        cur.execute("""
            DELETE FROM chat_messages 
            WHERE chat_id = ? AND id IN (
                SELECT id FROM chat_messages 
                WHERE chat_id = ? 
                ORDER BY id DESC LIMIT 2
            )
        """, (self.current_chat_id, self.current_chat_id))
        conn.commit()
        conn.close()
        print("[EDIT] ‚úì –£–¥–∞–ª–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ë–î")
        
        # –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        self.is_editing = True
        self.editing_message_text = last_user_msg
        
        # –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –†–ï–ñ–ò–ú–´ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if hasattr(self, 'last_message_deep_thinking') and hasattr(self, 'last_message_use_search'):
            self.deep_thinking = self.last_message_deep_thinking
            self.use_search = self.last_message_use_search
            self.think_toggle.setChecked(self.deep_thinking)
            self.search_toggle.setChecked(self.use_search)
            print(f"[EDIT] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–∂–∏–º—ã: –¥—É–º–∞—Ç—å={self.deep_thinking}, –ø–æ–∏—Å–∫={self.use_search}")
        else:
            print(f"[EDIT] –¢–µ–∫—É—â–∏–µ —Ä–µ–∂–∏–º—ã: –¥—É–º–∞—Ç—å={self.deep_thinking}, –ø–æ–∏—Å–∫={self.use_search}")
        
        # –í–û–ó–í–†–ê–©–ê–ï–ú –¢–ï–ö–°–¢ –í –ü–û–õ–ï –í–í–û–î–ê –ò –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ö–£–†–°–û–† –í –ö–û–ù–ï–¶
        self.input_field.setText(last_user_msg)
        self.input_field.setEnabled(True)
        self.input_field.setFocus()
        self.input_field.setCursorPosition(len(last_user_msg))
        print(f"[EDIT] ‚úì –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")

    def clear_chat(self):
        """–û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –æ–∫–Ω–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
        print("[CLEAR_CHAT] –ú–µ—Ç–æ–¥ –≤—ã–∑–≤–∞–Ω!")
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É –µ—Å–ª–∏ –∏–¥—ë—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        if self.is_generating:
            print("[CLEAR_CHAT] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ - –æ—á–∏—Å—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ (–∫—Ä–æ–º–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö)
        messages_count = 0
        for i in range(self.messages_layout.count() - 1):
            item = self.messages_layout.itemAt(i)
            if item and item.widget():
                widget = item.widget()
                if hasattr(widget, 'speaker') and widget.speaker != "–°–∏—Å—Ç–µ–º–∞":
                    messages_count += 1
        
        print(f"[CLEAR_CHAT] –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {messages_count}")
        
        if messages_count == 0:
            print("[CLEAR_CHAT] –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π - –≤—ã—Ö–æ–¥")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        is_dark = self.current_theme == "dark"
        
        # –°–æ–∑–¥–∞—ë–º –ú–û–î–ê–õ–¨–ù–û–ï –æ–∫–Ω–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Mac)
        dialog = QtWidgets.QDialog(self)
        dialog.setWindowTitle("")
        dialog.setModal(True)
        dialog.setFixedSize(420, 220)
        
        # –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É –æ–∫–Ω–∞
        dialog.setWindowFlags(QtCore.Qt.WindowType.FramelessWindowHint | QtCore.Qt.WindowType.Dialog)
        # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ –Ω–∞ Windows
        if not IS_WINDOWS:
            dialog.setAttribute(QtCore.Qt.WidgetAttribute.WA_TranslucentBackground)
        
        # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≠–ö–†–ê–ù–£ (–Ω–µ –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—é)
        screen_geo = QtWidgets.QApplication.primaryScreen().geometry()
        dialog.move(
            screen_geo.center().x() - 210,
            screen_geo.center().y() - 110
        )
        
        # Layout
        layout = QtWidgets.QVBoxLayout(dialog)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ —Ç–µ–º—É
        frame = QtWidgets.QFrame()
        
        # –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á—Ç–æ —Ñ–æ–Ω –ù–ï –¥–æ–ª–∂–µ–Ω —Ä–∏—Å–æ–≤–∞—Ç—å—Å—è –ø–æ–≤–µ—Ä—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        frame.setAttribute(QtCore.Qt.WidgetAttribute.WA_StyledBackground, True)
        
        if is_dark:
            # –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ - —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Ñ–æ–Ω –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ—ë–≤
            frame.setStyleSheet("""
                QFrame {
                    background-color: rgba(30, 30, 35, 0.92);
                    border: 1px solid rgba(60, 60, 70, 0.8);
                    border-radius: 20px;
                }
            """)
        else:
            # –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ - —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Ñ–æ–Ω –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ—ë–≤
            frame.setStyleSheet("""
                QFrame {
                    background-color: rgba(255, 255, 255, 0.90);
                    border: 1px solid rgba(255, 255, 255, 0.95);
                    border-radius: 20px;
                }
            """)
        
        frame_layout = QtWidgets.QVBoxLayout(frame)
        frame_layout.setContentsMargins(35, 35, 35, 35)
        frame_layout.setSpacing(28)
        
        # –¢–µ–∫—Å—Ç - –ö–†–ò–¢–ò–ß–ù–û: —É–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —Å—Ç–∏–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å —Å–ª–æ–π
        label = QtWidgets.QLabel("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ\n–æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?")
        label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
        label.setFont(QtGui.QFont("Inter", 16, QtGui.QFont.Weight.Medium))
        
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
        # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º padding, background –∏ –¥—Ä—É–≥–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç —Å–ª–æ–∏
        if is_dark:
            label.setStyleSheet("QLabel { color: #e6e6e6; background-color: none; border: none; }")
        else:
            label.setStyleSheet("QLabel { color: #2d3748; background-color: none; border: none; }")
        
        label.setWordWrap(True)
        
        # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–¥–Ω–∏–º–∞–µ–º label –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö —Å–ª–æ—ë–≤
        label.raise_()
        
        frame_layout.addWidget(label)
        
        # –ö–Ω–æ–ø–∫–∏
        buttons = QtWidgets.QHBoxLayout()
        buttons.setSpacing(15)
        
        no_btn = QtWidgets.QPushButton("–ù–ï–¢")
        no_btn.setFont(QtGui.QFont("Inter", 14, QtGui.QFont.Weight.Bold))
        no_btn.setFixedHeight(54)
        no_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        
        if is_dark:
            no_btn.setStyleSheet("""
                QPushButton {
                    background: rgba(60, 60, 70, 0.7);
                    color: #c0c0c0;
                    border: 1px solid rgba(80, 80, 90, 0.8);
                    border-radius: 13px;
                    padding: 8px 18px;
                    text-align: center;
                }
                QPushButton:hover {
                    background: rgba(70, 70, 80, 0.85);
                    border: 1px solid rgba(90, 90, 100, 0.9);
                }
            """)
        else:
            no_btn.setStyleSheet("""
                QPushButton {
                    background: rgba(200, 200, 200, 0.6);
                    color: #4a5568;
                    border: 1px solid rgba(200, 200, 200, 0.75);
                    border-radius: 13px;
                    padding: 8px 18px;
                    text-align: center;
                }
                QPushButton:hover {
                    background: rgba(200, 200, 200, 0.8);
                }
            """)
        
        yes_btn = QtWidgets.QPushButton("–î–ê")
        yes_btn.setFont(QtGui.QFont("Inter", 14, QtGui.QFont.Weight.Bold))
        yes_btn.setFixedHeight(54)
        yes_btn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        
        if is_dark:
            yes_btn.setStyleSheet("""
                QPushButton {
                    background: rgba(220, 38, 38, 0.95);
                    color: #ffffff;
                    border: 1px solid rgba(220, 38, 38, 1.0);
                    border-radius: 13px;
                    padding: 8px 18px;
                    text-align: center;
                }
                QPushButton:hover {
                    background: rgba(185, 28, 28, 1.0);
                    border: 1px solid rgba(185, 28, 28, 1.0);
                }
            """)
        else:
            yes_btn.setStyleSheet("""
                QPushButton {
                    background: rgba(239, 68, 68, 0.95);
                    color: white;
                    border: none;
                    border-radius: 13px;
                    padding: 8px 18px;
                    text-align: center;
                }
                QPushButton:hover {
                    background: rgba(220, 38, 38, 1.0);
                }
            """)
        
        buttons.addWidget(no_btn)
        buttons.addWidget(yes_btn)
        
        # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö —Å–ª–æ—ë–≤
        no_btn.raise_()
        yes_btn.raise_()
        
        frame_layout.addLayout(buttons)
        
        layout.addWidget(frame)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        no_btn.clicked.connect(dialog.reject)
        yes_btn.clicked.connect(dialog.accept)
        
        print("[CLEAR_CHAT] –ü–æ–∫–∞–∑—ã–≤–∞—é –¥–∏–∞–ª–æ–≥...")
        result = dialog.exec()
        
        if result == QtWidgets.QDialog.DialogCode.Accepted:
            print("[CLEAR_CHAT] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—á–∏—Å—Ç–∫—É")
            self.perform_clear_chat()
        else:
            print("[CLEAR_CHAT] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ—á–∏—Å—Ç–∫—É")
    
    def perform_clear_chat(self):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —á–∞—Ç–∞ —Å –ø–ª–∞–≤–Ω–æ–π iOS-style –∞–Ω–∏–º–∞—Ü–∏–µ–π"""
        print("[PERFORM_CLEAR] –ù–∞—á–∏–Ω–∞–µ–º –ø–ª–∞–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É...")
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        widgets = []
        for i in range(self.messages_layout.count()):
            item = self.messages_layout.itemAt(i)
            if item and item.widget():
                widget = item.widget()
                # –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
                if hasattr(widget, 'speaker'):
                    widgets.append(widget)
        
        print(f"[PERFORM_CLEAR] –í–∏–¥–∂–µ—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: {len(widgets)}")
        
        if len(widgets) == 0:
            print("[PERFORM_CLEAR] –ù–µ—Ç –≤–∏–¥–∂–µ—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            self.finalize_clear()
            return
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º UI –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.input_field.setEnabled(False)
        self.send_btn.setEnabled(False)
        
        # –ü–õ–ê–í–ù–ê–Ø iOS-style –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –í–°–ï–• –ø–ª–∞—Ç—Ñ–æ—Ä–º
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        total_duration = 0
        for idx, widget in enumerate(reversed(widgets)):  # –°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
            delay = idx * 40  # –ú–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞ = –±—ã—Å—Ç—Ä–µ–µ
            total_duration = delay + 300  # 300ms –Ω–∞ —Å–∞–º—É –∞–Ω–∏–º–∞—Ü–∏—é
            QtCore.QTimer.singleShot(delay, lambda w=widget: self.smooth_fade_and_remove(w))
        
        # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π - —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
        QtCore.QTimer.singleShot(total_duration + 100, self.finalize_clear)
    
    def smooth_fade_and_remove(self, widget):
        """
        –ü–ª–∞–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ —á–µ—Ä–µ–∑ fade-out –∞–Ω–∏–º–∞—Ü–∏—é.
        
        –í–ê–ñ–ù–û: –¢–æ–ª—å–∫–æ fade-out –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏, –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤.
        –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ layout –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è.
        """
        try:
            if not widget or not widget.isVisible():
                return
            
            # –°–æ–∑–¥–∞—ë–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if not widget.graphicsEffect():
                opacity_effect = QtWidgets.QGraphicsOpacityEffect(widget)
                widget.setGraphicsEffect(opacity_effect)
            else:
                opacity_effect = widget.graphicsEffect()
            
            # Fade-out –∞–Ω–∏–º–∞—Ü–∏—è
            fade_anim = QtCore.QPropertyAnimation(opacity_effect, b"opacity")
            fade_anim.setDuration(300)
            fade_anim.setStartValue(1.0)
            fade_anim.setEndValue(0.0)
            fade_anim.setEasingCurve(QtCore.QEasingCurve.Type.OutCubic)
            
            # –£–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            def cleanup():
                try:
                    # –ö–†–ò–¢–ò–ß–ù–û: –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                    if hasattr(widget, '_cleanup_anim'):
                        widget._cleanup_anim.stop()
                        widget._cleanup_anim = None
                    
                    # –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç
                    if widget.graphicsEffect():
                        widget.setGraphicsEffect(None)
                    
                    # –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç
                    if hasattr(widget, '_opacity_effect'):
                        widget._opacity_effect = None
                    
                    # –ò —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —É–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç
                    self.messages_layout.removeWidget(widget)
                    widget.deleteLater()
                    # Layout –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                except RuntimeError:
                    # –û–±—ä–µ–∫—Ç —É–∂–µ —É–¥–∞–ª—ë–Ω - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    pass
                except Exception as e:
                    print(f"[CLEANUP] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∏–¥–∂–µ—Ç–∞: {e}")
            
            fade_anim.finished.connect(cleanup)
            fade_anim.start()
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—é –ò –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
            widget._cleanup_anim = fade_anim
            widget._opacity_effect = opacity_effect
            
        except Exception as e:
            print(f"[SMOOTH_FADE] –û—à–∏–±–∫–∞: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ - –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç
            try:
                if widget.graphicsEffect():
                    widget.setGraphicsEffect(None)
                self.messages_layout.removeWidget(widget)
                widget.deleteLater()
                # Layout –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            except:
                pass
    
    
    def finalize_clear(self):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏"""
        try:
            print("[FINALIZE] –û—á–∏—â–∞–µ–º –ë–î –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI...")
            
            # ‚úÖ –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤–∏–¥–∂–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å)
            # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ stretch –≤ –∫–æ–Ω—Ü–µ
            items_to_remove = []
            for i in range(self.messages_layout.count()):
                item = self.messages_layout.itemAt(i)
                if item and item.widget():
                    widget = item.widget()
                    # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∂–µ—Ç—ã —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º speaker (—Å–æ–æ–±—â–µ–Ω–∏—è)
                    if hasattr(widget, 'speaker'):
                        items_to_remove.append(widget)
            
            for widget in items_to_remove:
                self.messages_layout.removeWidget(widget)
                widget.deleteLater()
            
            print(f"[FINALIZE] –£–¥–∞–ª–µ–Ω–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≤–∏–¥–∂–µ—Ç–æ–≤: {len(items_to_remove)}")
            
            # –û—á–∏—â–∞–µ–º –ë–î
            self.chat_manager.clear_chat_messages(self.current_chat_id)
            self.chat_manager.update_chat_title(self.current_chat_id, "–ù–æ–≤—ã–π —á–∞—Ç")
            self.load_chats_list()
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            self.add_message_widget("–°–∏—Å—Ç–µ–º–∞", "–ß–∞—Ç –æ—á–∏—â–µ–Ω", add_controls=False)
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
            self.input_field.setEnabled(True)
            self.send_btn.setEnabled(True)
            self.input_field.setFocus()
            
            print("[FINALIZE] –ì–æ—Ç–æ–≤–æ!")
        except Exception as e:
            print(f"[FINALIZE] –û—à–∏–±–∫–∞: {e}")
            import traceback
            traceback.print_exc()
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ - –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
            self.input_field.setEnabled(True)
            self.send_btn.setEnabled(True)

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        print("[MAIN] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        init_db()
        
        print("[MAIN] –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Qt...")
        app = QtWidgets.QApplication(sys.argv)
        
        # –î–ª—è Windows - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–≤–Ω–æ —Å—Ç–∏–ª—å
        if IS_WINDOWS:
            print("[MAIN] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –¥–ª—è Windows...")
            app.setStyle('Fusion')
        
        print("[MAIN] –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
        app_icon = create_app_icon()
        app.setWindowIcon(QtGui.QIcon(app_icon))
        
        print("[MAIN] –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞...")
        window = MainWindow()
        
        print("[MAIN] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–∫–Ω–∞...")
        window.show()
        
        print("[MAIN] –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞...")
        sys.exit(app.exec())
        
    except Exception as e:
        print(f"[MAIN] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        import traceback
        traceback.print_exc()
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        try:
            error_app = QtWidgets.QApplication(sys.argv)
            QtWidgets.QMessageBox.critical(
                None,
                "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:\n\n{str(e)}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\n2. –î–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\n3. –ó–∞–ø—É—â–µ–Ω–∞ –ª–∏ Ollama",
                QtWidgets.QMessageBox.StandardButton.Ok
            )
        except:
            pass
        
        sys.exit(1)

if __name__ == "__main__":
    main()